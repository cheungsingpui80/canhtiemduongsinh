<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Đơn Hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f4ef; /* Warmer cream fallback */
            /* New pattern with lanterns and palace roofs */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cg fill='%23EADDCD' fill-opacity='0.6'%3E%3C!-- Lantern --%3E%3Crect x='20' y='20' width='30' height='40' rx='15'/%3E%3Crect x='15' y='18' width='40' height='5' rx='2.5'/%3E%3Crect x='15' y='58' width='40' height='5' rx='2.5'/%3E%3C!-- Palace Roof Tile --%3E%3Cpath d='M90 100 Q 105 110, 120 100' stroke='%23EADDCD' stroke-width='2' fill='none'/%3E%3Cpath d='M100 110 Q 115 120, 130 110' stroke='%23EADDCD' stroke-width='2' fill='none'/%3E%3Cpath d='M110 120 Q 125 130, 140 120' stroke='%23EADDCD' stroke-width='2' fill='none'/%3E%3C/g%3E%3C/svg%3E");
        }
        .kanban-column { min-height: 70vh; }
        .order-card, .role-card { transition: all 0.2s ease-in-out; }
        .order-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal { transition: opacity 0.3s ease; }
        .login-bg {
            background-color: #f0f4ff;
            background-image:
            radial-gradient(at 47% 33%, hsl(207.00, 75%, 88%) 0px, transparent 50%),
            radial-gradient(at 82% 65%, hsl(218.00, 85%, 85%) 0px, transparent 50%);
        }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center h-screen login-bg p-4">
        <div class="w-full max-w-md text-center p-6 md:p-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl">
             <div class="flex items-center justify-center gap-3 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                </svg>
                <h1 class="text-3xl font-bold text-gray-800" data-lang="login_title">Đăng Nhập</h1>
            </div>
            <p class="text-gray-500 mb-8" data-lang="login_subtitle">Chọn thông tin của bạn để bắt đầu làm việc.</p>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="employee-select" class="block text-sm font-medium text-gray-700 text-left" data-lang="employee_name">Tên nhân viên</label>
                    <select id="employee-select" required class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500"></select>
                </div>
                <div>
                     <label for="role-select" class="block text-sm font-medium text-gray-700 text-left" data-lang="role">Vai trò</label>
                    <select id="role-select" required class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500"></select>
                </div>
                 <button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg hover:bg-indigo-700 font-semibold text-base" data-lang="start_working_btn">Bắt đầu làm việc</button>
            </form>
             <div class="mt-8 flex justify-center items-center gap-4">
                <button class="lang-btn text-sm py-2 px-4 rounded-full" data-lang-code="vi">Tiếng Việt</button>
                <button class="lang-btn text-sm py-2 px-4 rounded-full" data-lang-code="zh">繁體中文</button>
            </div>
        </div>
    </div>


    <!-- Main Order Management View -->
    <div id="main-view" class="hidden">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800" data-lang="order_management">Quản Lý Đơn Hàng</h1>
                    <div id="user-info" class="text-sm text-gray-600"></div>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                    <span data-lang="logout">Đăng Xuất</span>
                </button>
            </div>
        </header>
        
        <main class="container mx-auto px-4 py-6 sm:px-6 sm:py-8">
            <!-- New Order Form (for Order Takers only) -->
            <div id="new-order-form-container" class="hidden bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4" data-lang="receive_new_order">Nhận Đơn Hàng Mới</h2>
                <form id="add-order-form" class="grid grid-cols-1 gap-y-6">
                    <!-- Customer Info -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-900" data-lang="customer_details">Thông Tin Đơn Hàng</h3>
                         <div>
                            <label for="order-channel-select" class="block text-sm font-medium text-gray-700" data-lang="sales_channel">Kênh bán</label>
                            <select id="order-channel-select" required class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>
                        <div>
                            <label for="order-id" class="block text-sm font-medium text-gray-700" data-lang="order_id">Mã Đơn Hàng</label>
                            <input type="text" id="order-id" required class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 bg-gray-100" readonly>
                        </div>
                        <div>
                            <label for="order-customer-name" class="block text-sm font-medium text-gray-700" data-lang="customer_name">Tên Khách Hàng</label>
                            <input type="text" id="order-customer-name" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="order-customer-address" class="block text-sm font-medium text-gray-700" data-lang="delivery_address">Địa chỉ giao hàng</label>
                            <input type="text" id="order-customer-address" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="order-customer-phone" class="block text-sm font-medium text-gray-700" data-lang="phone_number">Số Điện Thoại</label>
                            <input type="tel" id="order-customer-phone" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-900" data-lang="order_items">Các Món Ăn</h3>
                        <div class="p-4 bg-gray-50 rounded-xl">
                           <div class="flex gap-2 items-end">
                                <div class="flex-grow">
                                    <label for="add-dish-select" class="block text-sm font-medium text-gray-700" data-lang="dish">Món ăn</label>
                                    <select id="add-dish-select" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500"></select>
                                </div>
                                <div class="w-20 flex-shrink-0">
                                    <label for="add-dish-quantity" class="block text-sm font-medium text-gray-700" data-lang="quantity_short">SL</label>
                                    <input type="number" id="add-dish-quantity" min="1" value="1" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                                </div>
                                <button type="button" id="add-dish-to-order-btn" class="bg-blue-600 text-white rounded-lg h-[46px] w-12 flex-shrink-0 flex items-center justify-center hover:bg-blue-700 text-2xl font-bold">+</button>
                            </div>
                        </div>
                        <div id="current-order-items" class="space-y-2 min-h-[100px]">
                            <!-- Items will be injected here -->
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg hover:bg-indigo-700 font-semibold text-base" data-lang="add_order_btn">Thêm Đơn Hàng</button>
                    </div>
                </form>
            </div>

            <!-- Kanban Board -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="col-new-container" class="bg-blue-100/70 backdrop-blur-sm rounded-2xl p-4 hidden">
                    <h3 class="font-semibold text-lg mb-4 text-center text-blue-800" data-lang="new_orders">Đơn Hàng Mới</h3>
                    <div id="new-orders-col" class="kanban-column space-y-4 overflow-y-auto"></div>
                </div>
                <div id="col-preparing-container" class="bg-amber-100/70 backdrop-blur-sm rounded-2xl p-4 hidden">
                    <h3 class="font-semibold text-lg mb-4 text-center text-amber-800" data-lang="preparing">Đang Chuẩn Bị</h3>
                    <div id="preparing-orders-col" class="kanban-column space-y-4 overflow-y-auto"></div>
                </div>
                <div id="col-delivering-container" class="bg-purple-100/70 backdrop-blur-sm rounded-2xl p-4 hidden">
                    <h3 class="font-semibold text-lg mb-4 text-center text-purple-800" data-lang="delivering">Đang Giao Hàng</h3>
                    <div id="delivering-orders-col" class="kanban-column space-y-4 overflow-y-auto"></div>
                </div>
            </div>

             <!-- Completed Orders List -->
            <div id="completed-orders-container" class="hidden bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-md mt-8">
                <h2 class="text-xl font-semibold mb-4" data-lang="completed_orders">Đơn Hàng Đã Hoàn Tất</h2>
                <div id="completed-orders-list" class="space-y-3 max-h-[60vh] sm:max-h-96 overflow-y-auto"></div>
            </div>
        </main>
    </div>

    <!-- Edit Order Modal -->
    <div id="edit-order-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                 <h2 class="text-xl font-semibold" data-lang="edit_order">Chỉnh Sửa Đơn Hàng</h2>
            </div>
            <form id="edit-order-form" class="p-6 space-y-6 overflow-y-auto">
                <!-- Customer Info -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900" data-lang="customer_details">Thông Tin Đơn Hàng</h3>
                     <div>
                        <label for="edit-order-channel-select" class="block text-sm font-medium text-gray-700" data-lang="sales_channel">Kênh bán</label>
                        <select id="edit-order-channel-select" required class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500" disabled></select>
                    </div>
                    <div>
                        <label for="edit-order-id" class="block text-sm font-medium text-gray-700" data-lang="order_id">Mã Đơn Hàng</label>
                        <input type="text" id="edit-order-id" required class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="edit-order-customer-name" class="block text-sm font-medium text-gray-700" data-lang="customer_name">Tên Khách Hàng</label>
                        <input type="text" id="edit-order-customer-name" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="edit-order-customer-address" class="block text-sm font-medium text-gray-700" data-lang="delivery_address">Địa chỉ giao hàng</label>
                        <input type="text" id="edit-order-customer-address" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="edit-order-customer-phone" class="block text-sm font-medium text-gray-700" data-lang="phone_number">Số Điện Thoại</label>
                        <input type="tel" id="edit-order-customer-phone" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <!-- Order Items -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900" data-lang="order_items">Các Món Ăn</h3>
                    <div class="p-4 bg-gray-50 rounded-xl">
                       <div class="flex gap-2 items-end">
                            <div class="flex-grow">
                                <label for="edit-dish-select" class="block text-sm font-medium text-gray-700" data-lang="dish">Món ăn</label>
                                <select id="edit-dish-select" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500"></select>
                            </div>
                            <div class="w-20 flex-shrink-0">
                                <label for="edit-dish-quantity" class="block text-sm font-medium text-gray-700" data-lang="quantity_short">SL</label>
                                <input type="number" id="edit-dish-quantity" min="1" value="1" class="mt-1 block w-full border-gray-300 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-indigo-500">
                            </div>
                            <button type="button" id="add-dish-to-edit-order-btn" class="bg-blue-600 text-white rounded-lg h-[46px] w-12 flex-shrink-0 flex items-center justify-center hover:bg-blue-700 text-2xl font-bold">+</button>
                        </div>
                    </div>
                    <div id="editing-order-items" class="space-y-2 min-h-[100px]">
                        <!-- Editing items will be injected here -->
                    </div>
                </div>
            </form>
            <div class="p-6 border-t mt-auto flex gap-4">
                 <button type="submit" form="edit-order-form" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg hover:bg-indigo-700 font-semibold" data-lang="save_changes">Lưu Thay Đổi</button>
                 <button type="button" id="close-edit-modal-btn" class="w-full bg-gray-200 text-gray-700 py-2.5 rounded-lg hover:bg-gray-300 font-semibold" data-lang="cancel_edit">Hủy</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const translations = {
            vi: {
                login_title: 'Đăng Nhập',
                login_subtitle: 'Chọn thông tin của bạn để bắt đầu làm việc.',
                employee_name: 'Tên nhân viên',
                role: 'Vai trò',
                start_working_btn: 'Bắt đầu làm việc',
                select_employee: '--- Chọn nhân viên ---',
                select_role: '--- Chọn vai trò ---',
                role_taker: 'Nhận Đơn',
                role_kitchen: 'Bếp',
                role_shipper: 'Giao Hàng',
                order_management: 'Quản Lý Đơn Hàng',
                logout: 'Đăng Xuất',
                receive_new_order: 'Nhận Đơn Hàng Mới',
                dish: 'Món ăn',
                quantity: 'Số lượng',
                sales_channel: 'Kênh bán',
                add_order_btn: 'Thêm Đơn Hàng',
                new_orders: 'Đơn Hàng Mới',
                preparing: 'Đang Chuẩn Bị',
                delivering: 'Đang Giao Hàng',
                confirm_prepare: 'Nhận đơn hàng',
                confirm_deliver: 'Chế biến xong',
                complete_order: 'Đã giao hàng',
                order_from: 'Từ',
                cancel_order: 'Hủy đơn',
                empty_data: 'Chưa có dữ liệu.',
                select_dish: 'Chọn món ăn',
                select_channel: 'Chọn kênh bán',
                order_id: 'Mã Đơn Hàng',
                customer_name: 'Tên Khách Hàng',
                phone_number: 'Số Điện Thoại',
                delivery_address: 'Địa chỉ giao hàng',
                completed_orders: 'Đơn Hàng Đã Hoàn Tất',
                total_time: 'Tổng thời gian',
                completed_at: 'Hoàn thành lúc',
                time_in_stage: 'TG trong khâu',
                order_items: 'Các Món Ăn',
                customer_details: 'Thông Tin Đơn Hàng',
                quantity_short: 'SL',
                no_items_added: 'Chưa có món nào được thêm.',
                edit_order: 'Chỉnh Sửa Đơn Hàng',
                save_changes: 'Lưu Thay Đổi',
                cancel_edit: 'Hủy'
            },
            zh: {
                login_title: '登入',
                login_subtitle: '選擇您的資訊以開始工作。',
                employee_name: '員工姓名',
                role: '角色',
                start_working_btn: '開始工作',
                select_employee: '--- 選擇員工 ---',
                select_role: '--- 選擇角色 ---',
                role_taker: '接單員',
                role_kitchen: '廚房',
                role_shipper: '配送員',
                order_management: '訂單管理',
                logout: '登出',
                receive_new_order: '接收新訂單',
                dish: '菜式',
                quantity: '數量',
                sales_channel: '銷售渠道',
                add_order_btn: '新增訂單',
                new_orders: '新訂單',
                preparing: '準備中',
                delivering: '配送中',
                confirm_prepare: '接收訂單',
                confirm_deliver: '製作完成',
                complete_order: '已送達',
                order_from: '來自',
                cancel_order: '取消訂單',
                empty_data: '暫無數據。',
                select_dish: '選擇菜式',
                select_channel: '選擇銷售渠道',
                order_id: '訂單號碼',
                customer_name: '客戶姓名',
                phone_number: '電話號碼',
                delivery_address: '配送地址',
                completed_orders: '已完成訂單',
                total_time: '總時間',
                completed_at: '完成於',
                time_in_stage: '階段時間',
                order_items: '訂單項目',
                customer_details: '訂單詳情',
                quantity_short: '數量',
                no_items_added: '尚未加入任何菜式。',
                edit_order: '編輯訂單',
                save_changes: '儲存變更',
                cancel_edit: '取消'
            }
        };

        let currentLang = localStorage.getItem('language') || 'vi';

        const setLanguage = (lang) => {
            currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : 'vi';

            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.langCode === lang);
                btn.classList.toggle('bg-indigo-600', btn.dataset.langCode === lang);
                btn.classList.toggle('text-white', btn.dataset.langCode === lang);
            });
            
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                 initializeMainView(currentUser);
            } else {
                 populateEmployeeSelect();
            }
        };

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                setLanguage(btn.dataset.langCode);
            });
        });

        const rolesConfig = {
            taker: {
                name: 'Nhận Đơn',
                name_zh: '接單員',
                canSee: ['new', 'preparing', 'delivering', 'completed'],
                canCreate: true
            },
            kitchen: {
                name: 'Bếp',
                name_zh: '廚房',
                canSee: ['new', 'preparing', 'completed'],
                canCreate: false
            },
            shipper: {
                name: 'Giao Hàng',
                name_zh: '配送員',
                canSee: ['preparing', 'delivering', 'completed'],
                canCreate: false
            }
        };

        // --- Helper Functions ---
        const findById = (arr, id) => arr.find(item => item.id === parseInt(id));
        const formatTime = (ms) => {
            if (!ms || ms < 0) return '00:00';
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        };

        // --- Data Initialization from localStorage ---
        let dishes = JSON.parse(localStorage.getItem('dishes')) || [];
        let salesRecords = JSON.parse(localStorage.getItem('salesRecords')) || [];
        let activeOrders = JSON.parse(localStorage.getItem('activeOrders')) || [];
        let completedOrders = JSON.parse(localStorage.getItem('completedOrders')) || [];
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let currentOrderItems = [];
        let editingOrderItems = [];
        
        const salesChannels = {
            'AtStore': { name: 'Tại quán', commission: 0, name_zh: '店內', externalId: false },
            'GrabFood': { name: 'GrabFood', commission: 0.25, name_zh: 'GrabFood', externalId: true },
            'ShopeeFood': { name: 'ShopeeFood', commission: 0.25, name_zh: 'ShopeeFood', externalId: true },
            'Zalo': { name: 'Zalo', commission: 0, name_zh: 'Zalo', externalId: false },
            'Hotline': { name: 'Hotline', commission: 0, name_zh: '熱線電話', externalId: false }
        };

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');
        const loginForm = document.getElementById('login-form');
        const employeeSelect = document.getElementById('employee-select');
        const roleSelect = document.getElementById('role-select');
        const addOrderForm = document.getElementById('add-order-form');
        const newOrdersCol = document.getElementById('new-orders-col');
        const preparingOrdersCol = document.getElementById('preparing-orders-col');
        const deliveringOrdersCol = document.getElementById('delivering-orders-col');
        const completedOrdersList = document.getElementById('completed-orders-list');
        const userInfoDiv = document.getElementById('user-info');
        const orderChannelSelect = document.getElementById('order-channel-select');
        const orderIdInput = document.getElementById('order-id');
        const addDishToOrderBtn = document.getElementById('add-dish-to-order-btn');
        const currentOrderItemsContainer = document.getElementById('current-order-items');
        const editOrderModal = document.getElementById('edit-order-modal');
        const editOrderForm = document.getElementById('edit-order-form');


        function initializeMainView(user) {
            loginView.classList.add('hidden');
            mainView.classList.remove('hidden');

            const roleInfo = rolesConfig[user.role];
            const roleName = roleInfo[`name${currentLang === 'zh' ? '_zh' : ''}`];
            userInfoDiv.innerHTML = `<p class="font-semibold">${user.name} (${user.idCode})</p><p class="text-indigo-600">${roleName}</p>`;

            document.getElementById('new-order-form-container').classList.toggle('hidden', !roleInfo.canCreate);
            document.getElementById('col-new-container').classList.toggle('hidden', !roleInfo.canSee.includes('new'));
            document.getElementById('col-preparing-container').classList.toggle('hidden', !roleInfo.canSee.includes('preparing'));
            document.getElementById('col-delivering-container').classList.toggle('hidden', !roleInfo.canSee.includes('delivering'));
            document.getElementById('completed-orders-container').classList.toggle('hidden', !roleInfo.canSee.includes('completed'));
            
            populateOrderFormSelects();
            renderAll(user.role);
        }

        function previewNextOrderId() {
            const today = new Date();
            const yyyymmdd = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
            const key = `order_counter_${yyyymmdd}`;
            let lastCounter = parseInt(localStorage.getItem(key) || '0');
            const nextCounter = lastCounter + 1;
            return `${yyyymmdd}.${nextCounter.toString().padStart(7, '0')}`;
        }

        orderChannelSelect.addEventListener('change', (e) => {
            const channelKey = e.target.value;
            const channel = salesChannels[channelKey];
            if (channel && channel.externalId) {
                orderIdInput.readOnly = false;
                orderIdInput.classList.remove('bg-gray-100');
                orderIdInput.value = '';
                orderIdInput.focus();
            } else {
                orderIdInput.readOnly = true;
                orderIdInput.classList.add('bg-gray-100');
                orderIdInput.value = previewNextOrderId();
            }
        });


        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const employeeId = parseInt(employeeSelect.value);
            const selectedRole = roleSelect.value;
            const employee = findById(employees, employeeId);

            if (employee && selectedRole) {
                const currentUser = { id: employee.id, name: employee.name, idCode: employee.idCode, role: selectedRole };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                initializeMainView(currentUser);
            } else {
                alert('Vui lòng chọn nhân viên và vai trò.');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('currentUser');
            window.location.reload();
        });

        addOrderForm.addEventListener('submit', async e => {
            e.preventDefault();
            
            if (currentOrderItems.length === 0) {
                alert('Vui lòng thêm ít nhất một món ăn vào đơn hàng.');
                return;
            }

            const channelKey = document.getElementById('order-channel-select').value;
            const channel = salesChannels[channelKey];
            let orderIdToSave = document.getElementById('order-id').value;

            // If it is an internal order, finalize the ID and update the counter.
            if (channel && !channel.externalId) {
                 const today = new Date();
                 const yyyymmdd = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
                 const key = `order_counter_${yyyymmdd}`;
                 const lastCounter = parseInt(localStorage.getItem(key) || '0');
                 const newCounter = lastCounter + 1;
                 localStorage.setItem(key, newCounter); // Save the incremented counter
                 orderIdToSave = `${yyyymmdd}.${newCounter.toString().padStart(7, '0')}`;
            }
            
            const newOrder = {
                id: Date.now(),
                items: [...currentOrderItems],
                channelKey: channelKey,
                customer: {
                    orderId: orderIdToSave,
                    name: document.getElementById('order-customer-name').value,
                    phone: document.getElementById('order-customer-phone').value,
                    address: document.getElementById('order-customer-address').value,
                },
                status: 'new',
                timestamps: {
                    created: Date.now(),
                    confirmedByKitchen: null,
                    confirmedByShipper: null,
                    completed: null,
                }
            };

            if (newOrder.channelKey && newOrder.customer.orderId) {
                activeOrders.unshift(newOrder);
                localStorage.setItem('activeOrders', JSON.stringify(activeOrders));
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                
                // Clear form and temporary items list first
                currentOrderItems = [];
                addOrderForm.reset();
                orderChannelSelect.dispatchEvent(new Event('change')); // Reset order ID
                
                // Then, re-render the whole UI
                renderAll(currentUser.role);
            } else {
                alert('Vui lòng điền đầy đủ thông tin bắt buộc.');
            }
        });
        
        function renderAll(role) {
            renderOrderKanban(role);
            renderCompletedOrders();
            renderCurrentOrderItems();
        }

        function renderOrderKanban(role) {
            const cols = {
                new: newOrdersCol,
                preparing: preparingOrdersCol,
                delivering: deliveringOrdersCol,
            };
            Object.values(cols).forEach(col => col.innerHTML = '');
            
            const visibleOrders = activeOrders.filter(o => rolesConfig[role].canSee.includes(o.status));

            if (visibleOrders.length === 0 && !document.getElementById('col-new-container').classList.contains('hidden')) {
                newOrdersCol.innerHTML = `<p class="text-gray-500 text-sm p-4 text-center">${translations[currentLang].empty_data}</p>`;
                return;
            }

            visibleOrders.forEach(order => {
                if (cols[order.status]) {
                    cols[order.status].innerHTML += renderOrderCard(order, role);
                }
            });
        }
        
        function renderOrderCard(order, role) {
            const channelName = salesChannels[order.channelKey]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || order.channelKey;
            
            let actionButton = '';
            let stageStartTime;
            let cardColorClass = 'border-blue-500';
            
            const itemsHtml = order.items.map(item => {
                const dish = findById(dishes, item.dishId);
                return `<li class="text-sm text-gray-800">${dish ? dish.name : 'Unknown Dish'} <span class="font-semibold">(x${item.quantity})</span></li>`;
            }).join('');

            if (order.status === 'new') {
                 if (role === 'kitchen') {
                    actionButton = `<button class="w-full mt-3 bg-blue-500 text-white text-sm py-1.5 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2 confirm-prepare-btn" data-id="${order.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg><span>${translations[currentLang].confirm_prepare}</span></button>`;
                 } else if (role === 'taker') {
                    actionButton = `<div class="flex gap-2 mt-3">
                        <button class="w-1/2 bg-yellow-400 text-yellow-900 text-xs py-1.5 rounded-lg hover:bg-yellow-500 flex items-center justify-center gap-1 font-semibold edit-order-btn" data-id="${order.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            <span>${translations[currentLang].edit_order}</span>
                        </button>
                        <button class="w-1/2 bg-red-400 text-red-900 text-xs py-1.5 rounded-lg hover:bg-red-500 flex items-center justify-center gap-1 font-semibold cancel-order-btn" data-id="${order.id}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            <span>${translations[currentLang].cancel_order}</span>
                        </button>
                    </div>`;
                 }
                 stageStartTime = order.timestamps.created;
            } else if (order.status === 'preparing') {
                cardColorClass = 'border-amber-500 bg-amber-50/50';
                if (role === 'kitchen') {
                    actionButton = `<button class="w-full mt-3 bg-amber-500 text-white text-sm py-1.5 rounded-lg hover:bg-amber-600 flex items-center justify-center gap-2 confirm-deliver-btn" data-id="${order.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg><span>${translations[currentLang].confirm_deliver}</span></button>`;
                }
                stageStartTime = order.timestamps.confirmedByKitchen;
            } else if (order.status === 'delivering') {
                cardColorClass = 'border-purple-500 bg-purple-50/50';
                if (role === 'shipper') {
                    actionButton = `<button class="w-full mt-3 bg-green-500 text-white text-sm py-1.5 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2 complete-order-btn" data-id="${order.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /><path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v5a1 1 0 001 1h2.05a2.5 2.5 0 014.9 0H21a1 1 0 001-1V8a1 1 0 00-1-1h-7z" /></svg><span>${translations[currentLang].complete_order}</span></button>`;
                }
                stageStartTime = order.timestamps.confirmedByShipper;
            }

            return `
                <div class="order-card bg-white p-4 rounded-xl shadow-sm border-l-4 ${cardColorClass}" data-stage-start-time="${stageStartTime}">
                    <div class="flex justify-between items-start">
                         <div>
                            <p class="font-bold text-gray-800">${order.customer.orderId}</p>
                            <p class="text-xs text-gray-500">${translations[currentLang].order_from}: <span class="font-semibold">${channelName}</span></p>
                         </div>
                         <div class="text-right">
                            <div class="font-semibold text-sm timer flex items-center gap-1 text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg><span>00:00</span></div>
                            <div class="text-xs text-gray-400">${translations[currentLang].time_in_stage}</div>
                         </div>
                    </div>
                    <ul class="list-disc list-inside ml-4 my-3 space-y-1">${itemsHtml}</ul>
                     <div class="text-xs text-gray-700 mt-2 pt-2 border-t border-dashed space-y-1">
                        ${order.customer.name ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> ${order.customer.name}</p>` : ''}
                        ${order.customer.phone ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg> ${order.customer.phone}</p>` : ''}
                        ${order.customer.address ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg> ${order.customer.address}</p>` : ''}
                     </div>
                    ${actionButton}
                </div>
            `;
        }
        
        function renderCompletedOrders() {
            const todayDateString = new Date().toDateString();

            const todaysCompletedOrders = completedOrders.filter(order => {
                if (!order.timestamps.completed) return false;
                const completedDateString = new Date(order.timestamps.completed).toDateString();
                return completedDateString === todayDateString;
            });

            renderList(todaysCompletedOrders, completedOrdersList, (order) => {
                const dishName = order.items.map(i => findById(dishes, i.dishId)?.name || '').join(', ');
                const totalTime = formatTime(order.timestamps.completed - order.timestamps.created);
                const completedTime = new Date(order.timestamps.completed).toLocaleTimeString('vi-VN');
                return `
                    <div class="p-3 bg-green-50 rounded-lg border-l-4 border-green-400 text-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${dishName} - <span class="font-mono">${order.customer.orderId}</span></p>
                                <p class="text-xs text-gray-500">${order.customer.name || ''} - ${order.customer.phone || ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-green-700 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>${totalTime}</p>
                                <p class="text-xs text-gray-500">${translations[currentLang].completed_at} ${completedTime}</p>
                            </div>
                        </div>
                    </div>
                `;
            }, 'empty_data', completedOrdersList);
        }
        
        function renderList(data, container, renderItemFn, emptyTextKey, listContainer) {
            if (data.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm p-4 text-center">${translations[currentLang][emptyTextKey]}</p>`;
                return;
            }
            container.innerHTML = data.map(renderItemFn).join('');
        }

        mainView.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const orderId = parseInt(button.dataset.id);
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

            if (button.classList.contains('confirm-prepare-btn')) {
                updateOrderStatus(orderId, 'preparing', 'confirmedByKitchen', currentUser.role);
            } else if (button.classList.contains('confirm-deliver-btn')) {
                updateOrderStatus(orderId, 'delivering', 'confirmedByShipper', currentUser.role);
            } else if (button.classList.contains('complete-order-btn')) {
                completeOrder(orderId, currentUser.role);
            } else if (button.classList.contains('edit-order-btn')) {
                openEditModal(orderId);
            } else if (button.classList.contains('cancel-order-btn')) {
                cancelOrder(orderId, currentUser.role);
            }
        });

        function updateOrderStatus(orderId, newStatus, timestampKey, role) {
            activeOrders = activeOrders.map(order => 
                order.id === orderId ? { ...order, status: newStatus, timestamps: { ...order.timestamps, [timestampKey]: Date.now() } } : order
            );
            localStorage.setItem('activeOrders', JSON.stringify(activeOrders));
            renderAll(role);
        }

        function completeOrder(orderId, role) {
            const orderIndex = activeOrders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;
            
            const order = { ...activeOrders[orderIndex] };
            order.timestamps.completed = Date.now();
            
            order.items.forEach(item => {
                const dish = findById(dishes, item.dishId);
                const channel = salesChannels[order.channelKey];
                if (!dish || !channel) return;

                const totalRevenue = dish.price * item.quantity;
                const commissionFee = totalRevenue * channel.commission;

                salesRecords.unshift({
                    id: Date.now() + Math.random(),
                    date: new Date(order.timestamps.created).toISOString().split('T')[0],
                    dishId: item.dishId,
                    quantity: item.quantity,
                    channelKey: order.channelKey,
                    totalRevenue,
                    commissionFee,
                    netRevenue: totalRevenue - commissionFee,
                    dishName: dish.name,
                    dishCost: dish.cost
                });
            });

            localStorage.setItem('salesRecords', JSON.stringify(salesRecords));
            
            completedOrders.unshift(order);
            localStorage.setItem('completedOrders', JSON.stringify(completedOrders));
            
            activeOrders.splice(orderIndex, 1);
            localStorage.setItem('activeOrders', JSON.stringify(activeOrders));
            
            renderAll(role);
        }
        
        function populateOrderFormSelects() {
            const selects = [
                document.getElementById('add-dish-select'),
                document.getElementById('edit-dish-select')
            ];
            const channelSelects = [
                document.getElementById('order-channel-select'),
                document.getElementById('edit-order-channel-select')
            ];

            selects.forEach(select => {
                select.innerHTML = `<option value="">-- ${translations[currentLang].select_dish} --</option>`;
                dishes.forEach(item => {
                    select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
                });
            });
            
            channelSelects.forEach(select => {
                 select.innerHTML = `<option value="">-- ${translations[currentLang].select_channel} --</option>`;
                for (const key in salesChannels) {
                    const name = salesChannels[key][`name${currentLang === 'zh' ? '_zh' : ''}`] || salesChannels[key].name;
                    select.innerHTML += `<option value="${key}">${name}</option>`;
                }
            });
        }
        
        function populateEmployeeSelect() {
            employeeSelect.innerHTML = `<option value="">${translations[currentLang].select_employee}</option>`;
            const activeEmployees = employees.filter(emp => emp.status === 'active');
            activeEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.name} (${emp.idCode})`;
                employeeSelect.appendChild(option);
            });
        }
        
        function populateRoleSelect(employeeId) {
            roleSelect.innerHTML = `<option value="">${translations[currentLang].select_role}</option>`;
            const employee = findById(employees, employeeId);
            if(employee) {
                employee.roles.forEach(roleKey => {
                    const role = rolesConfig[roleKey];
                     if (role) {
                        const option = document.createElement('option');
                        option.value = roleKey;
                        option.textContent = role[`name${currentLang === 'zh' ? '_zh' : ''}`];
                        roleSelect.appendChild(option);
                    }
                });
            }
        }

        employeeSelect.addEventListener('change', (e) => {
            const employeeId = parseInt(e.target.value);
            populateRoleSelect(employeeId);
        });

        // --- Multi-dish logic for ADD FORM ---
        addDishToOrderBtn.addEventListener('click', () => {
            const dishSelect = document.getElementById('add-dish-select');
            const quantityInput = document.getElementById('add-dish-quantity');
            const dishId = parseInt(dishSelect.value);
            const quantity = parseInt(quantityInput.value);

            if (dishId && quantity > 0) {
                const existingItem = currentOrderItems.find(item => item.dishId === dishId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    currentOrderItems.push({ dishId, quantity });
                }
                renderCurrentOrderItems();
                quantityInput.value = 1;
                dishSelect.value = '';
            }
        });

        currentOrderItemsContainer.addEventListener('click', e => {
            const button = e.target.closest('.remove-order-item-btn');
            if (button) {
                const index = parseInt(button.dataset.index);
                currentOrderItems.splice(index, 1);
                renderCurrentOrderItems();
            }
        });

        function renderCurrentOrderItems() {
            renderItemsList(currentOrderItems, currentOrderItemsContainer, 'no_items_added');
        }

        // --- EDIT MODAL LOGIC ---
        function openEditModal(orderId) {
            const orderToEdit = activeOrders.find(o => o.id === orderId);
            if (!orderToEdit) return;

            editOrderModal.dataset.editingId = orderId;

            // Populate fields
            document.getElementById('edit-order-channel-select').value = orderToEdit.channelKey;
            document.getElementById('edit-order-id').value = orderToEdit.customer.orderId;
            document.getElementById('edit-order-customer-name').value = orderToEdit.customer.name;
            document.getElementById('edit-order-customer-address').value = orderToEdit.customer.address;
            document.getElementById('edit-order-customer-phone').value = orderToEdit.customer.phone;

            // Populate items
            editingOrderItems = JSON.parse(JSON.stringify(orderToEdit.items)); // Deep copy
            renderEditingOrderItems();
            
            editOrderModal.classList.remove('hidden');
            editOrderModal.classList.add('flex');
        }

        function closeEditModal() {
            editOrderModal.classList.add('hidden');
            editOrderModal.classList.remove('flex');
            editingOrderItems = [];
            editOrderModal.dataset.editingId = '';
        }

        editOrderModal.querySelectorAll('#close-edit-modal-btn, #cancel-edit-modal-btn').forEach(btn => {
            btn.addEventListener('click', closeEditModal);
        });
        
        editOrderForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const orderId = parseInt(editOrderModal.dataset.editingId);
            const orderIndex = activeOrders.findIndex(o => o.id === orderId);
            
            if (orderIndex === -1) {
                alert('Lỗi: Không tìm thấy đơn hàng!');
                closeEditModal();
                return;
            }
            if(editingOrderItems.length === 0){
                alert('Đơn hàng phải có ít nhất một món ăn.');
                return;
            }

            // Update order data
            activeOrders[orderIndex].customer.name = document.getElementById('edit-order-customer-name').value;
            activeOrders[orderIndex].customer.address = document.getElementById('edit-order-customer-address').value;
            activeOrders[orderIndex].customer.phone = document.getElementById('edit-order-customer-phone').value;
            activeOrders[orderIndex].items = editingOrderItems;

            localStorage.setItem('activeOrders', JSON.stringify(activeOrders));
            
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            renderAll(currentUser.role);
            closeEditModal();
        });

        document.getElementById('add-dish-to-edit-order-btn').addEventListener('click', () => {
            const dishSelect = document.getElementById('edit-dish-select');
            const quantityInput = document.getElementById('edit-dish-quantity');
            const dishId = parseInt(dishSelect.value);
            const quantity = parseInt(quantityInput.value);

            if (dishId && quantity > 0) {
                const existingItem = editingOrderItems.find(item => item.dishId === dishId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    editingOrderItems.push({ dishId, quantity });
                }
                renderEditingOrderItems();
                quantityInput.value = 1;
                dishSelect.value = '';
            }
        });
        
        document.getElementById('editing-order-items').addEventListener('click', e => {
            const button = e.target.closest('.remove-editing-item-btn');
            if(button) {
                const index = parseInt(button.dataset.index);
                editingOrderItems.splice(index, 1);
                renderEditingOrderItems();
            }
        });

        function renderEditingOrderItems() {
            renderItemsList(editingOrderItems, document.getElementById('editing-order-items'), 'no_items_added', true);
        }
        
        function cancelOrder(orderId, role) {
            activeOrders = activeOrders.filter(order => order.id !== orderId);
            localStorage.setItem('activeOrders', JSON.stringify(activeOrders));
            renderAll(role);
        }
        
        function renderItemsList(items, container, emptyTextKey, isEditing = false) {
             if (items.length === 0) {
                container.innerHTML = `<p class="text-center text-sm text-gray-500 pt-4" data-lang="${emptyTextKey}">${translations[currentLang][emptyTextKey]}</p>`;
                return;
            }
            container.innerHTML = items.map((item, index) => {
                const dish = findById(dishes, item.dishId);
                return `
                    <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg text-sm">
                        <span><strong>${dish.name}</strong> x ${item.quantity}</span>
                        <button type="button" class="${isEditing ? 'remove-editing-item-btn' : 'remove-order-item-btn'} text-red-500 hover:text-red-700 font-bold text-lg leading-none p-1" data-index="${index}">&times;</button>
                    </div>
                `;
            }).join('');
        }


        // --- Timers Update ---
        setInterval(() => {
            document.querySelectorAll('.order-card').forEach(card => {
                const startTime = parseInt(card.dataset.stageStartTime);
                if (startTime) {
                    const elapsedTime = Date.now() - startTime;
                    const timerSpan = card.querySelector('.timer span');
                    if (timerSpan) {
                       timerSpan.textContent = formatTime(elapsedTime);
                    }
                }
            });
        }, 1000);

        // --- Initial Load ---
        function checkSession() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                initializeMainView(currentUser);
            } else {
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
                populateEmployeeSelect();
            }
        }
        
        setLanguage(currentLang);
        checkSession();
        orderChannelSelect.dispatchEvent(new Event('change'));
    });
    </script>
</body>
</html>

