<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị - Canh Tiềm Dưỡng Sinh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .tab-content, .modal {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .lang-btn.active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="px-8 py-6">
                <h2 class="text-2xl font-semibold" data-lang="dashboard_title">Bảng Điều Khiển</h2>
            </div>
             <!-- Language Switcher -->
            <div class="px-4 py-2">
                <div class="flex bg-gray-700 rounded-lg p-1">
                    <button class="lang-btn flex-1 text-sm py-1 px-2 rounded-md" data-lang-code="vi">Tiếng Việt</button>
                    <button class="lang-btn flex-1 text-sm py-1 px-2 rounded-md" data-lang-code="zh">繁體中文</button>
                </div>
            </div>
            <nav class="flex-1 px-4 py-2 space-y-2 overflow-y-auto">
                 <a href="#" class="tab-link active:bg-gray-700 bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="employee-management">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 12A3 3 0 1012 6a3 3 0 000 6z" /></svg>
                    <span data-lang="employee_management">Quản Lý Nhân Viên</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="sales-management">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l.383-1.437M7.5 14.25L5.106 5.165A2.25 2.25 0 002.854 3H2.25" />
                    </svg>
                    <span data-lang="order_lookup">Tra Cứu Đơn Hàng</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="menu-management">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <span data-lang="menu_management">Quản Lý Thực Đơn</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="supplier-management">
                     <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                     </svg>
                     <span data-lang="supplier_management">Nhà Cung Cấp</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="purchase-management">
                     <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                     <span data-lang="material_management">Nguyên Vật Liệu</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="spoilage-management">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                    <span data-lang="spoilage_management">Quản Lý Hư Hao</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="cost-management">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 4h4m5 6H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2z"></path></svg>
                    <span data-lang="other_costs">Chi Phí Khác</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="profit-report">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                    <span data-lang="profit_report">Báo Cáo Lợi Nhuận</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="inventory-report">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-1.621-1.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h4.5M15 3.75a2.25 2.25 0 012.25 2.25V6a2.25 2.25 0 01-2.25 2.25H8.25A2.25 2.25 0 016 6V5.25a2.25 2.25 0 012.25-2.25h4.5M15 3.75h-4.5m0 0a2.25 2.25 0 012.25 2.25V6" />
                    </svg>
                    <span data-lang="inventory_report">Báo Cáo Tồn Kho</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="adjustment-logs">
                     <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                    </svg>
                    <span data-lang="adjustment_logs">Lịch Sử Điều Chỉnh</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            
             <!-- Tab: Quản Lý Nhân Viên -->
            <div id="employee-management" class="tab-content active">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="employee_management_title">Quản Lý Nhân Viên</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold mb-4" data-lang="add_new_employee">Thêm Nhân Viên Mới</h2>
                            <form id="add-employee-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="employee-name" class="block text-sm font-medium text-gray-700" data-lang="employee_name">Họ và Tên</label>
                                        <input type="text" id="employee-name" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                    <div>
                                        <label for="employee-id-code" class="block text-sm font-medium text-gray-700" data-lang="employee_id_code">Mã số nhân viên</label>
                                        <input type="text" id="employee-id-code" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                    <div>
                                        <label for="employee-dob" class="block text-sm font-medium text-gray-700" data-lang="employee_dob">Ngày sinh</label>
                                        <input type="date" id="employee-dob" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                    <div>
                                        <label for="employee-nid" class="block text-sm font-medium text-gray-700" data-lang="employee_nid">Số CCCD/CC</label>
                                        <input type="text" id="employee-nid" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                </div>
                                <div>
                                    <label for="employee-photo-url" class="block text-sm font-medium text-gray-700" data-lang="employee_photo_url">URL Hình ảnh</label>
                                    <input type="url" id="employee-photo-url" data-lang-placeholder="employee_photo_url_placeholder" placeholder="https://example.com/photo.jpg" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                </div>
                                 <div>
                                    <label for="employee-permanent-address" class="block text-sm font-medium text-gray-700" data-lang="employee_permanent_address">Địa chỉ thường trú</label>
                                    <input type="text" id="employee-permanent-address" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                </div>
                                <div>
                                    <label for="employee-current-address" class="block text-sm font-medium text-gray-700" data-lang="employee_current_address">Địa chỉ hiện tại</label>
                                    <input type="text" id="employee-current-address" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     <div>
                                        <label for="employee-start-date" class="block text-sm font-medium text-gray-700" data-lang="employee_start_date">Ngày nhận việc</label>
                                        <input type="date" id="employee-start-date" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                    <div>
                                        <label for="employee-type" class="block text-sm font-medium text-gray-700" data-lang="employee_type">Hình thức làm việc</label>
                                        <select id="employee-type" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                            <option value="part-time" data-lang="employee_type_part_time">Bán thời gian</option>
                                            <option value="contract" data-lang="employee_type_contract">Hợp đồng lao động</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700" data-lang="roles">Vai trò</label>
                                    <div id="employee-roles-checkboxes" class="mt-2 space-y-2">
                                        <!-- Checkboxes will be inserted here by JS -->
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700" data-lang="add_employee_btn">Thêm Nhân Viên</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold mb-4" data-lang="employee_list">Danh Sách Nhân Viên</h2>
                            <div id="employees-list" class="space-y-4 max-h-[80vh] overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Tra Cứu Đơn Hàng -->
            <div id="sales-management" class="tab-content">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="order_lookup_title">Tra Cứu Đơn Hàng</h1>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-wrap items-center gap-4 mb-6 pb-6 border-b">
                        <div>
                            <label for="order-lookup-start-date" class="block text-sm font-medium text-gray-700" data-lang="from_date">Từ ngày</label>
                            <input type="date" id="order-lookup-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="order-lookup-end-date" class="block text-sm font-medium text-gray-700" data-lang="to_date">Đến ngày</label>
                            <input type="date" id="order-lookup-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="self-end">
                            <button id="order-lookup-btn" class="bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700" data-lang="search_btn">Tra cứu</button>
                        </div>
                    </div>
                    <h2 class="text-xl font-semibold mb-4" data-lang="order_history">Lịch Sử Đơn Hàng</h2>
                    <div id="order-lookup-results" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
                </div>
            </div>

            <!-- Tab: Quản Lý Thực Đơn -->
            <div id="menu-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="menu_management_title">Quản Lý Thực Đơn &amp; Định Lượng (BOM)</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Form thêm món ăn -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="add_new_dish">Thêm Món Mới</h2>
                        <form id="add-dish-form" class="space-y-4">
                            <!-- Basic Info -->
                            <div>
                                <div class="flex justify-between items-center">
                                     <label for="dish-name" class="block text-sm font-medium text-gray-700" data-lang="dish_name">Tên món</label>
                                     <button type="button" id="suggest-name-btn" class="text-xs text-indigo-700 font-semibold py-1 hover:text-indigo-900 flex items-center disabled:opacity-50">
                                        <span data-lang="suggest_dish_name">✨ Gợi ý tên</span>
                                    </button>
                                </div>
                                <input type="text" id="dish-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <div id="dish-name-suggestions" class="mt-2 text-sm"></div>
                            </div>
                            <div>
                                <div class="flex justify-between items-center">
                                    <label for="dish-description" class="block text-sm font-medium text-gray-700" data-lang="description">Mô tả</label>
                                    <button type="button" id="suggest-description-btn" class="text-xs text-indigo-700 font-semibold py-1 hover:text-indigo-900 flex items-center disabled:opacity-50">
                                        <span data-lang="suggest_description">✨ Gợi ý mô tả</span>
                                    </button>
                                </div>
                                <textarea id="dish-description" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                            </div>
                            <div>
                                <label for="dish-price" class="block text-sm font-medium text-gray-700" data-lang="selling_price">Giá Bán (VND)</label>
                                <input type="number" id="dish-price" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                             <div>
                                <label for="dish-image-url" class="block text-sm font-medium text-gray-700" data-lang="image_url">URL Hình ảnh</label>
                                <input type="text" id="dish-image-url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <!-- BOM Section -->
                            <div class="pt-4 border-t">
                                <h3 class="text-lg font-medium text-gray-800 mb-2" data-lang="bom_title">Định Lượng Nguyên Liệu (BOM)</h3>
                                <div class="flex gap-2 items-center">
                                    <select id="bom-material-select" class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3"></select>
                                    <input type="number" id="bom-quantity" data-lang-placeholder="quantity_short" placeholder="SL" class="w-20 border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <button type="button" id="add-bom-item-btn" class="bg-gray-600 text-white px-3 py-2 rounded-md hover:bg-gray-700">+</button>
                                </div>
                                <div id="bom-items-list" class="mt-2 space-y-1"></div>
                                <div class="mt-2 font-semibold text-right"><span data-lang="estimated_cost">Giá vốn ước tính</span>: <span id="estimated-cost">0 VND</span></div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700" data-lang="add_dish_btn">Thêm Món</button>
                        </form>
                    </div>
                    <!-- Danh sách món ăn -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="current_dishes_list">Danh Sách Món Ăn Hiện Có</h2>
                        <div id="dishes-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Quản Lý Nhà Cung Cấp -->
            <div id="supplier-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="supplier_management_title">Quản Lý Nhà Cung Cấp</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                             <h3 class="text-lg font-medium mb-2" data-lang="add_new_supplier">Thêm NCC Mới</h3>
                             <form id="add-supplier-form" class="space-y-4">
                                <input type="text" id="supplier-name" data-lang-placeholder="supplier_name" placeholder="Tên nhà cung cấp" required class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <input type="text" id="supplier-contact" data-lang-placeholder="contact_person" placeholder="Người liên hệ" class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <input type="tel" id="supplier-phone" data-lang-placeholder="phone_number" placeholder="Số điện thoại" class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <input type="text" id="supplier-address" data-lang-placeholder="address" placeholder="Địa chỉ" class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <input type="text" id="supplier-taxcode" data-lang-placeholder="tax_code" placeholder="Mã số thuế (nếu có)" class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700" data-lang="add_supplier_btn">Thêm NCC</button>
                            </form>
                        </div>
                        <div class="lg:col-span-2">
                             <h3 class="text-lg font-medium mb-2" data-lang="suppliers_list_title">Danh Sách Nhà Cung Cấp</h3>
                             <div id="suppliers-list" class="mt-4 space-y-3 max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Nguyên Vật Liệu Mua Vào -->
            <div id="purchase-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="purchase_management_title">Nguyên Vật Liệu Mua Vào</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Column 1: Define new materials & List -->
                        <div class="space-y-6">
                             <div>
                                 <h3 class="text-lg font-medium mb-2" data-lang="define_material">Định Nghĩa Nguyên Vật Liệu</h3>
                                 <form id="add-material-form" class="flex gap-2">
                                     <input type="text" id="material-name" data-lang-placeholder="material_name" placeholder="Tên nguyên liệu" required class="flex-grow border border-gray-300 rounded-md py-2 px-3">
                                     <input type="text" id="material-unit" data-lang-placeholder="unit_placeholder" placeholder="Đơn vị (kg, gr, cái)" required class="w-36 border border-gray-300 rounded-md py-2 px-3">
                                     <button type="submit" class="bg-blue-600 text-white px-4 rounded-md hover:bg-blue-700" data-lang="add_btn">Thêm</button>
                                 </form>
                             </div>
                             <div>
                                 <h3 class="text-lg font-medium mb-2" data-lang="materials_list_title">Danh Sách Nguyên Vật Liệu</h3>
                                 <div id="materials-list" class="space-y-2 max-h-[450px] overflow-y-auto"></div>
                             </div>
                        </div>

                        <!-- Column 2: Record Purchases -->
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-medium mb-2" data-lang="record_purchase">Nhập Kho</h3>
                                <form id="add-purchase-form" class="space-y-4 p-4 border rounded-md">
                                    <div>
                                        <label class="block text-sm font-medium" data-lang="purchase_date">Ngày nhập hàng</label>
                                        <input type="date" id="purchase-date" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium" data-lang="material">Nguyên liệu</label>
                                        <select id="purchase-material-select" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"></select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium" data-lang="quantity">Số lượng</label>
                                            <input type="number" id="purchase-quantity" min="0" step="any" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium" data-lang="unit">Đơn vị</label>
                                            <input type="text" id="purchase-unit" readonly class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md py-2 px-3">
                                        </div>
                                    </div>
                                     <div>
                                        <label class="block text-sm font-medium" data-lang="total_price">Tổng tiền (VND)</label>
                                        <input type="number" id="purchase-total-price" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                     <div>
                                        <label class="block text-sm font-medium" data-lang="supplier">Nhà cung cấp</label>
                                        <select id="purchase-supplier-select" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"></select>
                                    </div>
                                    <p class="text-right"><span data-lang="new_unit_price_label">Đơn giá mới sẽ là</span>: <span id="new-unit-price" class="font-semibold">0 VND</span></p>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700" data-lang="confirm_purchase_btn">Xác Nhận Nhập Kho</button>
                                </form>
                            </div>
                             <div>
                                 <h3 class="text-lg font-semibold mb-2" data-lang="purchase_history_title">Lịch Sử Nhập Kho</h3>
                                 <div id="purchases-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Tab: Quản Lý Hư Hao -->
            <div id="spoilage-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="spoilage_management_title">Quản Lý Nguyên Vật Liệu Hư Hao</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Form for adding spoilage -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="record_spoilage">Ghi Nhận Hư Hao</h2>
                        <form id="add-spoilage-form" class="space-y-4">
                            <div>
                                <label for="spoilage-date" class="block text-sm font-medium text-gray-700" data-lang="spoilage_date">Ngày thải bỏ</label>
                                <input type="date" id="spoilage-date" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                            </div>
                            <div>
                                <label for="spoilage-material-select" class="block text-sm font-medium text-gray-700" data-lang="material">Nguyên liệu</label>
                                <select id="spoilage-material-select" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="spoilage-quantity" class="block text-sm font-medium text-gray-700" data-lang="quantity">Số lượng</label>
                                    <input type="number" id="spoilage-quantity" min="0" step="any" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700" data-lang="unit">Đơn vị tính</label>
                                    <input type="text" id="spoilage-unit" readonly class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md py-2 px-3">
                                </div>
                            </div>
                             <div>
                                <label for="spoilage-reason" class="block text-sm font-medium text-gray-700" data-lang="spoilage_reason">Nguyên nhân thải bỏ</label>
                                <input type="text" id="spoilage-reason" required data-lang-placeholder="spoilage_reason_placeholder" placeholder="VD: Hết hạn, hỏng..." class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                            </div>
                            <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700" data-lang="record_btn">Ghi Nhận</button>
                        </form>
                    </div>
                    <!-- List of spoilage records -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold" data-lang="spoilage_history_title">Lịch Sử Hư Hao</h2>
                             <button id="analyze-spoilage-btn" class="bg-indigo-600 text-white py-1 px-3 rounded-md text-sm hover:bg-indigo-700 flex items-center disabled:opacity-50">
                                <span data-lang="analyze_spoilage">✨ Phân tích & Đề xuất</span>
                            </button>
                        </div>
                        <div id="spoilage-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
                        <div id="spoilage-analysis-result" class="mt-4 hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Chi Phí Khác -->
            <div id="cost-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="other_costs_title">Quản Lý Chi Phí Khác</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Add Cost Form -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="add_new_cost">Thêm Chi Phí Mới</h2>
                        <form id="add-other-cost-form" class="space-y-4">
                            <div>
                                <label for="other-cost-name" class="block text-sm font-medium text-gray-700" data-lang="cost_name">Tên chi phí</label>
                                <input type="text" id="other-cost-name" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                            </div>
                            <div>
                                <label for="other-cost-amount" class="block text-sm font-medium text-gray-700" data-lang="amount">Số tiền (VND)</label>
                                <input type="number" id="other-cost-amount" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                            </div>
                            <div>
                                <label for="other-cost-frequency" class="block text-sm font-medium text-gray-700" data-lang="cost_type">Loại chi phí</label>
                                <select id="other-cost-frequency" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                    <option value="monthly" data-lang="monthly">Hàng tháng</option>
                                    <option value="yearly" data-lang="yearly">Hàng năm</option>
                                    <option value="onetime" data-lang="onetime">Một lần (Đầu tư)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700" data-lang="add_cost_btn">Thêm Chi Phí</button>
                        </form>
                    </div>
                    <!-- Display Costs -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3" data-lang="monthly_costs">Chi phí hàng tháng</h3>
                            <div id="monthly-costs-list" class="space-y-2"></div>
                            <div class="mt-4 pt-4 border-t font-bold flex justify-between">
                                <span data-lang="total_monthly">Tổng cộng tháng:</span><span id="total-monthly-costs">0 VND</span>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3" data-lang="yearly_costs">Chi phí hàng năm</h3>
                            <div id="yearly-costs-list" class="space-y-2"></div>
                             <div class="mt-4 pt-4 border-t font-bold flex justify-between">
                                <span data-lang="total_yearly">Tổng cộng năm:</span><span id="total-yearly-costs">0 VND</span>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3" data-lang="onetime_costs">Chi phí một lần (Đầu tư)</h3>
                            <div id="onetime-costs-list" class="space-y-2"></div>
                             <div class="mt-4 pt-4 border-t font-bold flex justify-between">
                                <span data-lang="total">Tổng cộng:</span><span id="total-onetime-costs">0 VND</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Báo Cáo Lợi Nhuận -->
            <div id="profit-report" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="profit_report_title">Báo Cáo Lợi Nhuận</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-wrap items-center gap-4 mb-6 pb-6 border-b">
                         <div>
                            <label for="profit-report-start-date" class="block text-sm font-medium text-gray-700" data-lang="from_date">Từ ngày</label>
                            <input type="date" id="profit-report-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="profit-report-end-date" class="block text-sm font-medium text-gray-700" data-lang="to_date">Đến ngày</label>
                            <input type="date" id="profit-report-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="self-end">
                            <button id="calculate-profit-btn" class="w-full bg-green-600 text-white py-2 px-5 rounded-md hover:bg-green-700" data-lang="calculate_profit_btn">Xem Báo Cáo Lợi Nhuận</button>
                        </div>
                    </div>
                    <div id="profit-results" class="mt-8 pt-6 border-t hidden">
                        <h3 class="text-2xl font-semibold mb-4 text-center" data-lang="business_results_period">Kết Quả Kinh Doanh Trong Kỳ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg">
                            <div class="bg-blue-50 p-4 rounded-md"><p class="text-gray-600" data-lang="total_revenue">Tổng Doanh Thu:</p><p id="result-revenue" class="font-bold text-2xl text-blue-700">0 VND</p></div>
                            <div class="bg-orange-50 p-4 rounded-md"><p class="text-gray-600" data-lang="total_cogs">Tổng Giá Vốn Hàng Bán:</p><p id="result-cogs" class="font-bold text-2xl text-orange-700">0 VND</p></div>
                             <div class="bg-red-50 p-4 rounded-md"><p class="text-gray-600" data-lang="total_commission_fees">Tổng Phí Chiết Khấu:</p><p id="result-commission-fees" class="font-bold text-2xl text-red-700">0 VND</p></div>
                            <div class="bg-yellow-50 p-4 rounded-md"><p class="text-gray-600" data-lang="total_operating_expenses">Tổng Chi Phí Hoạt Động (Tháng):</p><p id="result-monthly-expense" class="font-bold text-2xl text-yellow-700">0 VND</p></div>
                            <div class="bg-red-100 p-4 rounded-md"><p class="text-gray-600" data-lang="spoilage_cost">Chi Phí Hư Hao (Ước Tính):</p><p id="result-spoilage-cost" class="font-bold text-2xl text-red-800">0 VND</p></div>
                            <div class="bg-green-100 p-4 rounded-md col-span-1 md:col-span-2"><p class="text-gray-600" data-lang="net_profit">Lợi Nhuận Ròng (Trước Thuế):</p><p id="result-net-profit" class="font-bold text-3xl text-green-800">0 VND</p></div>
                        </div>
                        <div class="mt-8 text-center">
                            <button id="suggest-marketing-btn" class="bg-indigo-600 text-white py-2 px-5 rounded-md hover:bg-indigo-700 flex items-center justify-center mx-auto disabled:opacity-50">
                                <span data-lang="suggest_marketing_plan">✨ Gợi ý kế hoạch marketing</span>
                            </button>
                            <div id="marketing-suggestions" class="mt-4 text-left hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Báo Cáo Tồn Kho -->
            <div id="inventory-report" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="inventory_report_title">Báo Cáo Xuất Nhập Tồn Nguyên Liệu</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-wrap items-center gap-4 mb-6 pb-6 border-b">
                        <div>
                            <label for="report-preset-filter" class="block text-sm font-medium text-gray-700" data-lang="view_by">Xem theo</label>
                            <select id="report-preset-filter" class="mt-1 block w-full md:w-auto border-gray-300 rounded-md shadow-sm">
                                <option value="custom" data-lang="custom_option">Tùy chọn</option>
                                <option value="this_month" data-lang="this_month">Tháng này</option>
                                <option value="this_quarter" data-lang="this_quarter">Quí này</option>
                                <option value="this_year" data-lang="this_year">Năm này</option>
                            </select>
                        </div>
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium text-gray-700" data-lang="from_date">Từ ngày</label>
                            <input type="date" id="report-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium text-gray-700" data-lang="to_date">Đến ngày</label>
                            <input type="date" id="report-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="self-end">
                            <button id="view-inventory-report-btn" class="bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700" data-lang="view_report_btn">Xem Báo Cáo</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="material_name_header">Tên Nguyên Liệu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="unit_header">ĐVT</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="opening_stock">Tồn Đầu Kỳ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="purchased_in_period">Nhập Trong Kỳ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="used_in_period">Xuất Trong Kỳ (Bán)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="spoiled_in_period">Hư Hao Trong Kỳ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="closing_stock">Tồn Cuối Kỳ</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-report-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: Lịch sử điều chỉnh -->
            <div id="adjustment-logs" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="adjustment_logs_title">Lịch Sử Điều Chỉnh Dữ Liệu</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="adjustment-logs-list" class="space-y-4"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- Employee Details Modal -->
    <div id="employee-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center overflow-y-auto p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold" data-lang="employee_details_title">Thông Tin Chi Tiết Nhân Viên</h2>
                <button id="close-employee-modal-btn" class="text-3xl font-light leading-none text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <img id="modal-employee-photo" src="https://placehold.co/300x400/EFEFEF/AAAAAA&text=Ảnh" alt="Employee Photo" class="rounded-lg w-full h-auto object-cover">
                </div>
                <div class="md:col-span-2 space-y-3 text-sm">
                    <p><strong><span data-lang="employee_name">Họ và Tên</span>:</strong> <span id="modal-employee-name"></span></p>
                    <p><strong><span data-lang="employee_id_code">Mã số nhân viên</span>:</strong> <span id="modal-employee-id-code"></span></p>
                    <p><strong><span data-lang="employee_dob">Ngày sinh</span>:</strong> <span id="modal-employee-dob"></span></p>
                    <p><strong><span data-lang="employee_nid">Số CCCD/CC</span>:</strong> <span id="modal-employee-nid"></span></p>
                    <p><strong><span data-lang="employee_permanent_address">Địa chỉ thường trú</span>:</strong> <span id="modal-employee-permanent-address"></span></p>
                    <p><strong><span data-lang="employee_current_address">Địa chỉ hiện tại</span>:</strong> <span id="modal-employee-current-address"></span></p>
                    <hr>
                    <p><strong><span data-lang="employee_start_date">Ngày nhận việc</span>:</strong> <span id="modal-employee-start-date"></span></p>
                    <p><strong><span data-lang="employee_type">Hình thức làm việc</span>:</strong> <span id="modal-employee-type"></span></p>
                    <p><strong><span data-lang="roles">Vai trò</span>:</strong> <span id="modal-employee-roles"></span></p>
                </div>
            </div>
            <div id="termination-section" class="mt-6 pt-6 border-t">
                <!-- Shown for terminated employees -->
                <div id="termination-info" class="hidden space-y-2 text-sm text-red-700 bg-red-50 p-4 rounded-lg">
                     <p><strong><span data-lang="employee_status">Trạng thái</span>:</strong> <span data-lang="status_terminated">Đã thôi việc</span></p>
                     <p><strong><span data-lang="termination_date">Ngày thôi việc</span>:</strong> <span id="modal-employee-end-date"></span></p>
                     <p><strong><span data-lang="termination_reason">Lý do</span>:</strong> <span id="modal-employee-termination-reason"></span></p>
                </div>
                <!-- Shown for active employees -->
                <div id="terminate-actions" class="text-right">
                    <button id="show-terminate-form-btn" type="button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700" data-lang="terminate_employee_btn">Thôi việc</button>
                </div>
                <!-- Form, hidden initially -->
                <form id="terminate-employee-form" class="hidden">
                     <h3 class="text-lg font-semibold mb-3" data-lang="terminate_employee_title">Chấm Dứt Hợp Đồng</h3>
                     <input type="hidden" id="terminate-employee-id">
                     <div class="space-y-4">
                         <div>
                            <label for="employee-end-date" class="block text-sm font-medium" data-lang="termination_date">Ngày thôi việc</label>
                            <input type="date" id="employee-end-date" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                         </div>
                         <div>
                             <label for="employee-termination-reason" class="block text-sm font-medium" data-lang="termination_reason">Lý do thôi việc</label>
                             <textarea id="employee-termination-reason" rows="2" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3"></textarea>
                         </div>
                     </div>
                     <div class="flex justify-end gap-4 mt-4">
                         <button type="button" id="cancel-termination-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300" data-lang="cancel_btn">Hủy</button>
                         <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700" data-lang="confirm_termination_btn">Xác nhận thôi việc</button>
                     </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Edit Supplier Modal -->
    <div id="edit-supplier-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4" data-lang="edit_supplier_title">Điều Chỉnh Thông Tin Nhà Cung Cấp</h2>
            <form id="edit-supplier-form" class="space-y-4">
                <input type="hidden" id="edit-supplier-id">
                <div>
                    <label class="block text-sm font-medium" data-lang="supplier_name_label">Tên nhà cung cấp</label>
                    <input type="text" id="edit-supplier-name" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="contact_person">Người liên hệ</label>
                    <input type="text" id="edit-supplier-contact" class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="phone_number">Số điện thoại</label>
                    <input type="tel" id="edit-supplier-phone" class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="address">Địa chỉ</label>
                    <input type="text" id="edit-supplier-address" class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="tax_code_label">Mã số thuế</label>
                    <input type="text" id="edit-supplier-taxcode" class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="adjustment_reason">Lý do điều chỉnh</label>
                    <textarea id="edit-supplier-reason" required rows="2" class="mt-1 w-full border-gray-300 rounded-md py-2 px-3"></textarea>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-supplier" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md" data-lang="cancel_btn">Hủy</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md" data-lang="save_changes_btn">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Purchase Modal -->
    <div id="edit-purchase-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4" data-lang="edit_purchase_title">Điều Chỉnh Dữ Liệu Nhập Kho</h2>
            <form id="edit-purchase-form" class="space-y-4">
                <input type="hidden" id="edit-purchase-id">
                 <div>
                    <label class="block text-sm font-medium" data-lang="purchase_date">Ngày nhập</label>
                    <input type="date" id="edit-purchase-date" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="material">Nguyên liệu</label>
                    <p id="edit-purchase-material-name" class="font-semibold mt-1"></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium" data-lang="quantity">Số lượng</label>
                        <input type="number" step="any" id="edit-purchase-quantity" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                    </div>
                    <div>
                         <label class="block text-sm font-medium" data-lang="total_price">Tổng tiền (VND)</label>
                        <input type="number" id="edit-purchase-total-price" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium" data-lang="supplier">Nhà cung cấp</label>
                    <select id="edit-purchase-supplier-select" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="adjustment_reason">Lý do điều chỉnh</label>
                    <textarea id="edit-purchase-reason" required rows="2" class="mt-1 w-full border-gray-300 rounded-md py-2 px-3"></textarea>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-purchase" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md" data-lang="cancel_btn">Hủy</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md" data-lang="save_changes_btn">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const translations = {
            vi: {
                dashboard_title: 'Bảng Điều Khiển',
                employee_management: 'Quản Lý Nhân Viên',
                employee_management_title: 'Quản Lý Nhân Viên',
                add_new_employee: 'Thêm Nhân Viên Mới',
                employee_id_code: 'Mã số nhân viên',
                employee_name: 'Họ và Tên',
                employee_dob: 'Ngày sinh',
                employee_nid: 'Số CCCD/CC',
                employee_photo_url: 'URL Hình ảnh',
                employee_photo_url_placeholder: 'https://example.com/photo.jpg',
                employee_permanent_address: 'Địa chỉ thường trú',
                employee_current_address: 'Địa chỉ hiện tại',
                employee_start_date: 'Ngày nhận việc',
                employee_type: 'Hình thức làm việc',
                employee_type_part_time: 'Bán thời gian',
                employee_type_contract: 'Hợp đồng lao động',
                roles: 'Vai trò',
                add_employee_btn: 'Thêm Nhân Viên',
                employee_list: 'Danh Sách Nhân Viên',
                employee_details_title: 'Thông Tin Chi Tiết Nhân Viên',
                terminate_employee_btn: 'Thôi việc',
                terminate_employee_title: 'Chấm Dứt Hợp Đồng',
                termination_date: 'Ngày thôi việc',
                termination_reason: 'Lý do thôi việc',
                confirm_termination_btn: 'Xác nhận thôi việc',
                employee_status: 'Trạng thái',
                status_active: 'Đang làm việc',
                status_terminated: 'Đã thôi việc',
                view_details: 'Xem chi tiết',
                role_taker: 'Nhận Đơn',
                role_kitchen: 'Bếp',
                role_shipper: 'Giao Hàng',
                order_lookup: 'Tra Cứu Đơn Hàng',
                order_lookup_title: 'Tra Cứu Đơn Hàng',
                search_btn: 'Tra cứu',
                order_history: 'Lịch Sử Đơn Hàng',
                menu_management: 'Quản Lý Thực Đơn',
                supplier_management: 'Nhà Cung Cấp',
                material_management: 'Nguyên Vật Liệu',
                spoilage_management: 'Quản Lý Hư Hao',
                other_costs: 'Chi Phí Khác',
                profit_report: 'Báo Cáo Lợi Nhuận',
                inventory_report: 'Báo Cáo Tồn Kho',
                adjustment_logs: 'Lịch Sử Điều Chỉnh',
                dish: 'Món ăn',
                sales_channel: 'Kênh bán hàng',
                menu_management_title: 'Quản Lý Thực Đơn & Định Lượng (BOM)',
                add_new_dish: 'Thêm Món Mới',
                dish_name: 'Tên món',
                description: 'Mô tả',
                suggest_description: '✨ Gợi ý mô tả',
                selling_price: 'Giá Bán (VND)',
                image_url: 'URL Hình ảnh',
                bom_title: 'Định Lượng Nguyên Liệu (BOM)',
                quantity_short: 'SL',
                estimated_cost: 'Giá vốn ước tính',
                add_dish_btn: 'Thêm Món',
                current_dishes_list: 'Danh Sách Món Ăn Hiện Có',
                supplier_management_title: 'Quản Lý Nhà Cung Cấp',
                add_new_supplier: 'Thêm NCC Mới',
                supplier_name: 'Tên nhà cung cấp',
                contact_person: 'Người liên hệ',
                phone_number: 'Số điện thoại',
                address: 'Địa chỉ',
                tax_code: 'Mã số thuế (nếu có)',
                add_supplier_btn: 'Thêm NCC',
                suppliers_list_title: 'Danh Sách Nhà Cung Cấp',
                purchase_management_title: 'Nguyên Vật Liệu Mua Vào',
                define_material: 'Định Nghĩa Nguyên Vật Liệu',
                material_name: 'Tên nguyên liệu',
                unit_placeholder: 'Đơn vị (kg, gr, cái)',
                add_btn: 'Thêm',
                materials_list_title: 'Danh Sách Nguyên Vật Liệu',
                record_purchase: 'Nhập Kho',
                purchase_date: 'Ngày nhập hàng',
                material: 'Nguyên liệu',
                quantity: 'Số lượng',
                unit: 'Đơn vị',
                total_price: 'Tổng tiền (VND)',
                supplier: 'Nhà cung cấp',
                new_unit_price_label: 'Đơn giá mới sẽ là',
                confirm_purchase_btn: 'Xác Nhận Nhập Kho',
                purchase_history_title: 'Lịch Sử Nhập Kho',
                spoilage_management_title: 'Quản Lý Nguyên Vật Liệu Hư Hao',
                record_spoilage: 'Ghi Nhận Hư Hao',
                spoilage_date: 'Ngày thải bỏ',
                spoilage_reason: 'Nguyên nhân thải bỏ',
                spoilage_reason_placeholder: 'VD: Hết hạn, hỏng...',
                record_btn: 'Ghi Nhận',
                spoilage_history_title: 'Lịch Sử Hư Hao',
                other_costs_title: 'Quản Lý Chi Phí Khác',
                add_new_cost: 'Thêm Chi Phí Mới',
                cost_name: 'Tên chi phí',
                amount: 'Số tiền (VND)',
                cost_type: 'Loại chi phí',
                monthly: 'Hàng tháng',
                yearly: 'Hàng năm',
                onetime: 'Một lần (Đầu tư)',
                add_cost_btn: 'Thêm Chi Phí',
                monthly_costs: 'Chi phí hàng tháng',
                total_monthly: 'Tổng cộng tháng:',
                yearly_costs: 'Chi phí hàng năm',
                total_yearly: 'Tổng cộng năm:',
                onetime_costs: 'Chi phí một lần (Đầu tư)',
                total: 'Tổng cộng:',
                profit_report_title: 'Báo Cáo Lợi Nhuận',
                calculate_profit_btn: 'Xem Báo Cáo Lợi Nhuận',
                business_results_period: 'Kết Quả Kinh Doanh Trong Kỳ',
                total_revenue: 'Tổng Doanh Thu:',
                total_cogs: 'Tổng Giá Vốn Hàng Bán:',
                total_commission_fees: 'Tổng Phí Chiết Khấu:',
                total_operating_expenses: 'Tổng Chi Phí Hoạt Động (Tháng):',
                spoilage_cost: 'Chi Phí Hư Hao (Ước Tính):',
                net_profit: 'Lợi Nhuận Ròng (Trước Thuế):',
                suggest_marketing_plan: '✨ Gợi ý kế hoạch marketing',
                inventory_report_title: 'Báo Cáo Xuất Nhập Tồn Nguyên Liệu',
                view_by: 'Xem theo',
                custom_option: 'Tùy chọn',
                this_month: 'Tháng này',
                this_quarter: 'Quí này',
                this_year: 'Năm này',
                from_date: 'Từ ngày',
                to_date: 'Đến ngày',
                view_report_btn: 'Xem Báo Cáo',
                material_name_header: 'Tên Nguyên Liệu',
                unit_header: 'ĐVT',
                opening_stock: 'Tồn Đầu Kỳ',
                purchased_in_period: 'Nhập Trong Kỳ',
                used_in_period: 'Xuất Trong Kỳ (Bán)',
                spoiled_in_period: 'Hư Hao Trong Kỳ',
                closing_stock: 'Tồn Cuối Kỳ',
                adjustment_logs_title: 'Lịch Sử Điều Chỉnh Dữ Liệu',
                edit_supplier_title: 'Điều Chỉnh Thông Tin Nhà Cung Cấp',
                supplier_name_label: 'Tên nhà cung cấp',
                adjustment_reason: 'Lý do điều chỉnh',
                cancel_btn: 'Hủy',
                save_changes_btn: 'Lưu Thay Đổi',
                edit_purchase_title: 'Điều Chỉnh Dữ Liệu Nhập Kho',
                delete: 'Xóa',
                edit: 'Sửa',
                empty_data: 'Chưa có dữ liệu.',
                empty_adjustment_logs: 'Chưa có lịch sử điều chỉnh nào.',
                thinking: 'Đang nghĩ...',
                suggestion_error: 'Không thể nhận được gợi ý. Vui lòng thử lại.',
                ai_connection_error: 'Đã xảy ra lỗi khi kết nối với AI.',
                select_material: 'Chọn nguyên liệu',
                select_supplier: 'Chọn NCC',
                select_dish: 'Chọn món ăn',
                select_channel: 'Chọn kênh bán',
                log_type_supplier: 'Nhà Cung Cấp',
                log_type_purchase: 'Nhập kho',
                sales_volume_placeholder: 'Số lượng bán',
                suggest_dish_name: '✨ Gợi ý tên',
                analyze_spoilage: '✨ Phân tích & Đề xuất',
                spoilage_analysis_title: 'Phân Tích Hư Hao & Đề Xuất Giải Pháp',
                dish_name_suggestions: 'Gợi Ý Tên Món Ăn',
                customer_info: 'Thông tin khách hàng',
                total_duration: 'Tổng thời gian',
                shipper_handover_time: 'Giờ giao shipper',
                minutes: 'phút'
            },
            zh: {
                dashboard_title: '儀表板',
                employee_management: '員工管理',
                employee_management_title: '員工管理',
                add_new_employee: '新增員工',
                employee_id_code: '員工編號',
                employee_name: '姓名',
                employee_dob: '出生日期',
                employee_nid: '身分證號碼',
                employee_photo_url: '照片網址',
                employee_photo_url_placeholder: 'https://example.com/photo.jpg',
                employee_permanent_address: '戶籍地址',
                employee_current_address: '目前地址',
                employee_start_date: '到職日期',
                employee_type: '工作類型',
                employee_type_part_time: '兼職',
                employee_type_contract: '勞動合約',
                roles: '角色',
                add_employee_btn: '新增員工',
                employee_list: '員工列表',
                employee_details_title: '員工詳細資訊',
                terminate_employee_btn: '終止合約',
                terminate_employee_title: '終止合約',
                termination_date: '離職日期',
                termination_reason: '離職原因',
                confirm_termination_btn: '確認離職',
                employee_status: '狀態',
                status_active: '在職',
                status_terminated: '已離職',
                view_details: '查看詳情',
                role_taker: '接單員',
                role_kitchen: '廚房',
                role_shipper: '配送員',
                order_lookup: '訂單查詢',
                order_lookup_title: '訂單查詢',
                search_btn: '查詢',
                order_history: '訂單歷史',
                menu_management: '菜單管理',
                supplier_management: '供應商管理',
                material_management: '原材料管理',
                spoilage_management: '損耗管理',
                other_costs: '其他費用',
                profit_report: '利潤報告',
                inventory_report: '庫存報告',
                adjustment_logs: '調整日誌',
                dish: '菜式',
                sales_channel: '銷售渠道',
                menu_management_title: '菜單與物料清單(BOM)管理',
                add_new_dish: '新增菜式',
                dish_name: '菜式名稱',
                description: '描述',
                suggest_description: '✨ AI建議描述',
                selling_price: '售價 (VND)',
                image_url: '圖片URL',
                bom_title: '原材料定量 (BOM)',
                quantity_short: '數量',
                estimated_cost: '估計成本',
                add_dish_btn: '新增菜式',
                current_dishes_list: '現有菜式列表',
                supplier_management_title: '供應商管理',
                add_new_supplier: '新增供應商',
                supplier_name: '供應商名稱',
                contact_person: '聯絡人',
                phone_number: '電話號碼',
                address: '地址',
                tax_code: '稅號 (如有)',
                add_supplier_btn: '新增供應商',
                suppliers_list_title: '供應商列表',
                purchase_management_title: '原材料採購',
                define_material: '定義原材料',
                material_name: '原材料名稱',
                unit_placeholder: '單位 (公斤, 克, 個)',
                add_btn: '新增',
                materials_list_title: '原材料列表',
                record_purchase: '入庫',
                purchase_date: '入庫日期',
                material: '原材料',
                quantity: '數量',
                unit: '單位',
                total_price: '總金額 (VND)',
                supplier: '供應商',
                new_unit_price_label: '新單價為',
                confirm_purchase_btn: '確認入庫',
                purchase_history_title: '入庫歷史',
                spoilage_management_title: '原材料損耗管理',
                record_spoilage: '記錄損耗',
                spoilage_date: '報廢日期',
                spoilage_reason: '報廢原因',
                spoilage_reason_placeholder: '例如: 過期, 損壞...',
                record_btn: '記錄',
                spoilage_history_title: '損耗歷史',
                other_costs_title: '其他費用管理',
                add_new_cost: '新增費用',
                cost_name: '費用名稱',
                amount: '金額 (VND)',
                cost_type: '費用類型',
                monthly: '每月',
                yearly: '每年',
                onetime: '一次性 (投資)',
                add_cost_btn: '新增費用',
                monthly_costs: '每月費用',
                total_monthly: '每月總計:',
                yearly_costs: '每年費用',
                total_yearly: '每年總計:',
                onetime_costs: '一次性費用 (投資)',
                total: '總計:',
                profit_report_title: '利潤報告',
                calculate_profit_btn: '查看利潤報告',
                business_results_period: '期間經營業績',
                total_revenue: '總收入:',
                total_cogs: '總銷售成本:',
                total_commission_fees: '總佣金費用:',
                total_operating_expenses: '每月總營運費用:',
                spoilage_cost: '損耗成本 (估計):',
                net_profit: '淨利潤 (稅前):',
                suggest_marketing_plan: '✨ AI建議營銷計劃',
                inventory_report_title: '原材料出入庫存報告',
                view_by: '查看方式',
                custom_option: '自定義',
                this_month: '本月',
                this_quarter: '本季',
                this_year: '本年',
                from_date: '開始日期',
                to_date: '結束日期',
                view_report_btn: '查看報告',
                material_name_header: '原材料名稱',
                unit_header: '單位',
                opening_stock: '期初庫存',
                purchased_in_period: '本期入庫',
                used_in_period: '本期出庫 (銷售)',
                spoiled_in_period: '本期損耗',
                closing_stock: '期末庫存',
                adjustment_logs_title: '數據調整日誌',
                edit_supplier_title: '編輯供應商資訊',
                supplier_name_label: '供應商名稱',
                adjustment_reason: '調整原因',
                cancel_btn: '取消',
                save_changes_btn: '保存更改',
                edit_purchase_title: '編輯入庫數據',
                delete: '刪除',
                edit: '編輯',
                empty_data: '暫無數據。',
                empty_adjustment_logs: '暫無調整日誌。',
                thinking: '思考中...',
                suggestion_error: '無法獲取建議。請重試。',
                ai_connection_error: '連接AI時發生錯誤。',
                select_material: '選擇原材料',
                select_supplier: '選擇供應商',
                select_dish: '選擇菜式',
                select_channel: '選擇銷售渠道',
                log_type_supplier: '供應商',
                log_type_purchase: '入庫',
                sales_volume_placeholder: '銷售數量',
                suggest_dish_name: '✨ 建議菜名',
                analyze_spoilage: '✨ 分析與建議',
                spoilage_analysis_title: '損耗分析與解決方案建議',
                dish_name_suggestions: '菜名建議',
                customer_info: '客戶資訊',
                total_duration: '總時間',
                shipper_handover_time: '交貨時間',
                minutes: '分鐘'
            }
        };

        let currentLang = localStorage.getItem('language') || 'vi';

        const setLanguage = (lang) => {
            currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang === 'zh' ? 'zh-Hant' : 'vi';

            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                 if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.langCode === lang);
            });

            // Re-render dynamic content that needs translation
            renderApp();
        };

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                setLanguage(btn.dataset.langCode);
            });
        });

        // --- Helper Functions ---
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        const findById = (arr, id) => arr.find(item => item.id === parseInt(id));
        const todayISO = () => new Date().toISOString().split('T')[0];

        // --- Data Initialization from localStorage ---
        let dishes = JSON.parse(localStorage.getItem('dishes')) || [];
        let rawMaterials = JSON.parse(localStorage.getItem('rawMaterials')) || [];
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        let spoilageRecords = JSON.parse(localStorage.getItem('spoilageRecords')) || [];
        let adjustmentLogs = JSON.parse(localStorage.getItem('adjustmentLogs')) || [];
        let salesRecords = JSON.parse(localStorage.getItem('salesRecords')) || [];
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let currentBomItems = [];
        let otherCosts = [];

        const salesChannels = {
            'AtStore': { name: 'Tại quán', commission: 0, name_zh: '店內' },
            'GrabFood': { name: 'GrabFood', commission: 0.25, name_zh: 'GrabFood' },
            'ShopeeFood': { name: 'ShopeeFood', commission: 0.25, name_zh: 'ShopeeFood' },
            'Zalo': { name: 'Zalo', commission: 0, name_zh: 'Zalo' },
            'Hotline': { name: 'Hotline', commission: 0, name_zh: '熱線電話' }
        };

        const employeeRoles = {
            'taker': { name: 'Nhận Đơn', name_zh: '接單員' },
            'kitchen': { name: 'Bếp', name_zh: '廚房' },
            'shipper': { name: 'Giao Hàng', name_zh: '配送員' }
        };
        
        const employmentTypes = {
            'part-time': {name: 'Bán thời gian', name_zh: '兼職'},
            'contract': {name: 'Hợp đồng lao động', name_zh: '勞動合約'}
        };

        // --- DOM Elements ---
        const elements = {
            // Employee
            addEmployeeForm: document.getElementById('add-employee-form'),
            employeeRolesCheckboxes: document.getElementById('employee-roles-checkboxes'),
            employeesList: document.getElementById('employees-list'),
            employeeDetailsModal: document.getElementById('employee-details-modal'),
            closeEmployeeModalBtn: document.getElementById('close-employee-modal-btn'),
            terminateEmployeeForm: document.getElementById('terminate-employee-form'),
            showTerminateFormBtn: document.getElementById('show-terminate-form-btn'),
            cancelTerminationBtn: document.getElementById('cancel-termination-btn'),
            terminateActions: document.getElementById('terminate-actions'),
            terminationInfo: document.getElementById('termination-info'),
            // Sales / Order Lookup
            orderLookupStartDate: document.getElementById('order-lookup-start-date'),
            orderLookupEndDate: document.getElementById('order-lookup-end-date'),
            orderLookupBtn: document.getElementById('order-lookup-btn'),
            orderLookupResults: document.getElementById('order-lookup-results'),
            // Menu
            addDishForm: document.getElementById('add-dish-form'),
            dishesList: document.getElementById('dishes-list'),
            bomMaterialSelect: document.getElementById('bom-material-select'),
            bomQuantityInput: document.getElementById('bom-quantity'),
            addBomItemBtn: document.getElementById('add-bom-item-btn'),
            bomItemsList: document.getElementById('bom-items-list'),
            estimatedCostSpan: document.getElementById('estimated-cost'),
            // Materials & Suppliers
            addMaterialForm: document.getElementById('add-material-form'),
            materialsList: document.getElementById('materials-list'),
            addSupplierForm: document.getElementById('add-supplier-form'),
            suppliersList: document.getElementById('suppliers-list'),
            // Purchase
            addPurchaseForm: document.getElementById('add-purchase-form'),
            purchaseMaterialSelect: document.getElementById('purchase-material-select'),
            purchaseSupplierSelect: document.getElementById('purchase-supplier-select'),
            purchaseQuantityInput: document.getElementById('purchase-quantity'),
            purchaseTotalPriceInput: document.getElementById('purchase-total-price'),
            purchaseUnitInput: document.getElementById('purchase-unit'),
            newUnitPriceSpan: document.getElementById('new-unit-price'),
            purchasesList: document.getElementById('purchases-list'),
            // Spoilage
            spoilageMaterialSelect: document.getElementById('spoilage-material-select'),
            spoilageUnitInput: document.getElementById('spoilage-unit'),
            spoilageList: document.getElementById('spoilage-list'),
            // Reports
            calculateProfitBtn: document.getElementById('calculate-profit-btn'),
            profitReportStartDate: document.getElementById('profit-report-start-date'),
            profitReportEndDate: document.getElementById('profit-report-end-date'),
            viewInventoryReportBtn: document.getElementById('view-inventory-report-btn'),
            reportPresetFilter: document.getElementById('report-preset-filter'),
            reportStartDate: document.getElementById('report-start-date'),
            reportEndDate: document.getElementById('report-end-date'),
            inventoryReportBody: document.getElementById('inventory-report-body'),
            adjustmentLogsList: document.getElementById('adjustment-logs-list'),
            // Modals
            editSupplierModal: document.getElementById('edit-supplier-modal'),
            editSupplierForm: document.getElementById('edit-supplier-form'),
            cancelEditSupplierBtn: document.getElementById('cancel-edit-supplier'),
            editPurchaseModal: document.getElementById('edit-purchase-modal'),
            editPurchaseForm: document.getElementById('edit-purchase-form'),
            cancelEditPurchaseBtn: document.getElementById('cancel-edit-purchase'),
            // AI Features
            suggestNameBtn: document.getElementById('suggest-name-btn'),
            dishNameSuggestions: document.getElementById('dish-name-suggestions'),
            analyzeSpoilageBtn: document.getElementById('analyze-spoilage-btn'),
            spoilageAnalysisResult: document.getElementById('spoilage-analysis-result'),
        };
        
        // Set default dates
        const today = todayISO();
        elements.orderLookupStartDate.value = today;
        elements.orderLookupEndDate.value = today;
        document.getElementById('purchase-date').value = today;
        document.getElementById('spoilage-date').value = today;
        document.getElementById('employee-start-date').value = today;


        // --- Tab Switching Logic ---
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        tabLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                tabLinks.forEach(l => l.classList.remove('active:bg-gray-700', 'bg-gray-700'));
                tabContents.forEach(c => c.classList.remove('active'));
                link.classList.add('active:bg-gray-700', 'bg-gray-700');
                document.getElementById(link.dataset.tab).classList.add('active');
            });
        });

        // --- Employee Management Logic ---
        function renderEmployeeRolesCheckboxes() {
            elements.employeeRolesCheckboxes.innerHTML = Object.keys(employeeRoles).map(roleKey => {
                const roleName = employeeRoles[roleKey][`name${currentLang === 'zh' ? '_zh' : ''}`];
                return `
                    <label class="flex items-center">
                        <input type="checkbox" value="${roleKey}" class="form-checkbox h-5 w-5 text-indigo-600">
                        <span class="ml-2 text-gray-700">${roleName}</span>
                    </label>
                `;
            }).join('');
        }

        elements.addEmployeeForm.addEventListener('submit', e => {
            e.preventDefault();
            const selectedRoles = Array.from(elements.employeeRolesCheckboxes.querySelectorAll('input:checked')).map(input => input.value);
            
            const newEmployee = {
                id: Date.now(),
                name: document.getElementById('employee-name').value,
                idCode: document.getElementById('employee-id-code').value,
                dob: document.getElementById('employee-dob').value,
                nid: document.getElementById('employee-nid').value,
                photoUrl: document.getElementById('employee-photo-url').value,
                permanentAddress: document.getElementById('employee-permanent-address').value,
                currentAddress: document.getElementById('employee-current-address').value,
                startDate: document.getElementById('employee-start-date').value,
                type: document.getElementById('employee-type').value,
                roles: selectedRoles,
                status: 'active', // 'active' or 'terminated'
                endDate: null,
                terminationReason: null
            };

            if (newEmployee.idCode && newEmployee.name && newEmployee.roles.length > 0) {
                employees.push(newEmployee);
                localStorage.setItem('employees', JSON.stringify(employees));
                renderEmployees();
                e.target.reset();
                 document.getElementById('employee-start-date').value = todayISO();
            } else {
                alert('Vui lòng điền đầy đủ Mã số, Họ tên và chọn ít nhất một vai trò.');
            }
        });
        
        function renderEmployees() {
             renderList(elements.employeesList, employees, (employee) => {
                const typeName = employmentTypes[employee.type]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || employee.type;
                const statusActive = employee.status === 'active';
                return `
                    <div class="p-4 bg-white rounded-lg border flex items-center gap-4">
                        <img src="${employee.photoUrl || 'https://placehold.co/80x80/EFEFEF/AAAAAA&text=Ảnh'}" alt="Photo of ${employee.name}" class="w-20 h-20 rounded-full object-cover">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-lg">${employee.name}</p>
                                    <p class="text-sm text-gray-500">${employee.idCode} - ${typeName}</p>
                                </div>
                                <span class="text-xs font-bold py-1 px-2.5 rounded-full ${statusActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${translations[currentLang][statusActive ? 'status_active' : 'status_terminated']}
                                </span>
                            </div>
                             <button class="view-employee-details-btn text-sm text-indigo-600 hover:text-indigo-800 font-semibold mt-2" data-id="${employee.id}">${translations[currentLang].view_details}</button>
                        </div>
                    </div>
                `;
             });
        }
        
        elements.employeesList.addEventListener('click', e => {
            if (e.target.classList.contains('view-employee-details-btn')) {
                const employeeId = parseInt(e.target.dataset.id);
                const employee = findById(employees, employeeId);
                if (employee) {
                    showEmployeeDetailsModal(employee);
                }
            }
        });
        
        function showEmployeeDetailsModal(employee) {
            document.getElementById('modal-employee-photo').src = employee.photoUrl || 'https://placehold.co/300x400/EFEFEF/AAAAAA&text=Ảnh';
            document.getElementById('modal-employee-name').textContent = employee.name;
            document.getElementById('modal-employee-id-code').textContent = employee.idCode;
            document.getElementById('modal-employee-dob').textContent = employee.dob;
            document.getElementById('modal-employee-nid').textContent = employee.nid;
            document.getElementById('modal-employee-permanent-address').textContent = employee.permanentAddress;
            document.getElementById('modal-employee-current-address').textContent = employee.currentAddress;
            document.getElementById('modal-employee-start-date').textContent = employee.startDate;
            document.getElementById('modal-employee-type').textContent = employmentTypes[employee.type]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || employee.type;
            document.getElementById('modal-employee-roles').textContent = employee.roles.map(r => employeeRoles[r]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || r).join(', ');
            
            const terminationInfoDiv = elements.terminationInfo;
            const terminationForm = elements.terminateEmployeeForm;
            const terminateActionsDiv = elements.terminateActions;
            
            if (employee.status === 'terminated') {
                terminationInfoDiv.classList.remove('hidden');
                terminationForm.classList.add('hidden');
                terminateActionsDiv.classList.add('hidden');
                document.getElementById('modal-employee-end-date').textContent = employee.endDate;
                document.getElementById('modal-employee-termination-reason').textContent = employee.terminationReason;
            } else { // 'active' status
                terminationInfoDiv.classList.add('hidden');
                terminationForm.classList.add('hidden'); // Hide form initially
                terminateActionsDiv.classList.remove('hidden'); // Show the "Thôi việc" button
                document.getElementById('terminate-employee-id').value = employee.id;
            }
            
            elements.employeeDetailsModal.classList.add('active');
        }

        elements.showTerminateFormBtn.addEventListener('click', () => {
            elements.terminateEmployeeForm.classList.remove('hidden');
            elements.terminateActions.classList.add('hidden');
        });

        elements.cancelTerminationBtn.addEventListener('click', () => {
            elements.terminateEmployeeForm.classList.add('hidden');
            elements.terminateActions.classList.remove('hidden');
            elements.terminateEmployeeForm.reset();
        });

        elements.closeEmployeeModalBtn.addEventListener('click', () => {
             elements.employeeDetailsModal.classList.remove('active');
             // Reset the form state for next time
             elements.terminateEmployeeForm.classList.add('hidden');
             elements.terminateActions.classList.remove('hidden');
             elements.terminateEmployeeForm.reset();
        });

        elements.terminateEmployeeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const employeeId = parseInt(document.getElementById('terminate-employee-id').value);
            const endDate = document.getElementById('employee-end-date').value;
            const reason = document.getElementById('employee-termination-reason').value;

            if (!endDate || !reason) {
                alert('Vui lòng điền ngày và lý do thôi việc.');
                return;
            }

            employees = employees.map(emp => {
                if (emp.id === employeeId) {
                    return {...emp, status: 'terminated', endDate: endDate, terminationReason: reason};
                }
                return emp;
            });

            localStorage.setItem('employees', JSON.stringify(employees));
            renderEmployees();
            elements.employeeDetailsModal.classList.remove('active');
            e.target.reset();
        });


        // --- Gemini API Integration ---
        const callGeminiAPI = async (prompt, button) => {
            const originalButtonHTML = button.innerHTML;
            const loadingSpinner = `<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>${translations[currentLang].thinking}</span>`;
            button.innerHTML = loadingSpinner;
            button.disabled = true;

            const apiKey = "AIzaSyDGY_sja2mUqs4KlE7bCKmwOKoFz3sfMRg";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            if (apiKey === "DÁN_API_KEY_CỦA_BẠN_VÀO_ĐÂY") {
                const errorMsg = "Lỗi: Vui lòng thêm API Key của bạn để sử dụng tính năng AI.";
                alert(errorMsg);
                console.error(errorMsg);
                button.innerHTML = originalButtonHTML;
                button.disabled = false;
                return translations[currentLang].ai_connection_error;
            }

            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                return text || translations[currentLang].suggestion_error;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return translations[currentLang].ai_connection_error;
            } finally {
                button.innerHTML = originalButtonHTML;
                button.disabled = false;
            }
        };

        // --- Generic Render Functions ---
        function renderList(container, items, renderItemFn, emptyTextKey = "empty_data") {
            const emptyText = translations[currentLang][emptyTextKey];
            container.innerHTML = items.length ? items.map(renderItemFn).join('') : `<p class="text-gray-500 text-sm p-4 text-center">${emptyText}</p>`;
        }
        
        // --- Order Lookup Logic ---
        elements.orderLookupBtn.addEventListener('click', () => {
            const startDate = elements.orderLookupStartDate.value;
            const endDate = elements.orderLookupEndDate.value;
            if (!startDate || !endDate) {
                alert(currentLang === 'vi' ? 'Vui lòng chọn cả ngày bắt đầu và ngày kết thúc.' : '請選擇開始和結束日期。');
                return;
            }
             if (new Date(startDate) > new Date(endDate)) {
                alert(currentLang === 'vi' ? 'Ngày bắt đầu không thể lớn hơn ngày kết thúc.' : '開始日期不能晚於結束日期。');
                return;
            }

            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);

            const filteredSales = salesRecords.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= start && saleDate <= end;
            });
            
            renderOrderLookupResults(filteredSales);
        });

        function renderOrderLookupResults(data) {
            renderList(elements.orderLookupResults, data, (sale) => {
                const channelName = salesChannels[sale.channelKey]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || sale.channelKey;
                const customer = sale.customer || {};
                
                let durationInfo = '';
                if (sale.timestamps && sale.timestamps.createdAt && sale.timestamps.completedAt) {
                    const startTime = new Date(sale.timestamps.createdAt);
                    const endTime = new Date(sale.timestamps.completedAt);
                    const durationMinutes = Math.round((endTime - startTime) / (1000 * 60));
                    durationInfo = `<p class="text-xs text-gray-500">${translations[currentLang].total_duration}: <span class="font-semibold">${durationMinutes} ${translations[currentLang].minutes}</span></p>`;
                }

                let shipperTimeInfo = '';
                if (sale.timestamps && sale.timestamps.deliveryStartedAt) {
                    const deliveryTime = new Date(sale.timestamps.deliveryStartedAt);
                    const formattedTime = deliveryTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    shipperTimeInfo = `<p class="text-xs text-gray-500">${translations[currentLang].shipper_handover_time}: <span class="font-semibold">${formattedTime}</span></p>`;
                }


                return `
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <div class="flex justify-between items-start">
                             <div>
                                <p class="font-semibold text-base">${sale.dishName} (x${sale.quantity})</p>
                                <p class="text-xs text-gray-500">${new Date(sale.date).toLocaleDateString('vi-VN')} - ${channelName}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-lg text-green-600">${formatCurrency(sale.netRevenue)}</p>
                                <p class="text-xs text-gray-500 line-through">${formatCurrency(sale.totalRevenue)}</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t text-sm space-y-2">
                             <div class="text-gray-700">
                                <p class="font-semibold">${customer.orderId ? '#' + customer.orderId : ''} ${customer.name || ''}</p>
                                <p>${customer.phone || ''}</p>
                                <p>${customer.address || ''}</p>
                            </div>
                             <div class="flex justify-between items-center text-blue-800 bg-blue-50 p-2 rounded-md">
                                ${durationInfo}
                                ${shipperTimeInfo}
                            </div>
                        </div>
                    </div>
                `;
            });
        }


        // --- Material & Supplier Logic ---
        const renderMaterial = (m) => `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-md"><span>${m.name} (${m.unit})</span><span class="font-mono text-sm">${formatCurrency(m.price)}</span></div>`;
        
        const renderSupplier = (s) => `
            <div class="p-3 bg-gray-50 rounded-md border text-sm relative">
                <p class="font-semibold text-base">${s.name}</p>
                <p class="text-gray-600"><strong>${translations[currentLang].contact_person}:</strong> ${s.contact || 'N/A'} - <strong>SĐT:</strong> ${s.phone || 'N/A'}</p>
                <p class="text-gray-600"><strong>${translations[currentLang].address}:</strong> ${s.address || 'N/A'}</p>
                ${s.taxCode ? `<p class="text-gray-500 text-xs"><strong>MST:</strong> ${s.taxCode}</p>` : ''}
                <button class="edit-supplier-btn absolute top-2 right-2 text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded" data-id="${s.id}">${translations[currentLang].edit}</button>
            </div>
        `;
        
        const renderPurchase = (p) => {
            const material = findById(rawMaterials, p.materialId);
            return `<div class="text-sm p-2 bg-gray-50 rounded-md flex justify-between items-center">
                <div>
                    <strong>${material?.name || 'N/A'}</strong> - ${p.quantity} ${material?.unit || ''} @ ${formatCurrency(p.unitPrice)}
                    <span class="text-xs text-gray-500 block">${new Date(p.date).toLocaleDateString('vi-VN')}</span>
                </div>
                <button class="edit-purchase-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded" data-id="${p.id}">${translations[currentLang].edit}</button>
            </div>`;
        };
        
        function populateSelect(select, items, placeholderKey, valueField = 'id', textField = 'name') {
            const placeholder = translations[currentLang][placeholderKey];
            select.innerHTML = `<option value="">-- ${placeholder} --</option>`;
            items.forEach(item => {
                select.innerHTML += `<option value="${item[valueField]}">${item[textField]}</option>`;
            });
        }
        
        function updateAllSelects() {
            populateSelect(elements.bomMaterialSelect, rawMaterials, 'select_material');
            populateSelect(elements.purchaseMaterialSelect, rawMaterials, 'select_material');
            populateSelect(elements.purchaseSupplierSelect, suppliers, 'select_supplier');
            populateSelect(elements.spoilageMaterialSelect, rawMaterials, 'select_material');
        }

        elements.addMaterialForm.addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('material-name').value;
            const unit = document.getElementById('material-unit').value;
            rawMaterials.push({ id: Date.now(), name, unit, price: 0 });
            localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
            renderApp();
            e.target.reset();
        });

        elements.addSupplierForm.addEventListener('submit', e => {
            e.preventDefault();
            suppliers.push({ 
                id: Date.now(), 
                name: document.getElementById('supplier-name').value,
                contact: document.getElementById('supplier-contact').value,
                phone: document.getElementById('supplier-phone').value,
                address: document.getElementById('supplier-address').value,
                taxCode: document.getElementById('supplier-taxcode').value,
            });
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            renderApp();
            e.target.reset();
        });

        elements.purchaseMaterialSelect.addEventListener('change', (e) => {
            const materialId = parseInt(e.target.value);
            const material = findById(rawMaterials, materialId);
            elements.purchaseUnitInput.value = material ? material.unit : '';
        });

        function updateNewUnitPrice() {
            const quantity = parseFloat(elements.purchaseQuantityInput.value) || 0;
            const totalPrice = parseFloat(elements.purchaseTotalPriceInput.value) || 0;
            const unitPrice = quantity > 0 ? totalPrice / quantity : 0;
            elements.newUnitPriceSpan.textContent = formatCurrency(unitPrice);
        }
        elements.purchaseQuantityInput.addEventListener('input', updateNewUnitPrice);
        elements.purchaseTotalPriceInput.addEventListener('input', updateNewUnitPrice);

        elements.addPurchaseForm.addEventListener('submit', e => {
            e.preventDefault();
            const purchaseData = {
                id: Date.now(),
                date: document.getElementById('purchase-date').value,
                materialId: parseInt(elements.purchaseMaterialSelect.value),
                supplierId: parseInt(elements.purchaseSupplierSelect.value),
                quantity: parseFloat(elements.purchaseQuantityInput.value),
                totalPrice: parseFloat(elements.purchaseTotalPriceInput.value),
            };

            if (!purchaseData.date || !purchaseData.materialId || !purchaseData.supplierId || isNaN(purchaseData.quantity) || isNaN(purchaseData.totalPrice)) {
                alert('Vui lòng điền đủ thông tin.'); return;
            }
            
            purchaseData.unitPrice = purchaseData.totalPrice / purchaseData.quantity;
            purchases.unshift(purchaseData);
            localStorage.setItem('purchases', JSON.stringify(purchases));

            updateAllMaterialPrices();
            recalculateAllDishCosts();
            renderApp();
            e.target.reset();
            document.getElementById('purchase-date').value = todayISO();
            updateNewUnitPrice();
        });

        function logAdjustment(typeKey, recordId, reason, changes) {
            adjustmentLogs.unshift({
                id: Date.now(),
                typeKey: typeKey,
                recordId: recordId,
                reason: reason,
                date: new Date().toISOString(),
                changes: changes
            });
            localStorage.setItem('adjustmentLogs', JSON.stringify(adjustmentLogs));
        }

        elements.suppliersList.addEventListener('click', e => {
            if (e.target.matches('.edit-supplier-btn')) {
                const supplierId = parseInt(e.target.dataset.id);
                const supplier = findById(suppliers, supplierId);
                if (supplier) {
                    document.getElementById('edit-supplier-id').value = supplier.id;
                    document.getElementById('edit-supplier-name').value = supplier.name;
                    document.getElementById('edit-supplier-contact').value = supplier.contact || '';
                    document.getElementById('edit-supplier-phone').value = supplier.phone || '';
                    document.getElementById('edit-supplier-address').value = supplier.address || '';
                    document.getElementById('edit-supplier-taxcode').value = supplier.taxCode || '';
                    elements.editSupplierModal.classList.add('active');
                }
            }
        });

        elements.editSupplierForm.addEventListener('submit', e => {
            e.preventDefault();
            const supplierId = parseInt(document.getElementById('edit-supplier-id').value);
            const reason = document.getElementById('edit-supplier-reason').value;
            const originalSupplier = findById(suppliers, supplierId);
            const updatedSupplier = {
                ...originalSupplier,
                name: document.getElementById('edit-supplier-name').value,
                contact: document.getElementById('edit-supplier-contact').value,
                phone: document.getElementById('edit-supplier-phone').value,
                address: document.getElementById('edit-supplier-address').value,
                taxCode: document.getElementById('edit-supplier-taxcode').value,
            };

            const changes = {};
            for (const key in updatedSupplier) {
                if (updatedSupplier[key] !== originalSupplier[key]) {
                    changes[key] = { from: originalSupplier[key], to: updatedSupplier[key] };
                }
            }

            suppliers = suppliers.map(s => s.id === supplierId ? updatedSupplier : s);
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            
            logAdjustment('log_type_supplier', supplierId, reason, changes);
            
            elements.editSupplierModal.classList.remove('active');
            e.target.reset();
            renderApp();
        });

        elements.cancelEditSupplierBtn.addEventListener('click', () => {
            elements.editSupplierModal.classList.remove('active');
            elements.editSupplierForm.reset();
        });

        elements.purchasesList.addEventListener('click', e => {
            if (e.target.matches('.edit-purchase-btn')) {
                const purchaseId = parseInt(e.target.dataset.id);
                const purchase = findById(purchases, purchaseId);
                const material = findById(rawMaterials, purchase.materialId);
                if (purchase) {
                    document.getElementById('edit-purchase-id').value = purchase.id;
                    document.getElementById('edit-purchase-date').value = purchase.date;
                    document.getElementById('edit-purchase-material-name').textContent = `${material.name} (${material.unit})`;
                    document.getElementById('edit-purchase-quantity').value = purchase.quantity;
                    document.getElementById('edit-purchase-total-price').value = purchase.totalPrice;
                    populateSelect(document.getElementById('edit-purchase-supplier-select'), suppliers, 'select_supplier', purchase.supplierId);
                    elements.editPurchaseModal.classList.add('active');
                }
            }
        });

        elements.editPurchaseForm.addEventListener('submit', e => {
            e.preventDefault();
            const purchaseId = parseInt(document.getElementById('edit-purchase-id').value);
            const reason = document.getElementById('edit-purchase-reason').value;
            const originalPurchase = findById(purchases, purchaseId);
            const updatedPurchase = {
                ...originalPurchase,
                date: document.getElementById('edit-purchase-date').value,
                quantity: parseFloat(document.getElementById('edit-purchase-quantity').value),
                totalPrice: parseFloat(document.getElementById('edit-purchase-total-price').value),
                supplierId: parseInt(document.getElementById('edit-purchase-supplier-select').value),
            };
            updatedPurchase.unitPrice = updatedPurchase.totalPrice / updatedPurchase.quantity;

            const changes = {};
             for (const key in updatedPurchase) {
                if (key !== 'unitPrice' && updatedPurchase[key] !== originalPurchase[key]) {
                    changes[key] = { from: originalPurchase[key], to: updatedPurchase[key] };
                }
            }
            if (updatedPurchase.unitPrice !== originalPurchase.unitPrice) {
                 changes['unitPrice'] = { from: formatCurrency(originalPurchase.unitPrice), to: formatCurrency(updatedPurchase.unitPrice) };
            }

            purchases = purchases.map(p => p.id === purchaseId ? updatedPurchase : p);
            localStorage.setItem('purchases', JSON.stringify(purchases));

            const material = findById(rawMaterials, originalPurchase.materialId);
            const logType = `${translations[currentLang].log_type_purchase}: ${material.name}`;
            logAdjustment(logType, purchaseId, reason, changes);
            
            updateAllMaterialPrices();
            recalculateAllDishCosts();

            elements.editPurchaseModal.classList.remove('active');
            e.target.reset();
            renderApp();
        });

        elements.cancelEditPurchaseBtn.addEventListener('click', () => {
            elements.editPurchaseModal.classList.remove('active');
            elements.editPurchaseForm.reset();
        });

        function updateAllMaterialPrices() {
            const latestPurchases = {};
            const sortedPurchases = [...purchases].sort((a, b) => new Date(b.date) - new Date(a.date));

            for (const p of sortedPurchases) {
                if (!latestPurchases[p.materialId]) {
                    latestPurchases[p.materialId] = p.unitPrice;
                }
            }

            rawMaterials.forEach(material => {
                material.price = latestPurchases[material.id] || material.price || 0;
            });

            localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
        }

        function renderAdjustmentLogs() {
            renderList(elements.adjustmentLogsList, adjustmentLogs, log => {
                const changesHtml = Object.entries(log.changes).map(([key, value]) => 
                    `<li class="text-xs text-gray-600 ml-4">${key}: "${value.from}" -> "${value.to}"</li>`
                ).join('');

                const logType = translations[currentLang][log.typeKey] || log.typeKey;

                return `
                    <div class="p-3 bg-gray-50 border rounded-md">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-800">${logType}</span>
                            <span class="text-xs text-gray-500">${new Date(log.date).toLocaleString('vi-VN')}</span>
                        </div>
                        <p class="text-sm text-gray-700 mt-1"><strong>${translations[currentLang].adjustment_reason}:</strong> ${log.reason}</p>
                        <ul class="list-disc list-inside mt-1">${changesHtml}</ul>
                    </div>
                `;
            }, "empty_adjustment_logs");
        }

        const suggestDescBtn = document.getElementById('suggest-description-btn');
        suggestDescBtn.addEventListener('click', async () => {
            const dishNameInput = document.getElementById('dish-name');
            const dishDescTextarea = document.getElementById('dish-description');
            if (!dishNameInput.value) {
                alert("Vui lòng nhập tên món ăn trước.");
                return;
            }
            const prompt = `Viết một đoạn mô tả ngắn (dưới 40 từ) thật hấp dẫn cho món ăn Việt Nam có tên là "${dishNameInput.value}". Đây là một món canh tiềm dưỡng sinh, nhấn mạnh yếu tố bổ dưỡng, hương vị đậm đà, và nguyên liệu tự nhiên.`;
            const suggestion = await callGeminiAPI(prompt, suggestDescBtn);
            dishDescTextarea.value = suggestion.replace(/"/g, '');
        });
        
        elements.suggestNameBtn.addEventListener('click', async () => {
            if (currentBomItems.length === 0) {
                alert('Vui lòng thêm ít nhất một nguyên liệu vào BOM để nhận gợi ý tên.');
                return;
            }

            const ingredientNames = currentBomItems.map(item => {
                const material = findById(rawMaterials, item.materialId);
                return material ? material.name : '';
            }).filter(name => name).join(', ');

            const prompt = `Gợi ý 3 tên món ăn tiếng Việt thật hấp dẫn và mang tính dưỡng sinh cho một món canh tiềm có các nguyên liệu chính là: ${ingredientNames}. Chỉ trả về 3 tên, mỗi tên trên một dòng, không có giải thích hay ký tự gạch đầu dòng.`;

            const dishNameSuggestionsDiv = elements.dishNameSuggestions;
            dishNameSuggestionsDiv.innerHTML = `<p class="text-gray-500">${translations[currentLang].thinking}</p>`;

            const suggestionsText = await callGeminiAPI(prompt, elements.suggestNameBtn);

            if (suggestionsText.includes('lỗi') || suggestionsText.includes('error')) {
                dishNameSuggestionsDiv.innerHTML = `<p class="text-red-500">${suggestionsText}</p>`;
            } else {
                const suggestions = suggestionsText.split('\n').filter(s => s.trim() !== '');
                dishNameSuggestionsDiv.innerHTML = `<h4 class="font-semibold mb-1" data-lang="dish_name_suggestions">${translations[currentLang].dish_name_suggestions}</h4>`;
                suggestions.forEach(name => {
                    const suggestionEl = document.createElement('button');
                    suggestionEl.type = 'button';
                    suggestionEl.className = 'block w-full text-left p-2 bg-gray-100 hover:bg-gray-200 rounded mb-1';
                    suggestionEl.textContent = name;
                    suggestionEl.onclick = () => {
                        document.getElementById('dish-name').value = name;
                        dishNameSuggestionsDiv.innerHTML = '';
                    };
                    dishNameSuggestionsDiv.appendChild(suggestionEl);
                });
            }
        });

        const suggestMarketingBtn = document.getElementById('suggest-marketing-btn');
        suggestMarketingBtn.addEventListener('click', async () => {
            const revenue = document.getElementById('result-revenue').textContent;
            const profit = document.getElementById('result-net-profit').textContent;
            const marketingSuggestionsDiv = document.getElementById('marketing-suggestions');
            
            const prompt = `Tôi là chủ một quán ăn nhỏ bán canh tiềm dưỡng sinh tại Việt Nam. Tháng này, tổng doanh thu là ${revenue} và lợi nhuận ròng là ${profit}. Hãy đề xuất 3 ý tưởng marketing ngắn gọn, sáng tạo và dễ thực hiện trên Zalo và Facebook cho tháng tới để thu hút thêm khách hàng. Trình bày dưới dạng danh sách gạch đầu dòng.`;
            
            const suggestions = await callGeminiAPI(prompt, suggestMarketingBtn);
            const formattedSuggestions = suggestions
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => `<p class="mb-2">${line.replace(/(\*|-)\s*/, '<span class="text-green-600 font-bold mr-2">•</span>')}</p>`)
                .join('');
            
            marketingSuggestionsDiv.innerHTML = `<div class="mt-4 p-4 bg-green-50 rounded-lg">${formattedSuggestions}</div>`;
            marketingSuggestionsDiv.classList.remove('hidden');
        });

        elements.analyzeSpoilageBtn.addEventListener('click', async () => {
            if (spoilageRecords.length === 0) {
                alert('Chưa có dữ liệu hư hao để phân tích.');
                return;
            }

            const spoilageData = spoilageRecords.map(r => {
                const material = findById(rawMaterials, r.materialId);
                return `- ${material?.name || 'Không rõ'}: ${r.quantity} ${material?.unit || ''} (Lý do: ${r.reason})`;
            }).join('\n');

            const prompt = `Tôi là chủ một quán canh dưỡng sinh nhỏ. Dưới đây là danh sách nguyên vật liệu bị hư hao trong tháng qua:\n${spoilageData}\n\nDựa vào dữ liệu này, hãy:
1.  Đưa ra 1-2 nhận xét chung về tình hình hư hao.
2.  Đề xuất 2-3 giải pháp cụ thể, thực tế để giảm thiểu lãng phí trong môi trường bếp nhỏ.
Hãy trả lời bằng tiếng Việt, định dạng markdown đơn giản.`;
            
            const analysisResultDiv = elements.spoilageAnalysisResult;
            analysisResultDiv.classList.remove('hidden');
            analysisResultDiv.innerHTML = `<p class="text-gray-500">${translations[currentLang].thinking}</p>`;
            
            const analysisText = await callGeminiAPI(prompt, elements.analyzeSpoilageBtn);

            const formattedText = analysisText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/(\*|-)\s*/g, '<br><span class="text-indigo-600 font-bold mr-2">•</span>');

            analysisResultDiv.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-indigo-800" data-lang="spoilage_analysis_title">${translations[currentLang].spoilage_analysis_title}</h3>
                <div class="p-4 bg-indigo-50 rounded-lg text-sm">${formattedText}</div>
            `;
        });

        function calculateBomCost(bomItems) {
            return bomItems.reduce((total, item) => {
                const material = findById(rawMaterials, item.materialId);
                return total + (material ? material.price * item.quantity : 0);
            }, 0);
        }

        function renderCurrentBomItems() {
            renderList(elements.bomItemsList, currentBomItems, item => {
                const material = findById(rawMaterials, item.materialId);
                return `<div class="flex justify-between items-center text-sm p-1 bg-blue-50 rounded"><span>${material?.name || 'N/A'}</span><span>${item.quantity} ${material?.unit || ''}</span></div>`;
            }, "");
            elements.estimatedCostSpan.textContent = formatCurrency(calculateBomCost(currentBomItems));
        }

        elements.addBomItemBtn.addEventListener('click', () => {
            const materialId = parseInt(elements.bomMaterialSelect.value);
            const quantity = parseFloat(elements.bomQuantityInput.value);
            if (materialId && quantity > 0 && !currentBomItems.some(item => item.materialId === materialId)) {
                currentBomItems.push({ materialId, quantity });
                renderCurrentBomItems();
                elements.bomQuantityInput.value = '';
            }
        });
        
        elements.addDishForm.addEventListener('submit', e => {
            e.preventDefault();
            const newDish = {
                id: Date.now(),
                name: document.getElementById('dish-name').value,
                description: document.getElementById('dish-description').value,
                price: parseFloat(document.getElementById('dish-price').value),
                imageUrl: document.getElementById('dish-image-url').value,
                bom: [...currentBomItems],
                cost: calculateBomCost(currentBomItems)
            };
            dishes.push(newDish);
            localStorage.setItem('dishes', JSON.stringify(dishes));
            
            currentBomItems = [];
            renderCurrentBomItems();
            elements.dishNameSuggestions.innerHTML = ''; // Clear suggestions
            renderApp();
            e.target.reset();
        });

        elements.dishesList.addEventListener('click', e => {
            if (e.target.classList.contains('delete-dish-btn')) {
                const dishId = parseInt(e.target.dataset.id);
                dishes = dishes.filter(d => d.id !== dishId);
                localStorage.setItem('dishes', JSON.stringify(dishes));
                renderApp();
            }
        });

        function recalculateAllDishCosts() {
             dishes.forEach(dish => {
                dish.cost = calculateBomCost(dish.bom);
            });
            localStorage.setItem('dishes', JSON.stringify(dishes));
        }

        const renderDish = (d) => `
            <div class="flex justify-between items-start p-3 bg-gray-50 rounded-md border">
                <div>
                    <p class="font-semibold">${d.name} - ${formatCurrency(d.price)}</p>
                    <p class="text-sm text-gray-500">${translations[currentLang].estimated_cost}: ${formatCurrency(d.cost)}</p>
                </div>
                <button class="delete-dish-btn text-red-500 hover:text-red-700" data-id="${d.id}">${translations[currentLang].delete}</button>
            </div>
        `;

        function migrateCosts() {
            const oldOnetime = JSON.parse(localStorage.getItem('initial-investment-s'));
            const oldMonthly = JSON.parse(localStorage.getItem('monthly-expenses-s'));
            let migrated = false;

            if(oldOnetime && oldOnetime.length > 0) {
                const mapped = oldOnetime.map(c => ({...c, id: Date.now() + Math.random(), frequency: 'onetime'}));
                otherCosts.push(...mapped);
                localStorage.removeItem('initial-investment-s');
                migrated = true;
            }
            if(oldMonthly && oldMonthly.length > 0) {
                const mapped = oldMonthly.map(c => ({...c, id: Date.now() + Math.random(), frequency: 'monthly'}));
                otherCosts.push(...mapped);
                localStorage.removeItem('monthly-expenses-s');
                migrated = true;
            }

            if (migrated) {
                localStorage.setItem('otherCosts', JSON.stringify(otherCosts));
            } else {
                otherCosts = JSON.parse(localStorage.getItem('otherCosts')) || [];
            }
        }

        function renderOtherCosts() {
            const lists = {
                onetime: document.getElementById('onetime-costs-list'),
                monthly: document.getElementById('monthly-costs-list'),
                yearly: document.getElementById('yearly-costs-list'),
            };
            const totals = { onetime: 0, monthly: 0, yearly: 0 };
            Object.values(lists).forEach(list => list.innerHTML = '');

            otherCosts.forEach(cost => {
                if (lists[cost.frequency]) {
                    totals[cost.frequency] += cost.amount;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md text-sm';
                    itemEl.innerHTML = `
                        <span>${cost.name}</span>
                        <div class="flex items-center gap-4">
                        <span>${formatCurrency(cost.amount)}</span>
                        <button class="delete-other-cost-btn text-red-500 hover:text-red-700" data-id="${cost.id}">${translations[currentLang].delete}</button>
                        </div>
                    `;
                    lists[cost.frequency].appendChild(itemEl);
                }
            });

            document.getElementById('total-onetime-costs').textContent = formatCurrency(totals.onetime);
            document.getElementById('total-monthly-costs').textContent = formatCurrency(totals.monthly);
            document.getElementById('total-yearly-costs').textContent = formatCurrency(totals.yearly);
        }

        document.getElementById('add-other-cost-form').addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('other-cost-name').value;
            const amount = parseFloat(document.getElementById('other-cost-amount').value);
            const frequency = document.getElementById('other-cost-frequency').value;
            if (name && amount >= 0) {
                otherCosts.push({ id: Date.now(), name, amount, frequency });
                localStorage.setItem('otherCosts', JSON.stringify(otherCosts));
                renderOtherCosts();
                e.target.reset();
            }
        });

        document.getElementById('cost-management').addEventListener('click', e => {
            if (e.target.classList.contains('delete-other-cost-btn')) {
                const costId = parseFloat(e.target.dataset.id);
                otherCosts = otherCosts.filter(cost => cost.id !== costId);
                localStorage.setItem('otherCosts', JSON.stringify(otherCosts));
                renderOtherCosts();
            }
        });
        
        const renderSpoilageRecord = (r) => {
            const material = findById(rawMaterials, r.materialId);
            const cost = material ? material.price * r.quantity : 0;
            return `
            <div class="text-sm p-2 bg-gray-50 rounded-md border">
                <div class="flex

