<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị - Canh Tiềm Dưỡng Sinh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .tab-content, .modal {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .lang-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .stat-card:hover {
             border-color: var(--status-color, #d1d5db); /* Default to gray-300 */
             transform: translateY(-2px);
             transition: all 0.2s ease-in-out;
        }
        .sidebar-link.active {
            background-color: #4a5568; /* a shade of gray */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="px-8 py-6">
                <h2 class="text-2xl font-semibold" data-lang="dashboard_title">Bảng Điều Khiển</h2>
            </div>
             <!-- Language Switcher -->
            <div class="px-4 py-2">
                <div class="flex bg-gray-700 rounded-lg p-1">
                    <button class="lang-btn flex-1 text-sm py-1 px-2 rounded-md" data-lang-code="vi">Tiếng Việt</button>
                    <button class="lang-btn flex-1 text-sm py-1 px-2 rounded-md" data-lang-code="zh">繁體中文</button>
                </div>
            </div>
            <nav class="flex-1 px-4 py-2 space-y-2 overflow-y-auto">
                <a href="#" class="tab-link active:bg-gray-700 bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="dashboard">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
                    <span data-lang="dashboard_overview">Tổng Quan</span>
                </a>
                 <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="employee-management">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M12 12A3 3 0 1012 6a3 3 0 000 6z" /></svg>
                    <span data-lang="employee_management">Quản Lý Nhân Viên</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="sales-management">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l.383-1.437M7.5 14.25L5.106 5.165A2.25 2.25 0 002.854 3H2.25" />
                    </svg>
                    <span data-lang="order_lookup">Tra Cứu Đơn Hàng</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="menu-management">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <span data-lang="menu_management">Quản Lý Thực Đơn</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="supplier-management">
                     <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                     </svg>
                     <span data-lang="supplier_management">Nhà Cung Cấp</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="purchase-management">
                     <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                     <span data-lang="material_management">Nguyên Vật Liệu</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="spoilage-management">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                    <span data-lang="spoilage_management">Quản Lý Hư Hao</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="cost-management">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 4h4m5 6H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2z"></path></svg>
                    <span data-lang="other_costs">Chi Phí Khác</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="profit-report">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                    <span data-lang="profit_report">Báo Cáo Lợi Nhuận</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="inventory-report">
                    <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-1.621-1.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h4.5M15 3.75a2.25 2.25 0 012.25 2.25V6a2.25 2.25 0 01-2.25 2.25H8.25A2.25 2.25 0 016 6V5.25a2.25 2.25 0 012.25-2.25h4.5M15 3.75h-4.5m0 0a2.25 2.25 0 012.25 2.25V6" />
                    </svg>
                    <span data-lang="inventory_report">Báo Cáo Tồn Kho</span>
                </a>
                <a href="#" class="tab-link hover:bg-gray-700 flex items-center px-4 py-2 rounded-lg" data-tab="adjustment-logs">
                     <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                    </svg>
                    <span data-lang="adjustment_logs">Lịch Sử Điều Chỉnh</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            
            <!-- Tab: Dashboard -->
            <div id="dashboard" class="tab-content active">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="dashboard_overview">Tổng Quan Hôm Nay</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Dashboard cards will be injected here -->
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full mr-4"><svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg></div>
                        <div>
                            <p class="text-sm text-gray-500" data-lang="today_revenue">Doanh thu hôm nay</p>
                            <p id="dashboard-revenue" class="text-2xl font-bold">0 VND</p>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-green-100 p-3 rounded-full mr-4"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div>
                        <div>
                            <p class="text-sm text-gray-500" data-lang="today_orders">Đơn hàng mới</p>
                            <p id="dashboard-orders" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-full mr-4"><svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg></div>
                        <div>
                            <p class="text-sm text-gray-500" data-lang="best_selling_dish">Món bán chạy nhất</p>
                            <p id="dashboard-best-seller" class="text-lg font-bold">N/A</p>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                        <div class="bg-red-100 p-3 rounded-full mr-4"><svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                        <div>
                            <p class="text-sm text-gray-500" data-lang="low_stock_alert">Cảnh báo tồn kho</p>
                            <p id="dashboard-low-stock" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4" data-lang="order_status_distribution">Phân bổ Trạng thái Đơn hàng</h3>
                        <canvas id="orderStatusChart"></canvas>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4" data-lang="recent_activity">Hoạt động Gần đây</h3>
                        <div id="dashboard-recent-activity" class="space-y-3 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

             <!-- Tab: Quản Lý Nhân Viên -->
            <div id="employee-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="employee_management_title">Quản Lý Nhân Viên</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold mb-4" data-lang="add_new_employee">Thêm Nhân Viên Mới</h2>
                            <form id="add-employee-form" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="employee-name" class="block text-sm font-medium text-gray-700" data-lang="employee_name">Họ và Tên</label>
                                        <input type="text" id="employee-name" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                    <div>
                                        <label for="employee-id-code" class="block text-sm font-medium text-gray-700" data-lang="employee_id_code">Mã số nhân viên</label>
                                        <input type="text" id="employee-id-code" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                    <div>
                                        <label for="employee-dob" class="block text-sm font-medium text-gray-700" data-lang="employee_dob">Ngày sinh</label>
                                        <input type="date" id="employee-dob" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3" min="1900-01-01" max="2999-12-31">
                                    </div>
                                    <div>
                                        <label for="employee-nid" class="block text-sm font-medium text-gray-700" data-lang="employee_nid">Số CCCD/CC</label>
                                        <input type="text" id="employee-nid" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                </div>
                                <div>
                                    <label for="employee-photo-url" class="block text-sm font-medium text-gray-700" data-lang="employee_photo_url">URL Hình ảnh</label>
                                    <input type="url" id="employee-photo-url" data-lang-placeholder="employee_photo_url_placeholder" placeholder="https://example.com/photo.jpg" class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                </div>
                                 <div>
                                    <label for="employee-permanent-address" class="block text-sm font-medium text-gray-700" data-lang="employee_permanent_address">Địa chỉ thường trú</label>
                                    <input type="text" id="employee-permanent-address" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                </div>
                                <div>
                                    <label for="employee-current-address" class="block text-sm font-medium text-gray-700" data-lang="employee_current_address">Địa chỉ hiện tại</label>
                                    <input type="text" id="employee-current-address" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                     <div>
                                        <label for="employee-start-date" class="block text-sm font-medium text-gray-700" data-lang="employee_start_date">Ngày nhận việc</label>
                                        <input type="date" id="employee-start-date" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3" min="1900-01-01" max="2999-12-31">
                                    </div>
                                    <div>
                                        <label for="employee-type" class="block text-sm font-medium text-gray-700" data-lang="employee_type">Hình thức làm việc</label>
                                        <select id="employee-type" required class="mt-1 block w-full border-gray-300 rounded-md py-2 px-3">
                                            <option value="part-time" data-lang="employee_type_part_time">Bán thời gian</option>
                                            <option value="contract" data-lang="employee_type_contract">Hợp đồng lao động</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700" data-lang="roles">Vai trò</label>
                                    <div id="employee-roles-checkboxes" class="mt-2 space-y-2">
                                        <!-- Checkboxes will be inserted here by JS -->
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700" data-lang="add_employee_btn">Thêm Nhân Viên</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold mb-4" data-lang="employee_list">Danh Sách Nhân Viên</h2>
                            <div id="employees-list" class="space-y-4 max-h-[80vh] overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Tra Cứu Đơn Hàng -->
            <div id="sales-management" class="tab-content">
                 <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="order_lookup_title">Tra Cứu Đơn Hàng</h1>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <!-- Filters -->
                    <div class="flex flex-wrap items-center gap-4 mb-6 pb-6 border-b">
                        <div>
                            <label for="order-lookup-preset-filter" class="block text-sm font-medium text-gray-700" data-lang="view_by">Xem theo</label>
                            <select id="order-lookup-preset-filter" class="mt-1 block w-full md:w-auto border-gray-300 rounded-md shadow-sm">
                                <option value="this_month" data-lang="this_month">Tháng này</option>
                                <option value="this_quarter" data-lang="this_quarter">Quí này</option>
                                <option value="this_year" data-lang="this_year">Năm này</option>
                                <option value="custom" data-lang="custom_option">Tùy chọn</option>
                            </select>
                        </div>
                        <div>
                            <label for="order-lookup-start-date" class="block text-sm font-medium text-gray-700" data-lang="from_date">Từ ngày</label>
                            <input type="date" id="order-lookup-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" min="1900-01-01" max="2999-12-31">
                        </div>
                        <div>
                            <label for="order-lookup-end-date" class="block text-sm font-medium text-gray-700" data-lang="to_date">Đến ngày</label>
                            <input type="date" id="order-lookup-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" min="1900-01-01" max="2999-12-31">
                        </div>
                        <div class="self-end">
                            <button id="order-lookup-btn" class="bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700" data-lang="search_btn">Tra cứu</button>
                        </div>
                    </div>
                    
                    <!-- Statistics Section -->
                    <div id="order-stats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <!-- Stat cards will be injected here by JS -->
                    </div>

                    <!-- Order Details Section -->
                    <div id="order-details-container" class="mt-8">
                         <h3 id="order-details-title" class="text-xl font-semibold mb-4 hidden"></h3>
                         <div id="order-details-list" class="space-y-3 max-h-[50vh] overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Quản Lý Thực Đơn -->
            <div id="menu-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="menu_management_title">Quản Lý Thực Đơn &amp; Định Lượng (BOM)</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Form thêm món ăn -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="add_new_dish">Thêm Món Mới</h2>
                        <form id="add-dish-form" class="space-y-4">
                            <!-- Basic Info -->
                            <div>
                                <label for="dish-name" class="block text-sm font-medium text-gray-700" data-lang="dish_name">Tên món</label>
                                <input type="text" id="dish-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <div>
                                <label for="dish-description" class="block text-sm font-medium text-gray-700" data-lang="description">Mô tả</label>
                                <textarea id="dish-description" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                            </div>
                            <div>
                                <label for="dish-price" class="block text-sm font-medium text-gray-700" data-lang="selling_price">Giá Bán (VND)</label>
                                <input type="number" id="dish-price" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                             <div>
                                <label for="dish-image-url" class="block text-sm font-medium text-gray-700" data-lang="image_url">URL Hình ảnh</label>
                                <input type="text" id="dish-image-url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                            </div>
                            <!-- BOM Section -->
                            <div class="pt-4 border-t">
                                <h3 class="text-lg font-medium text-gray-800 mb-2" data-lang="bom_title">Định Lượng Nguyên Liệu (BOM)</h3>
                                <div class="flex gap-2 items-center">
                                    <select id="bom-material-select" class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3"></select>
                                    <input type="number" id="bom-quantity" data-lang-placeholder="quantity_short" placeholder="SL" class="w-20 border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <button type="button" id="add-bom-item-btn" class="bg-gray-600 text-white px-3 py-2 rounded-md hover:bg-gray-700">+</button>
                                </div>
                                <div id="bom-items-list" class="mt-2 space-y-1"></div>
                                <div class="mt-2 font-semibold text-right"><span data-lang="estimated_cost">Giá vốn ước tính</span>: <span id="estimated-cost">0 VND</span></div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700" data-lang="add_dish_btn">Thêm Món</button>
                        </form>
                    </div>
                    <!-- Danh sách món ăn -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="current_dishes_list">Danh Sách Món Ăn Hiện Có</h2>
                        <div id="dishes-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Quản Lý Nhà Cung Cấp -->
            <div id="supplier-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="supplier_management_title">Quản Lý Nhà Cung Cấp</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                             <h3 class="text-lg font-medium mb-2" data-lang="add_new_supplier">Thêm NCC Mới</h3>
                             <form id="add-supplier-form" class="space-y-4">
                                <input type="text" id="supplier-name" data-lang-placeholder="supplier_name" placeholder="Tên nhà cung cấp" required class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <input type="text" id="supplier-contact" data-lang-placeholder="contact_person" placeholder="Người liên hệ" class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <input type="tel" id="supplier-phone" data-lang-placeholder="phone_number" placeholder="Số điện thoại" class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <input type="text" id="supplier-address" data-lang-placeholder="address" placeholder="Địa chỉ" class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <input type="text" id="supplier-taxcode" data-lang-placeholder="tax_code" placeholder="Mã số thuế (nếu có)" class="block w-full border-gray-300 rounded-md py-2 px-3">
                                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700" data-lang="add_supplier_btn">Thêm NCC</button>
                            </form>
                        </div>
                        <div class="lg:col-span-2">
                             <h3 class="text-lg font-medium mb-2" data-lang="suppliers_list_title">Danh Sách Nhà Cung Cấp</h3>
                             <div id="suppliers-list" class="mt-4 space-y-3 max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Nguyên Vật Liệu Mua Vào -->
            <div id="purchase-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="purchase_management_title">Nguyên Vật Liệu & Nhập Kho</h1>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Column 1: Category Management -->
                    <div class="space-y-6 bg-white p-6 rounded-lg shadow-md">
                        <div>
                            <h3 class="text-lg font-medium mb-2" data-lang="material_categories">Phân loại Nguyên vật liệu</h3>
                            <form id="add-category-form" class="flex gap-2 mb-4">
                                <input type="text" id="category-name" data-lang-placeholder="category_name_placeholder" placeholder="Tên phân loại mới" required class="flex-grow border border-gray-300 rounded-md py-2 px-3">
                                <button type="submit" class="bg-indigo-600 text-white px-4 rounded-md hover:bg-indigo-700" data-lang="add_btn">Thêm</button>
                            </form>
                            <div id="material-categories-list" class="space-y-2 max-h-[200px] overflow-y-auto"></div>
                        </div>
                        <div class="border-t pt-4">
                            <h3 class="text-lg font-medium mb-2" data-lang="define_material">Định Nghĩa Nguyên Vật Liệu</h3>
                            <form id="add-material-form" class="space-y-4">
                                <input type="text" id="material-name" data-lang-placeholder="material_name" placeholder="Tên nguyên liệu" required class="w-full border border-gray-300 rounded-md py-2 px-3">
                                <input type="text" id="material-unit" data-lang-placeholder="unit_placeholder" placeholder="Đơn vị (kg, gr, cái)" required class="w-full border border-gray-300 rounded-md py-2 px-3">
                                <select id="material-category-select" class="w-full border border-gray-300 rounded-md py-2 px-3"></select>
                                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700" data-lang="add_btn">Thêm Nguyên Liệu</button>
                            </form>
                        </div>
                    </div>

                    <!-- Column 2: Materials List & Purchase History -->
                     <div class="space-y-6 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-medium mb-2" data-lang="materials_list_title">Danh Sách Nguyên Vật Liệu</h3>
                        <input type="text" id="search-material-input" data-lang-placeholder="search_material_placeholder" placeholder="Tìm kiếm nguyên vật liệu..." class="w-full border border-gray-300 rounded-md py-2 px-3 mb-4">
                        <div id="materials-list" class="space-y-4 max-h-[65vh] overflow-y-auto"></div>
                    </div>

                    <!-- Column 3: Record Purchases -->
                    <div class="space-y-6 bg-white p-6 rounded-lg shadow-md">
                        <div>
                            <h3 class="text-lg font-medium mb-2" data-lang="record_purchase">Nhập Kho</h3>
                            <form id="add-purchase-form" class="space-y-4 p-4 border rounded-md">
                                <div>
                                    <label class="block text-sm font-medium" data-lang="purchase_date">Ngày nhập hàng</label>
                                    <input type="date" id="purchase-date" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3" min="1900-01-01" max="2999-12-31">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium" data-lang="material">Nguyên liệu</label>
                                    <select id="purchase-material-select" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"></select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium" data-lang="quantity">Số lượng</label>
                                        <input type="number" id="purchase-quantity" min="0" step="any" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium" data-lang="unit">Đơn vị</label>
                                        <input type="text" id="purchase-unit" readonly class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md py-2 px-3">
                                    </div>
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium" data-lang="total_price">Tổng tiền (VND)</label>
                                    <input type="number" id="purchase-total-price" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium" data-lang="supplier">Nhà cung cấp</label>
                                    <select id="purchase-supplier-select" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"></select>
                                </div>
                                <p class="text-right"><span data-lang="new_unit_price_label">Đơn giá mới sẽ là</span>: <span id="new-unit-price" class="font-semibold">0 VND</span></p>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700" data-lang="confirm_purchase_btn">Xác Nhận Nhập Kho</button>
                            </form>
                        </div>
                         <div class="border-t pt-4">
                             <h3 class="text-lg font-semibold mb-2" data-lang="purchase_history_title">Lịch Sử Nhập Kho</h3>
                             <div id="purchases-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                         </div>
                    </div>
                </div>
            </div>

             <!-- Tab: Quản Lý Hư Hao -->
            <div id="spoilage-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="spoilage_management_title">Quản Lý Nguyên Vật Liệu Hư Hao</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Form for adding spoilage -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="record_spoilage">Ghi Nhận Hư Hao</h2>
                        <form id="add-spoilage-form" class="space-y-4">
                            <div>
                                <label for="spoilage-date" class="block text-sm font-medium text-gray-700" data-lang="spoilage_date">Ngày thải bỏ</label>
                                <input type="date" id="spoilage-date" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3" min="1900-01-01" max="2999-12-31">
                            </div>
                            <div>
                                <label for="spoilage-material-select" class="block text-sm font-medium text-gray-700" data-lang="material">Nguyên liệu</label>
                                <select id="spoilage-material-select" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="spoilage-quantity" class="block text-sm font-medium text-gray-700" data-lang="quantity">Số lượng</label>
                                    <input type="number" id="spoilage-quantity" min="0" step="any" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700" data-lang="unit">Đơn vị tính</label>
                                    <input type="text" id="spoilage-unit" readonly class="mt-1 block w-full bg-gray-100 border border-gray-300 rounded-md py-2 px-3">
                                </div>
                            </div>
                             <div>
                                <label for="spoilage-reason" class="block text-sm font-medium text-gray-700" data-lang="spoilage_reason">Nguyên nhân thải bỏ</label>
                                <input type="text" id="spoilage-reason" required data-lang-placeholder="spoilage_reason_placeholder" placeholder="VD: Hết hạn, hỏng..." class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                            </div>
                            <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700" data-lang="record_btn">Ghi Nhận</button>
                        </form>
                    </div>
                    <!-- List of spoilage records -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="spoilage_history_title">Lịch Sử Hư Hao</h2>
                        <div id="spoilage-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Chi Phí Khác -->
            <div id="cost-management" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="other_costs_title">Quản Lý Chi Phí Khác</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Add Cost Form -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4" data-lang="add_new_cost">Thêm Chi Phí Mới</h2>
                        <form id="add-other-cost-form" class="space-y-4">
                            <div>
                                <label for="other-cost-name" class="block text-sm font-medium text-gray-700" data-lang="cost_name">Tên chi phí</label>
                                <input type="text" id="other-cost-name" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                            </div>
                            <div>
                                <label for="other-cost-amount" class="block text-sm font-medium text-gray-700" data-lang="amount">Số tiền (VND)</label>
                                <input type="number" id="other-cost-amount" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                            </div>
                            <div>
                                <label for="other-cost-frequency" class="block text-sm font-medium text-gray-700" data-lang="cost_type">Loại chi phí</label>
                                <select id="other-cost-frequency" required class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                                    <option value="monthly" data-lang="monthly">Hàng tháng</option>
                                    <option value="yearly" data-lang="yearly">Hàng năm</option>
                                    <option value="onetime" data-lang="onetime">Một lần (Đầu tư)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700" data-lang="add_cost_btn">Thêm Chi Phí</button>
                        </form>
                    </div>
                    <!-- Display Costs -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3" data-lang="monthly_costs">Chi phí hàng tháng</h3>
                            <div id="monthly-costs-list" class="space-y-2"></div>
                            <div class="mt-4 pt-4 border-t font-bold flex justify-between">
                                <span data-lang="total_monthly">Tổng cộng tháng:</span><span id="total-monthly-costs">0 VND</span>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3" data-lang="yearly_costs">Chi phí hàng năm</h3>
                            <div id="yearly-costs-list" class="space-y-2"></div>
                             <div class="mt-4 pt-4 border-t font-bold flex justify-between">
                                <span data-lang="total_yearly">Tổng cộng năm:</span><span id="total-yearly-costs">0 VND</span>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3" data-lang="onetime_costs">Chi phí một lần (Đầu tư)</h3>
                            <div id="onetime-costs-list" class="space-y-2"></div>
                             <div class="mt-4 pt-4 border-t font-bold flex justify-between">
                                <span data-lang="total">Tổng cộng:</span><span id="total-onetime-costs">0 VND</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Báo Cáo Lợi Nhuận -->
            <div id="profit-report" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="profit_report_title">Báo Cáo Lợi Nhuận</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-wrap items-center gap-4 mb-6 pb-6 border-b">
                         <div>
                            <label for="profit-report-preset-filter" class="block text-sm font-medium text-gray-700" data-lang="view_by">Xem theo</label>
                            <select id="profit-report-preset-filter" class="mt-1 block w-full md:w-auto border-gray-300 rounded-md shadow-sm">
                                <option value="this_month" data-lang="this_month">Tháng này</option>
                                <option value="this_quarter" data-lang="this_quarter">Quí này</option>
                                <option value="this_year" data-lang="this_year">Năm này</option>
                                <option value="custom" data-lang="custom_option">Tùy chọn</option>
                            </select>
                        </div>
                        <div>
                            <label for="profit-report-start-date" class="block text-sm font-medium text-gray-700" data-lang="from_date">Từ ngày</label>
                            <input type="date" id="profit-report-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" min="1900-01-01" max="2999-12-31">
                        </div>
                        <div>
                            <label for="profit-report-end-date" class="block text-sm font-medium text-gray-700" data-lang="to_date">Đến ngày</label>
                            <input type="date" id="profit-report-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" min="1900-01-01" max="2999-12-31">
                        </div>
                        <div class="self-end">
                            <button id="calculate-profit-btn" class="w-full bg-green-600 text-white py-2 px-5 rounded-md hover:bg-green-700" data-lang="calculate_profit_btn">Xem Báo Cáo</button>
                        </div>
                    </div>
                    <div id="profit-results" class="mt-8 pt-6 border-t hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <h3 class="text-2xl font-semibold mb-4 text-center" data-lang="business_results_period">Kết Quả Kinh Doanh Trong Kỳ</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg">
                                    <div class="bg-blue-50 p-4 rounded-md"><p class="text-gray-600" data-lang="total_revenue">Tổng Doanh Thu:</p><p id="result-revenue" class="font-bold text-2xl text-blue-700">0 VND</p></div>
                                    <div class="bg-orange-50 p-4 rounded-md"><p class="text-gray-600" data-lang="total_cogs">Tổng Giá Vốn Hàng Bán:</p><p id="result-cogs" class="font-bold text-2xl text-orange-700">0 VND</p></div>
                                     <div class="bg-red-50 p-4 rounded-md"><p class="text-gray-600" data-lang="total_commission_fees">Tổng Phí Chiết Khấu:</p><p id="result-commission-fees" class="font-bold text-2xl text-red-700">0 VND</p></div>
                                    <div class="bg-yellow-50 p-4 rounded-md"><p class="text-gray-600" data-lang="total_operating_expenses">Tổng Chi Phí Hoạt Động (Tháng):</p><p id="result-monthly-expense" class="font-bold text-2xl text-yellow-700">0 VND</p></div>
                                    <div class="bg-red-100 p-4 rounded-md"><p class="text-gray-600" data-lang="spoilage_cost">Chi Phí Hư Hao (Ước Tính):</p><p id="result-spoilage-cost" class="font-bold text-2xl text-red-800">0 VND</p></div>
                                    <div class="bg-green-100 p-4 rounded-md"><p class="text-gray-600" data-lang="net_profit">Lợi Nhuận Ròng (Trước Thuế):</p><p id="result-net-profit" class="font-bold text-3xl text-green-800">0 VND</p></div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4" data-lang="revenue_structure">Cơ cấu doanh thu</h3>
                                <canvas id="revenueStructureChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Báo Cáo Tồn Kho -->
            <div id="inventory-report" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="inventory_report_title">Báo Cáo Xuất Nhập Tồn Nguyên Liệu</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-wrap items-center gap-4 mb-6 pb-6 border-b">
                        <div>
                            <label for="report-preset-filter" class="block text-sm font-medium text-gray-700" data-lang="view_by">Xem theo</label>
                            <select id="report-preset-filter" class="mt-1 block w-full md:w-auto border-gray-300 rounded-md shadow-sm">
                                <option value="this_month" data-lang="this_month">Tháng này</option>
                                <option value="this_quarter" data-lang="this_quarter">Quí này</option>
                                <option value="this_year" data-lang="this_year">Năm này</option>
                                <option value="custom" data-lang="custom_option">Tùy chọn</option>
                            </select>
                        </div>
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium text-gray-700" data-lang="from_date">Từ ngày</label>
                            <input type="date" id="report-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" min="1900-01-01" max="2999-12-31">
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium text-gray-700" data-lang="to_date">Đến ngày</label>
                            <input type="date" id="report-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" min="1900-01-01" max="2999-12-31">
                        </div>
                        <div class="self-end">
                            <button id="view-inventory-report-btn" class="bg-blue-600 text-white py-2 px-5 rounded-md hover:bg-blue-700" data-lang="view_report_btn">Xem Báo Cáo</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="material_name_header">Tên Nguyên Liệu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="unit_header">ĐVT</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="opening_stock">Tồn Đầu Kỳ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="purchased_in_period">Nhập Trong Kỳ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="used_in_period">Xuất Trong Kỳ (Bán)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="spoiled_in_period">Hư Hao Trong Kỳ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-lang="closing_stock">Tồn Cuối Kỳ</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-report-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: Lịch sử điều chỉnh -->
            <div id="adjustment-logs" class="tab-content">
                <h1 class="text-3xl font-bold text-gray-800 mb-6" data-lang="adjustment_logs_title">Lịch Sử Điều Chỉnh Dữ Liệu</h1>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="adjustment-logs-list" class="space-y-4"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <div id="employee-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center overflow-y-auto p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4" data-lang="employee_details_title">Thông Tin Chi Tiết Nhân Viên</h2>
            <div id="employee-modal-content" class="overflow-y-auto pr-2">
                <!-- Details will be injected here -->
            </div>
             <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                <button type="button" id="close-employee-modal-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md" data-lang="cancel_btn">Đóng</button>
            </div>
        </div>
    </div>
     <div id="edit-supplier-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4" data-lang="edit_supplier_title">Điều Chỉnh Thông Tin Nhà Cung Cấp</h2>
            <form id="edit-supplier-form" class="space-y-4">
                <input type="hidden" id="edit-supplier-id">
                <input type="text" id="edit-supplier-name" data-lang-placeholder="supplier_name" required class="block w-full border-gray-300 rounded-md py-2 px-3">
                <input type="text" id="edit-supplier-contact" data-lang-placeholder="contact_person" class="block w-full border-gray-300 rounded-md py-2 px-3">
                <input type="tel" id="edit-supplier-phone" data-lang-placeholder="phone_number" class="block w-full border-gray-300 rounded-md py-2 px-3">
                <input type="text" id="edit-supplier-address" data-lang-placeholder="address" class="block w-full border-gray-300 rounded-md py-2 px-3">
                <input type="text" id="edit-supplier-taxcode" data-lang-placeholder="tax_code" class="block w-full border-gray-300 rounded-md py-2 px-3">
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-supplier-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md" data-lang="cancel_btn">Hủy</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md" data-lang="save_changes_btn">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>
    <div id="edit-purchase-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <!-- ... (Modal content unchanged) ... -->
    </div>

    <!-- Edit Dish Modal -->
    <div id="edit-dish-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4" data-lang="edit_dish_title">Điều Chỉnh Thông Tin Món Ăn</h2>
            <form id="edit-dish-form" class="space-y-4 overflow-y-auto pr-2">
                <input type="hidden" id="edit-dish-id">
                <!-- Basic Info -->
                <div>
                    <label for="edit-dish-name" class="block text-sm font-medium text-gray-700" data-lang="dish_name">Tên món</label>
                    <input type="text" id="edit-dish-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <div>
                    <label for="edit-dish-description" class="block text-sm font-medium text-gray-700" data-lang="description">Mô tả</label>
                    <textarea id="edit-dish-description" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea>
                </div>
                <div>
                    <label for="edit-dish-image-url" class="block text-sm font-medium text-gray-700" data-lang="image_url">URL Hình ảnh</label>
                    <input type="text" id="edit-dish-image-url" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                </div>
                <!-- Pricing -->
                <div class="pt-4 border-t grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="edit-dish-price" class="block text-sm font-medium text-gray-700" data-lang="selling_price">Giá Bán Hiện Tại</label>
                        <input type="number" id="edit-dish-price" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    </div>
                     <div>
                        <label for="edit-dish-price-effective-date" class="block text-sm font-medium text-gray-700" data-lang="price_effective_date">Ngày Áp Dụng Giá Mới</label>
                        <input type="date" id="edit-dish-price-effective-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" min="1900-01-01" max="2999-12-31">
                    </div>
                </div>
                <!-- BOM Section -->
                <div class="pt-4 border-t">
                    <h3 class="text-lg font-medium text-gray-800 mb-2" data-lang="bom_title">Định Lượng Nguyên Liệu (BOM)</h3>
                    <div class="flex gap-2 items-center">
                        <select id="edit-bom-material-select" class="flex-grow border border-gray-300 rounded-md shadow-sm py-2 px-3"></select>
                        <input type="number" id="edit-bom-quantity" data-lang-placeholder="quantity_short" placeholder="SL" class="w-20 border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        <button type="button" id="edit-add-bom-item-btn" class="bg-gray-600 text-white px-3 py-2 rounded-md hover:bg-gray-700">+</button>
                    </div>
                    <div id="edit-bom-items-list" class="mt-2 space-y-1"></div>
                    <div class="mt-2 font-semibold text-right"><span data-lang="estimated_cost">Giá vốn ước tính</span>: <span id="edit-estimated-cost">0 VND</span></div>
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="adjustment_reason">Lý do điều chỉnh</label>
                    <textarea id="edit-dish-reason" required rows="2" class="mt-1 w-full border-gray-300 rounded-md py-2 px-3"></textarea>
                </div>
            </form>
             <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                <button type="button" id="cancel-edit-dish" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md" data-lang="cancel_btn">Hủy</button>
                <button type="submit" form="edit-dish-form" class="bg-blue-600 text-white px-4 py-2 rounded-md" data-lang="save_changes_btn">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Material Modal -->
    <div id="edit-material-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4" data-lang="edit_material_title">Điều Chỉnh Thông Tin Nguyên Vật Liệu</h2>
            <form id="edit-material-form" class="space-y-4">
                <input type="hidden" id="edit-material-id">
                 <div>
                    <label class="block text-sm font-medium" data-lang="material_name">Tên nguyên liệu</label>
                    <input type="text" id="edit-material-name" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="unit">Đơn vị</label>
                    <input type="text" id="edit-material-unit" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div>
                    <label class="block text-sm font-medium" data-lang="category">Phân loại</label>
                    <select id="edit-material-category-select" class="w-full border border-gray-300 rounded-md py-2 px-3"></select>
                </div>
                 <div>
                    <label class="block text-sm font-medium" data-lang="adjustment_reason">Lý do điều chỉnh</label>
                    <textarea id="edit-material-reason" required rows="2" class="mt-1 w-full border-gray-300 rounded-md py-2 px-3"></textarea>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-material" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md" data-lang="cancel_btn">Hủy</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md" data-lang="save_changes_btn">Lưu Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>

     <!-- Edit Category Modal -->
    <div id="edit-category-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4" data-lang="edit_category_title">Chỉnh Sửa Phân Loại</h2>
            <form id="edit-category-form" class="space-y-4">
                <input type="hidden" id="edit-category-id">
                <div>
                    <label class="block text-sm font-medium" data-lang="category_name">Tên phân loại</label>
                    <input type="text" id="edit-category-name" required class="mt-1 w-full border-gray-300 rounded-md py-2 px-3">
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-category" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md" data-lang="cancel_btn">Hủy</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md" data-lang="save_changes_btn">Lưu</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="confirmation-title" class="text-xl font-bold mb-4">Xác nhận</h2>
            <p id="confirmation-message" class="mb-6">Bạn có chắc chắn muốn thực hiện hành động này?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md">Hủy</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-4 py-2 rounded-md">Đồng ý</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        const translations = {
            vi: {
                dashboard_title: 'Bảng Điều Khiển',
                dashboard_overview: 'Tổng Quan',
                today_revenue: 'Doanh thu hôm nay',
                today_orders: 'Đơn hàng mới',
                best_selling_dish: 'Món bán chạy nhất',
                low_stock_alert: 'Cảnh báo tồn kho',
                order_status_distribution: 'Phân bổ Trạng thái Đơn hàng',
                recent_activity: 'Hoạt động Gần đây',
                employee_management: 'Quản Lý Nhân Viên',
                order_lookup: 'Tra Cứu Đơn Hàng',
                menu_management: 'Quản Lý Thực Đơn',
                supplier_management: 'Nhà Cung Cấp',
                material_management: 'Nguyên Vật Liệu',
                spoilage_management: 'Quản Lý Hư Hao',
                other_costs: 'Chi Phí Khác',
                profit_report: 'Báo Cáo Lợi Nhuận',
                inventory_report: 'Báo Cáo Tồn Kho',
                adjustment_logs: 'Lịch Sử Điều Chỉnh',
                employee_management_title: 'Quản Lý Nhân Viên',
                add_new_employee: 'Thêm Nhân Viên Mới',
                employee_id_code: 'Mã số nhân viên',
                employee_name: 'Họ và Tên',
                employee_dob: 'Ngày sinh',
                employee_nid: 'Số CCCD/CC',
                employee_photo_url: 'URL Hình ảnh',
                employee_photo_url_placeholder: 'https://example.com/photo.jpg',
                employee_permanent_address: 'Địa chỉ thường trú',
                employee_current_address: 'Địa chỉ hiện tại',
                employee_start_date: 'Ngày nhận việc',
                employee_type: 'Hình thức làm việc',
                employee_type_part_time: 'Bán thời gian',
                employee_type_contract: 'Hợp đồng lao động',
                roles: 'Vai trò',
                add_employee_btn: 'Thêm Nhân Viên',
                employee_list: 'Danh Sách Nhân Viên',
                employee_details_title: 'Thông Tin Chi Tiết Nhân Viên',
                terminate_employee_btn: 'Thôi việc',
                terminate_employee_title: 'Chấm Dứt Hợp Đồng',
                termination_date: 'Ngày thôi việc',
                termination_reason: 'Lý do thôi việc',
                confirm_termination_btn: 'Xác nhận thôi việc',
                employee_status: 'Trạng thái',
                status_active: 'Đang làm việc',
                status_terminated: 'Đã thôi việc',
                view_details: 'Xem chi tiết',
                role_taker: 'Nhận Đơn',
                role_kitchen: 'Bếp',
                role_shipper: 'Giao Hàng',
                order_lookup_title: 'Tra Cứu Đơn Hàng',
                view_by: 'Xem theo',
                this_month: 'Tháng này',
                this_quarter: 'Quí này',
                this_year: 'Năm này',
                custom_option: 'Tùy chọn',
                from_date: 'Từ ngày',
                to_date: 'Đến ngày',
                search_btn: 'Tra cứu',
                order_list: 'Danh sách Đơn Hàng',
                status_new: 'Đơn mới',
                status_preparing: 'Đang chuẩn bị',
                status_delivering: 'Đang giao',
                status_completed: 'Hoàn thành',
                status_cancelled: 'Đã hủy',
                menu_management_title: 'Quản Lý Thực Đơn & Định Lượng (BOM)',
                add_new_dish: 'Thêm Món Mới',
                dish_name: 'Tên món',
                description: 'Mô tả',
                selling_price: 'Giá Bán (VND)',
                image_url: 'URL Hình ảnh',
                bom_title: 'Định Lượng Nguyên Liệu (BOM)',
                quantity_short: 'SL',
                estimated_cost: 'Giá vốn ước tính',
                add_dish_btn: 'Thêm Món',
                current_dishes_list: 'Danh Sách Món Ăn Hiện Có',
                supplier_management_title: 'Quản Lý Nhà Cung Cấp',
                add_new_supplier: 'Thêm NCC Mới',
                supplier_name: 'Tên nhà cung cấp',
                contact_person: 'Người liên hệ',
                phone_number: 'Số điện thoại',
                address: 'Địa chỉ',
                tax_code: 'Mã số thuế (nếu có)',
                add_supplier_btn: 'Thêm NCC',
                suppliers_list_title: 'Danh Sách Nhà Cung Cấp',
                purchase_management_title: 'Nguyên Vật Liệu & Nhập Kho',
                define_material: 'Định Nghĩa Nguyên Vật Liệu',
                material_name: 'Tên nguyên liệu',
                unit_placeholder: 'Đơn vị (kg, gr, cái)',
                add_btn: 'Thêm',
                materials_list_title: 'Danh Sách Nguyên Vật Liệu',
                record_purchase: 'Nhập Kho',
                purchase_date: 'Ngày nhập hàng',
                material: 'Nguyên liệu',
                quantity: 'Số lượng',
                unit: 'Đơn vị',
                total_price: 'Tổng tiền (VND)',
                supplier: 'Nhà cung cấp',
                new_unit_price_label: 'Đơn giá mới sẽ là',
                confirm_purchase_btn: 'Xác Nhận Nhập Kho',
                purchase_history_title: 'Lịch Sử Nhập Kho',
                spoilage_management_title: 'Quản Lý Nguyên Vật Liệu Hư Hao',
                record_spoilage: 'Ghi Nhận Hư Hao',
                spoilage_date: 'Ngày thải bỏ',
                spoilage_reason: 'Nguyên nhân thải bỏ',
                spoilage_reason_placeholder: 'VD: Hết hạn, hỏng...',
                record_btn: 'Ghi Nhận',
                spoilage_history_title: 'Lịch Sử Hư Hao',
                other_costs_title: 'Quản Lý Chi Phí Khác',
                add_new_cost: 'Thêm Chi Phí Mới',
                cost_name: 'Tên chi phí',
                amount: 'Số tiền (VND)',
                cost_type: 'Loại chi phí',
                monthly: 'Hàng tháng',
                yearly: 'Hàng năm',
                onetime: 'Một lần (Đầu tư)',
                add_cost_btn: 'Thêm Chi Phí',
                monthly_costs: 'Chi phí hàng tháng',
                total_monthly: 'Tổng cộng tháng:',
                yearly_costs: 'Chi phí hàng năm',
                total_yearly: 'Tổng cộng năm:',
                onetime_costs: 'Chi phí một lần (Đầu tư)',
                total: 'Tổng cộng:',
                profit_report_title: 'Báo Cáo Lợi Nhuận',
                calculate_profit_btn: 'Xem Báo Cáo',
                business_results_period: 'Kết Quả Kinh Doanh Trong Kỳ',
                total_revenue: 'Tổng Doanh Thu:',
                total_cogs: 'Tổng Giá Vốn Hàng Bán:',
                total_commission_fees: 'Tổng Phí Chiết Khấu:',
                total_operating_expenses: 'Tổng Chi Phí Hoạt Động (Tháng):',
                spoilage_cost: 'Chi Phí Hư Hao (Ước Tính):',
                net_profit: 'Lợi Nhuận Ròng (Trước Thuế):',
                revenue_structure: 'Cơ cấu doanh thu',
                inventory_report_title: 'Báo Cáo Xuất Nhập Tồn Nguyên Liệu',
                view_report_btn: 'Xem Báo Cáo',
                material_name_header: 'Tên Nguyên Liệu',
                unit_header: 'ĐVT',
                opening_stock: 'Tồn Đầu Kỳ',
                purchased_in_period: 'Nhập Trong Kỳ',
                used_in_period: 'Xuất Trong Kỳ (Bán)',
                spoiled_in_period: 'Hư Hao Trong Kỳ',
                closing_stock: 'Tồn Cuối Kỳ',
                adjustment_logs_title: 'Lịch Sử Điều Chỉnh Dữ Liệu',
                cancel_btn: 'Hủy',
                save_changes_btn: 'Lưu Thay Đổi',
                edit: 'Sửa',
                delete: 'Xóa',
                empty_data: 'Chưa có dữ liệu.',
                empty_adjustment_logs: 'Chưa có lịch sử điều chỉnh nào.',
                select_material: 'Chọn nguyên liệu',
                select_supplier: 'Chọn NCC',
                log_type_supplier: 'Nhà Cung Cấp',
                log_type_purchase: 'Nhập kho',
                log_type_dish: 'Món Ăn',
                log_type_material: 'Nguyên Vật Liệu',
                edit_supplier_title: 'Điều Chỉnh Thông Tin Nhà Cung Cấp',
                supplier_name_label: 'Tên nhà cung cấp',
                tax_code_label: 'Mã số thuế',
                adjustment_reason: 'Lý do điều chỉnh',
                edit_purchase_title: 'Điều Chỉnh Dữ Liệu Nhập Kho',
                edit_dish_title: 'Điều Chỉnh Thông Tin Món Ăn',
                price_effective_date: 'Ngày Áp Dụng Giá Mới',
                edit_material_title: 'Điều Chỉnh Thông Tin Nguyên Vật Liệu',
                total_time: 'Tổng thời gian',
                duration: 'Thời gian trôi qua',
                material_categories: 'Phân loại Nguyên vật liệu',
                category_name_placeholder: 'Tên phân loại mới',
                search_material_placeholder: 'Tìm kiếm nguyên vật liệu...',
                edit_category_title: 'Chỉnh Sửa Phân Loại',
                category_name: 'Tên phân loại',
                category: 'Phân loại',
                uncategorized: 'Chưa phân loại',
                select_category: 'Chọn phân loại',
            },
            zh: {
                dashboard_title: '儀表板',
                dashboard_overview: '總覽',
                today_revenue: '今日收入',
                today_orders: '新訂單',
                best_selling_dish: '最暢銷菜色',
                low_stock_alert: '低庫存警告',
                order_status_distribution: '訂單狀態分佈',
                recent_activity: '最近活動',
                employee_management: '員工管理',
                order_lookup: '訂單查詢',
                menu_management: '菜單管理',
                supplier_management: '供應商管理',
                material_management: '原料管理',
                spoilage_management: '損耗管理',
                other_costs: '其他費用',
                profit_report: '利潤報告',
                inventory_report: '庫存報告',
                adjustment_logs: '調整日誌',
                employee_management_title: '員工管理',
                add_new_employee: '新增員工',
                employee_id_code: '員工編號',
                employee_name: '姓名',
                employee_dob: '出生日期',
                employee_nid: '身份證號碼',
                employee_photo_url: '照片網址',
                employee_photo_url_placeholder: 'https://example.com/photo.jpg',
                employee_permanent_address: '戶籍地址',
                employee_current_address: '目前地址',
                employee_start_date: '到職日期',
                employee_type: '工作類型',
                employee_type_part_time: '兼職',
                employee_type_contract: '合約',
                roles: '職位',
                add_employee_btn: '新增員工',
                employee_list: '員工列表',
                employee_details_title: '員工詳細資訊',
                terminate_employee_btn: '解僱',
                terminate_employee_title: '終止合約',
                termination_date: '離職日期',
                termination_reason: '離職原因',
                confirm_termination_btn: '確認解僱',
                employee_status: '狀態',
                status_active: '在職',
                status_terminated: '已離職',
                view_details: '查看詳情',
                role_taker: '接單員',
                role_kitchen: '廚房',
                role_shipper: '外送員',
                order_lookup_title: '訂單查詢',
                view_by: '查看方式',
                this_month: '本月',
                this_quarter: '本季',
                this_year: '本年',
                custom_option: '自訂',
                from_date: '從日期',
                to_date: '到日期',
                search_btn: '查詢',
                order_list: '訂單列表',
                status_new: '新訂單',
                status_preparing: '準備中',
                status_delivering: '配送中',
                status_completed: '已完成',
                status_cancelled: '已取消',
                menu_management_title: '菜單與物料清單(BOM)管理',
                add_new_dish: '新增菜色',
                dish_name: '菜色名稱',
                description: '描述',
                selling_price: '售價 (VND)',
                image_url: '圖片網址',
                bom_title: '原料物料清單 (BOM)',
                quantity_short: '數量',
                estimated_cost: '預估成本',
                add_dish_btn: '新增菜色',
                current_dishes_list: '現有菜色列表',
                supplier_management_title: '供應商管理',
                add_new_supplier: '新增供應商',
                supplier_name: '供應商名稱',
                contact_person: '聯絡人',
                phone_number: '電話號碼',
                address: '地址',
                tax_code: '稅號',
                add_supplier_btn: '新增供應商',
                suppliers_list_title: '供應商列表',
                purchase_management_title: '原料與進貨管理',
                define_material: '定義原料',
                material_name: '原料名稱',
                unit_placeholder: '單位 (公斤, 克, 個)',
                add_btn: '新增',
                materials_list_title: '原料列表',
                record_purchase: '進貨登錄',
                purchase_date: '進貨日期',
                material: '原料',
                quantity: '數量',
                unit: '單位',
                total_price: '總價 (VND)',
                supplier: '供應商',
                new_unit_price_label: '新單價將是',
                confirm_purchase_btn: '確認進貨',
                purchase_history_title: '進貨歷史',
                spoilage_management_title: '損耗管理',
                record_spoilage: '記錄損耗',
                spoilage_date: '報廢日期',
                spoilage_reason: '報廢原因',
                spoilage_reason_placeholder: '例如：過期、損壞...',
                record_btn: '記錄',
                spoilage_history_title: '損耗歷史',
                other_costs_title: '其他費用管理',
                add_new_cost: '新增費用',
                cost_name: '費用名稱',
                amount: '金額 (VND)',
                cost_type: '費用類型',
                monthly: '每月',
                yearly: '每年',
                onetime: '一次性 (投資)',
                add_cost_btn: '新增費用',
                monthly_costs: '每月費用',
                total_monthly: '本月總計:',
                yearly_costs: '每年費用',
                total_yearly: '本年總計:',
                onetime_costs: '一次性費用 (投資)',
                total: '總計:',
                profit_report_title: '利潤報告',
                calculate_profit_btn: '查看報告',
                business_results_period: '期間經營成果',
                total_revenue: '總收入:',
                total_cogs: '總銷貨成本:',
                total_commission_fees: '總佣金費用:',
                total_operating_expenses: '總營運費用 (月):',
                spoilage_cost: '損耗成本 (預估):',
                net_profit: '淨利 (稅前):',
                revenue_structure: '收入結構',
                inventory_report_title: '原料進銷存報告',
                view_report_btn: '查看報告',
                material_name_header: '原料名稱',
                unit_header: '單位',
                opening_stock: '期初庫存',
                purchased_in_period: '期間進貨',
                used_in_period: '期間銷貨',
                spoiled_in_period: '期間損耗',
                closing_stock: '期末庫存',
                adjustment_logs_title: '資料調整日誌',
                cancel_btn: '取消',
                save_changes_btn: '儲存變更',
                edit: '編輯',
                delete: '刪除',
                empty_data: '尚無資料。',
                empty_adjustment_logs: '尚無調整日誌。',
                select_material: '選擇原料',
                select_supplier: '選擇供應商',
                log_type_supplier: '供應商',
                log_type_purchase: '進貨',
                log_type_dish: '菜色',
                log_type_material: '原料',
                edit_supplier_title: '編輯供應商資訊',
                supplier_name_label: '供應商名稱',
                tax_code_label: '稅號',
                adjustment_reason: '調整原因',
                edit_purchase_title: '編輯進貨資料',
                edit_dish_title: '編輯菜色資訊',
                price_effective_date: '新價格生效日期',
                edit_material_title: '編輯原料資訊',
                total_time: '總時間',
                duration: '經過時間',
                material_categories: '原料分類',
                category_name_placeholder: '新分類名稱',
                search_material_placeholder: '搜尋原料...',
                edit_category_title: '編輯分類',
                category_name: '分類名稱',
                category: '分類',
                uncategorized: '未分類',
                select_category: '選擇分類',
            }
        };

        let currentLang = localStorage.getItem('language') || 'vi';
        
        let salesDataInPeriod = []; // Store filtered sales data globally for this tab
        let editingBomItems = []; // For edit dish modal
        let chartInstances = {}; // To hold chart objects

        // --- Helper Functions ---
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        const findById = (arr, id) => arr.find(item => item.id === parseInt(id));
        const todayISO = () => new Date().toISOString().split('T')[0];
        
        const loadFromStorage = (key, defaultValue = []) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error(`Error parsing ${key} from localStorage`, e);
                return defaultValue;
            }
        };

        const formatDuration = (ms) => {
            if (!ms || ms < 0) return '00:00:00';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        };

        // --- Data Initialization from localStorage ---
        let dishes = loadFromStorage('dishes');
        let rawMaterials = loadFromStorage('rawMaterials');
        let suppliers = loadFromStorage('suppliers');
        let purchases = loadFromStorage('purchases');
        let spoilageRecords = loadFromStorage('spoilageRecords');
        let adjustmentLogs = loadFromStorage('adjustmentLogs');
        let employees = loadFromStorage('employees');
        let otherCosts = loadFromStorage('otherCosts');
        let materialCategories = loadFromStorage('materialCategories');
        let currentBomItems = [];

        const orderStatuses = {
            'new': { name: 'Đơn mới', name_zh: '新訂單', color: '#3B82F6' },
            'preparing': { name: 'Đang chuẩn bị', name_zh: '準備中', color: '#F97316' },
            'delivering': { name: 'Đang giao', name_zh: '配送中', color: '#8B5CF6' },
            'completed': { name: 'Hoàn thành', name_zh: '已完成', color: '#10B981' },
            'cancelled': { name: 'Đã hủy', name_zh: '已取消', color: '#EF4444' }
        };

        const employeeRoles = {
            'taker': { name: 'Nhận Đơn', name_zh: '接單員' },
            'kitchen': { name: 'Bếp', name_zh: '廚房' },
            'shipper': { name: 'Giao Hàng', name_zh: '配送員' }
        };
        
        const employmentTypes = {
            'part-time': {name: 'Bán thời gian', name_zh: '兼職'},
            'contract': {name: 'Hợp đồng lao động', name_zh: '勞動合約'}
        };
        
        // --- DOM Elements ---
        const elements = {
            // Modals
            editDishModal: document.getElementById('edit-dish-modal'),
            editDishForm: document.getElementById('edit-dish-form'),
            cancelEditDishBtn: document.getElementById('cancel-edit-dish'),
            editMaterialModal: document.getElementById('edit-material-modal'),
            editMaterialForm: document.getElementById('edit-material-form'),
            cancelEditMaterialBtn: document.getElementById('cancel-edit-material'),
            editCategoryModal: document.getElementById('edit-category-modal'),
            confirmationModal: document.getElementById('confirmation-modal'),
            employeeDetailsModal: document.getElementById('employee-details-modal'),
            editSupplierModal: document.getElementById('edit-supplier-modal'),
            // Menu
            dishesList: document.getElementById('dishes-list'),
            // Materials
            materialsList: document.getElementById('materials-list'),
            materialCategoriesList: document.getElementById('material-categories-list'),
            searchMaterialInput: document.getElementById('search-material-input'),
             // Employees
            addEmployeeForm: document.getElementById('add-employee-form'),
            employeesList: document.getElementById('employees-list'),
             // Suppliers
            addSupplierForm: document.getElementById('add-supplier-form'),
            suppliersList: document.getElementById('suppliers-list'),
            // Sales
            orderLookupPresetFilter: document.getElementById('order-lookup-preset-filter'),
            orderLookupStartDate: document.getElementById('order-lookup-start-date'),
            orderLookupEndDate: document.getElementById('order-lookup-end-date'),
            orderLookupBtn: document.getElementById('order-lookup-btn'),
            orderStats: document.getElementById('order-stats'),
            orderDetailsList: document.getElementById('order-details-list'),
            orderDetailsTitle: document.getElementById('order-details-title'),
            // Inventory Report
            inventoryReportPresetFilter: document.getElementById('report-preset-filter'),
            inventoryReportStartDate: document.getElementById('report-start-date'),
            inventoryReportEndDate: document.getElementById('report-end-date'),
            // Profit Report
            profitReportPresetFilter: document.getElementById('profit-report-preset-filter'),
            profitReportStartDate: document.getElementById('profit-report-start-date'),
            profitReportEndDate: document.getElementById('profit-report-end-date'),
        };

        const setLanguage = (lang) => {
             currentLang = lang;
            localStorage.setItem('language', lang);
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                } else if (translations['vi'][key]) { // Fallback to Vietnamese
                    el.textContent = translations['vi'][key];
                }
            });
             document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                } else if (translations['vi'][key]) {
                    el.placeholder = translations['vi'][key];
                }
            });
            document.querySelectorAll('.lang-btn').forEach(btn => {
                 btn.classList.toggle('active', btn.dataset.langCode === lang);
            });
            renderApp(); // Re-render the application to update dynamic content
        };
        document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => setLanguage(btn.dataset.langCode)));
        
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        tabLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                tabLinks.forEach(l => l.classList.remove('active:bg-gray-700', 'bg-gray-700'));
                tabContents.forEach(c => c.classList.remove('active'));
                link.classList.add('active:bg-gray-700', 'bg-gray-700');
                document.getElementById(link.dataset.tab).classList.add('active');
            });
        });

        function populateSelect(select, items, placeholderKey, valueField = 'id', textField = 'name', selectedValue = null) {
            if (!select) return;
            const placeholder = translations[currentLang]?.[placeholderKey] || placeholderKey;
            select.innerHTML = `<option value="">-- ${placeholder} --</option>`;
            items.forEach(item => {
                const isSelected = selectedValue && item[valueField] == selectedValue;
                select.innerHTML += `<option value="${item[valueField]}" ${isSelected ? 'selected' : ''}>${item[textField]}</option>`;
            });
        }
        
        function logAdjustment(typeKey, recordId, reason, changes) {
            adjustmentLogs.unshift({
                id: Date.now(),
                typeKey: typeKey,
                recordId: recordId,
                reason: reason,
                date: new Date().toISOString(),
                changes: changes
            });
            localStorage.setItem('adjustmentLogs', JSON.stringify(adjustmentLogs));
        }

        function handleDatePresetChange(presetValue, startDateInput, endDateInput) {
            const today = new Date();
            let startDate, endDate = today;

            startDateInput.disabled = true;
            endDateInput.disabled = true;

            switch (presetValue) {
                case 'this_month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'this_quarter':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    break;
                case 'this_year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    break;
                case 'custom':
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                    startDateInput.value = '';
                    endDateInput.value = '';
                    return; // Exit here for custom
            }

            startDateInput.value = startDate.toISOString().split('T')[0];
            endDateInput.value = endDate.toISOString().split('T')[0];
        }
        // --- Employee Management ---
        function renderEmployeesList() {
            const listEl = elements.employeesList;
            listEl.innerHTML = employees.length ? employees.map(emp => {
                const statusClass = emp.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = emp.status === 'active' ? (translations[currentLang].status_active || 'Đang làm việc') : (translations[currentLang].status_terminated || 'Đã thôi việc');
                return `
                    <div class="p-3 bg-gray-50 rounded-lg border flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <img src="${emp.photoUrl || 'https://placehold.co/40x40/E2E8F0/4A5568?text=NV'}" alt="photo" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <p class="font-semibold text-gray-800">${emp.name}</p>
                                <p class="text-sm text-gray-500">${emp.idCode}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                             <span class="text-xs font-medium px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                             <button class="view-employee-btn text-sm text-blue-600 hover:underline" data-id="${emp.id}">${translations[currentLang].view_details}</button>
                             ${emp.status === 'active' ? `<button class="terminate-employee-btn text-sm text-red-600 hover:underline" data-id="${emp.id}">${translations[currentLang].terminate_employee_btn}</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('') : `<p class="text-center text-gray-500">${translations[currentLang].empty_data}</p>`;
        }

        elements.addEmployeeForm.addEventListener('submit', e => {
            e.preventDefault();
            const selectedRoles = Array.from(document.querySelectorAll('#employee-roles-checkboxes input:checked')).map(cb => cb.value);
            const newEmployee = {
                id: Date.now(),
                name: document.getElementById('employee-name').value,
                idCode: document.getElementById('employee-id-code').value,
                dob: document.getElementById('employee-dob').value,
                nid: document.getElementById('employee-nid').value,
                photoUrl: document.getElementById('employee-photo-url').value,
                permanentAddress: document.getElementById('employee-permanent-address').value,
                currentAddress: document.getElementById('employee-current-address').value,
                startDate: document.getElementById('employee-start-date').value,
                employmentType: document.getElementById('employee-type').value,
                roles: selectedRoles,
                status: 'active'
            };
            employees.push(newEmployee);
            localStorage.setItem('employees', JSON.stringify(employees));
            renderEmployeesList();
            elements.addEmployeeForm.reset();
        });

        elements.employeesList.addEventListener('click', (e) => {
            if (e.target.matches('.view-employee-btn')) {
                const employee = findById(employees, e.target.dataset.id);
                if (employee) openEmployeeDetailsModal(employee);
            }
             if (e.target.matches('.terminate-employee-btn')) {
                const employeeId = parseInt(e.target.dataset.id);
                const reason = prompt(translations[currentLang].termination_reason);
                if(reason) {
                    showConfirmation(translations[currentLang].terminate_employee_title, `Bạn có chắc muốn cho nhân viên này thôi việc?`, () => {
                        employees = employees.map(emp => emp.id === employeeId ? { ...emp, status: 'terminated', terminationDate: todayISO(), terminationReason: reason } : emp);
                        localStorage.setItem('employees', JSON.stringify(employees));
                        renderEmployeesList();
                    });
                }
            }
        });

        function openEmployeeDetailsModal(emp) {
            const contentEl = document.getElementById('employee-modal-content');
            const rolesText = emp.roles.map(r => employeeRoles[r]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || r).join(', ');
            const empTypeText = employmentTypes[emp.employmentType]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || emp.employmentType;
            contentEl.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 text-center">
                         <img src="${emp.photoUrl || 'https://placehold.co/128x128/E2E8F0/4A5568?text=NV'}" alt="photo" class="w-32 h-32 rounded-full object-cover mx-auto mb-4">
                    </div>
                    <div class="md:col-span-2 space-y-3">
                         <p><strong>${translations[currentLang].employee_name}:</strong> ${emp.name}</p>
                         <p><strong>${translations[currentLang].employee_id_code}:</strong> ${emp.idCode}</p>
                         <p><strong>${translations[currentLang].employee_dob}:</strong> ${emp.dob}</p>
                         <p><strong>${translations[currentLang].employee_nid}:</strong> ${emp.nid}</p>
                         <p><strong>${translations[currentLang].employee_start_date}:</strong> ${emp.startDate}</p>
                         <p><strong>${translations[currentLang].employee_type}:</strong> ${empTypeText}</p>
                         <p><strong>${translations[currentLang].roles}:</strong> ${rolesText}</p>
                         <p><strong>${translations[currentLang].employee_permanent_address}:</strong> ${emp.permanentAddress}</p>
                         <p><strong>${translations[currentLang].employee_current_address}:</strong> ${emp.currentAddress}</p>
                         ${emp.status === 'terminated' ? `
                             <div class="mt-4 p-3 bg-red-50 border-l-4 border-red-400 rounded">
                                 <p><strong>${translations[currentLang].termination_date}:</strong> ${emp.terminationDate}</p>
                                 <p><strong>${translations[currentLang].termination_reason}:</strong> ${emp.terminationReason}</p>
                             </div>` : ''}
                    </div>
                </div>
            `;
            elements.employeeDetailsModal.classList.add('active');
        }

        document.getElementById('close-employee-modal-btn').addEventListener('click', () => {
            elements.employeeDetailsModal.classList.remove('active');
        });

        // --- Supplier Management ---
        function renderSuppliersList() {
            const listEl = elements.suppliersList;
            listEl.innerHTML = suppliers.length ? suppliers.map(s => `
                <div class="p-3 bg-gray-50 rounded-lg border flex justify-between items-start">
                    <div>
                        <p class="font-semibold text-gray-800">${s.name}</p>
                        <p class="text-sm text-gray-500">${s.contact || ''} - ${s.phone || ''}</p>
                        <p class="text-xs text-gray-400 mt-1">${s.address || ''} ${s.taxcode ? `(MST: ${s.taxcode})` : ''}</p>
                    </div>
                    <div class="flex items-center gap-4 flex-shrink-0">
                        <button class="edit-supplier-btn text-sm text-blue-600 hover:underline" data-id="${s.id}">${translations[currentLang].edit}</button>
                        <button class="delete-supplier-btn text-sm text-red-600 hover:underline" data-id="${s.id}">${translations[currentLang].delete}</button>
                    </div>
                </div>
            `).join('') : `<p class="text-center text-gray-500">${translations[currentLang].empty_data}</p>`;
        }

        elements.addSupplierForm.addEventListener('submit', e => {
            e.preventDefault();
            const newSupplier = {
                id: Date.now(),
                name: document.getElementById('supplier-name').value,
                contact: document.getElementById('supplier-contact').value,
                phone: document.getElementById('supplier-phone').value,
                address: document.getElementById('supplier-address').value,
                taxcode: document.getElementById('supplier-taxcode').value,
            };
            suppliers.push(newSupplier);
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            renderApp(); 
            elements.addSupplierForm.reset();
        });

        elements.suppliersList.addEventListener('click', (e) => {
            if (e.target.matches('.edit-supplier-btn')) {
                const supplier = findById(suppliers, e.target.dataset.id);
                if (supplier) openEditSupplierModal(supplier);
            }
             if (e.target.matches('.delete-supplier-btn')) {
                showConfirmation('Xóa nhà cung cấp?', 'Bạn có chắc muốn xóa nhà cung cấp này?', () => {
                    suppliers = suppliers.filter(s => s.id !== parseInt(e.target.dataset.id));
                    localStorage.setItem('suppliers', JSON.stringify(suppliers));
                    renderSuppliersList();
                });
            }
        });
        
        function openEditSupplierModal(supplier) {
            const modal = elements.editSupplierModal;
            modal.querySelector('#edit-supplier-id').value = supplier.id;
            modal.querySelector('#edit-supplier-name').value = supplier.name;
            modal.querySelector('#edit-supplier-contact').value = supplier.contact;
            modal.querySelector('#edit-supplier-phone').value = supplier.phone;
            modal.querySelector('#edit-supplier-address').value = supplier.address;
            modal.querySelector('#edit-supplier-taxcode').value = supplier.taxcode;
            modal.classList.add('active');
        }

        document.getElementById('cancel-edit-supplier-btn').addEventListener('click', () => {
             elements.editSupplierModal.classList.remove('active');
        });

        document.getElementById('edit-supplier-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const supplierId = parseInt(document.getElementById('edit-supplier-id').value);
            const updatedSupplier = {
                id: supplierId,
                name: document.getElementById('edit-supplier-name').value,
                contact: document.getElementById('edit-supplier-contact').value,
                phone: document.getElementById('edit-supplier-phone').value,
                address: document.getElementById('edit-supplier-address').value,
                taxcode: document.getElementById('edit-supplier-taxcode').value,
            };
            suppliers = suppliers.map(s => s.id === supplierId ? updatedSupplier : s);
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            renderSuppliersList();
            elements.editSupplierModal.classList.remove('active');
        });


        // --- Sales & Order Lookup Logic ---
        elements.orderLookupPresetFilter.addEventListener('change', (e) => handleDatePresetChange(e.target.value, elements.orderLookupStartDate, elements.orderLookupEndDate));
        elements.inventoryReportPresetFilter.addEventListener('change', (e) => handleDatePresetChange(e.target.value, elements.inventoryReportStartDate, elements.inventoryReportEndDate));
        elements.profitReportPresetFilter.addEventListener('change', (e) => handleDatePresetChange(e.target.value, elements.profitReportStartDate, elements.profitReportEndDate));

        elements.orderLookupBtn.addEventListener('click', () => {
            const startDate = new Date(elements.orderLookupStartDate.value);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(elements.orderLookupEndDate.value);
            endDate.setHours(23, 59, 59, 999);

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                alert("Vui lòng chọn ngày hợp lệ.");
                return;
            }

            const activeOrders = loadFromStorage('activeOrders');
            const completedOrders = loadFromStorage('completedOrders');
            const cancelledOrders = loadFromStorage('cancelledOrders');

            const allOrdersInPeriod = [];

            activeOrders.forEach(order => {
                const orderDate = new Date(order.timestamps.created);
                if (orderDate >= startDate && orderDate <= endDate) {
                    allOrdersInPeriod.push({ ...order, finalStatus: order.status });
                }
            });

            completedOrders.forEach(order => {
                const orderDate = new Date(order.timestamps.completed);
                if (orderDate >= startDate && orderDate <= endDate) {
                    allOrdersInPeriod.push({ ...order, finalStatus: 'completed' });
                }
            });

            cancelledOrders.forEach(record => {
                const orderDate = new Date(record.timestamp);
                if (orderDate >= startDate && orderDate <= endDate) {
                    allOrdersInPeriod.push({ 
                        ...record.order, 
                        finalStatus: 'cancelled', 
                        cancellationReason: record.reason,
                        cancellationTimestamp: record.timestamp
                    });
                }
            });
            
            salesDataInPeriod = allOrdersInPeriod; // Store for filtering
            renderOrderStats(salesDataInPeriod);
            elements.orderDetailsTitle.classList.add('hidden');
            elements.orderDetailsList.innerHTML = '';
        });

        function renderOrderStats(orders) {
            const counts = Object.keys(orderStatuses).reduce((acc, key) => ({...acc, [key]: 0}), {});
            orders.forEach(order => {
                if (counts.hasOwnProperty(order.finalStatus)) {
                    counts[order.finalStatus]++;
                }
            });

            elements.orderStats.innerHTML = Object.keys(orderStatuses).map(statusKey => {
                const status = orderStatuses[statusKey];
                const count = counts[statusKey];
                const name = status[`name${currentLang === 'zh' ? '_zh' : ''}`] || status.name;
                return `
                    <div class="stat-card p-4 bg-white rounded-lg shadow-md text-center cursor-pointer border-2 border-transparent" style="--status-color: ${status.color};" data-status="${statusKey}">
                        <p class="text-3xl font-bold" style="color: ${status.color};">${count}</p>
                        <p class="text-sm font-medium text-gray-600">${name}</p>
                    </div>
                `;
            }).join('');
        }

        elements.orderStats.addEventListener('click', (e) => {
            const card = e.target.closest('.stat-card');
            if (!card) return;

            const statusKey = card.dataset.status;
            const filteredData = salesDataInPeriod.filter(sale => sale.finalStatus === statusKey);
            
            const statusName = orderStatuses[statusKey]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || statusKey;
            elements.orderDetailsTitle.textContent = `${translations[currentLang].order_list}: ${statusName}`;
            elements.orderDetailsTitle.classList.remove('hidden');

            renderOrderDetailsList(filteredData);
        });

        function renderOrderDetailsList(data) {
             elements.orderDetailsList.innerHTML = data.length ? data.map(order => {
                const statusInfo = orderStatuses[order.finalStatus];
                const dishNames = order.items.map(i => findById(dishes, i.dishId)?.name || 'N/A').join(', ');

                const timeInfoHtml = (() => {
                    if (order.finalStatus === 'completed') {
                        const duration = order.timestamps.completed - order.timestamps.created;
                        return `<div class="text-right">
                                    <p class="font-semibold text-green-600">${formatDuration(duration)}</p>
                                    <p class="text-xs text-gray-500" data-lang="total_time">${translations[currentLang].total_time}</p>
                                </div>`;
                    } else if (order.finalStatus === 'cancelled') {
                        const duration = order.cancellationTimestamp - order.timestamps.created;
                        return `<div class="text-right">
                                    <p class="font-semibold text-red-600">${formatDuration(duration)}</p>
                                    <p class="text-xs text-gray-500" data-lang="total_time">${translations[currentLang].total_time}</p>
                                </div>`;
                    } else { // new, preparing, delivering
                        return `<div class="text-right">
                                    <p class="font-semibold text-blue-600 live-timer" data-timestamp="${order.timestamps.created}">00:00:00</p>
                                    <p class="text-xs text-gray-500" data-lang="duration">${translations[currentLang].duration}</p>
                                </div>`;
                    }
                })();

                 return `
                    <div class="p-4 bg-gray-50 rounded-lg border-l-4" style="border-color: ${statusInfo.color};">
                        <div class="flex flex-wrap justify-between items-center gap-2">
                            <div>
                                <p class="font-bold text-gray-800">${order.customer.orderId}</p>
                                <p class="text-sm text-gray-600">${dishNames}</p>
                                <p class="text-xs text-gray-500">${new Date(order.timestamps.created).toLocaleString('vi-VN')}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <p class="font-semibold text-gray-800">${order.customer.name}</p>
                                    <p class="text-xs text-gray-500">${order.customer.phone}</p>
                                </div>
                                ${timeInfoHtml}
                            </div>
                        </div>
                        ${order.finalStatus === 'cancelled' ? `<p class="text-xs text-red-600 mt-1">Lý do hủy: ${order.cancellationReason}</p>` : ''}
                    </div>
                `;
             }).join('') : `<p class="text-gray-500 text-sm p-4 text-center">${translations[currentLang].empty_data}</p>`;
        }
        
        // --- Menu Management ---
        const renderDish = (d) => {
             const currentPrice = getPriceForDate(d, new Date());
             return `
            <div class="flex justify-between items-start p-3 bg-gray-50 rounded-md border">
                <div>
                    <p class="font-semibold">${d.name} - ${formatCurrency(currentPrice)}</p>
                    <p class="text-sm text-gray-500">${translations[currentLang].estimated_cost}: ${formatCurrency(d.cost)}</p>
                </div>
                <div class="flex gap-2">
                    <button class="edit-dish-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-1 px-2 rounded" data-id="${d.id}">${translations[currentLang].edit}</button>
                    <button class="delete-dish-btn text-xs bg-red-400 hover:bg-red-500 text-red-900 font-semibold py-1 px-2 rounded" data-id="${d.id}">${translations[currentLang].delete}</button>
                </div>
            </div>
        `};

        elements.dishesList.addEventListener('click', e => {
            if (e.target.matches('.edit-dish-btn')) {
                const dish = findById(dishes, e.target.dataset.id);
                if (dish) openEditDishModal(dish);
            }
            if (e.target.matches('.delete-dish-btn')) {
                showConfirmation('Xác nhận xóa', 'Bạn có chắc muốn xóa món ăn này?', () => {
                    dishes = dishes.filter(d => d.id !== parseInt(e.target.dataset.id));
                    localStorage.setItem('dishes', JSON.stringify(dishes));
                    renderApp();
                });
            }
        });

        function openEditDishModal(dish) {
            const modal = elements.editDishModal;
            modal.querySelector('#edit-dish-id').value = dish.id;
            modal.querySelector('#edit-dish-name').value = dish.name;
            modal.querySelector('#edit-dish-description').value = dish.description;
            modal.querySelector('#edit-dish-image-url').value = dish.imageUrl || '';
            
            const currentPrice = getPriceForDate(dish, new Date());
            modal.querySelector('#edit-dish-price').value = currentPrice;
            modal.querySelector('#edit-dish-price-effective-date').value = '';

            editingBomItems = JSON.parse(JSON.stringify(dish.bom || []));
            populateMaterialSelects(modal.querySelector('#edit-bom-material-select'));
            renderEditingBomItems();
            modal.classList.add('active');
        }

        elements.cancelEditDishBtn.addEventListener('click', () => elements.editDishModal.classList.remove('active'));

        elements.editDishModal.querySelector('#edit-add-bom-item-btn').addEventListener('click', () => {
             const materialId = parseInt(elements.editDishModal.querySelector('#edit-bom-material-select').value);
            const quantity = parseFloat(elements.editDishModal.querySelector('#edit-bom-quantity').value);
            if (materialId && quantity > 0 && !editingBomItems.some(item => item.materialId === materialId)) {
                editingBomItems.push({ materialId, quantity });
                renderEditingBomItems();
                elements.editDishModal.querySelector('#edit-bom-quantity').value = '';
            }
        });

        function renderEditingBomItems() {
            const listEl = elements.editDishModal.querySelector('#edit-bom-items-list');
            listEl.innerHTML = editingBomItems.map((item, index) => {
                const material = findById(rawMaterials, item.materialId);
                return `<div class="flex justify-between items-center text-sm p-1 bg-blue-50 rounded">
                    <span>${material?.name || 'N/A'} - ${item.quantity} ${material?.unit || ''}</span>
                    <button type="button" class="remove-bom-item-btn text-red-500" data-index="${index}">X</button>
                </div>`;
            }).join('');
            
            elements.editDishModal.querySelector('#edit-estimated-cost').textContent = formatCurrency(calculateBomCost(editingBomItems));

            listEl.querySelectorAll('.remove-bom-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    editingBomItems.splice(parseInt(e.target.dataset.index), 1);
                    renderEditingBomItems();
                });
            });
        }
        
        elements.editDishForm.addEventListener('submit', e => {
            e.preventDefault();
            const dishId = parseInt(document.getElementById('edit-dish-id').value);
            const reason = document.getElementById('edit-dish-reason').value;
            const originalDish = findById(dishes, dishId);
            
            const newPrice = parseFloat(document.getElementById('edit-dish-price').value);
            const effectiveDate = document.getElementById('edit-dish-price-effective-date').value;
            const priceHistory = originalDish.priceHistory || [{ price: originalDish.price, effectiveDate: '1970-01-01'}];
            
            if (newPrice !== getPriceForDate(originalDish, new Date(effectiveDate || todayISO()))) {
                if(!effectiveDate) { alert('Vui lòng chọn ngày áp dụng giá mới.'); return; }
                 priceHistory.push({ price: newPrice, effectiveDate });
            }

            const updatedDish = {
                ...originalDish,
                name: document.getElementById('edit-dish-name').value,
                description: document.getElementById('edit-dish-description').value,
                imageUrl: document.getElementById('edit-dish-image-url').value,
                price: getPriceForDate({...originalDish, priceHistory}, new Date()),
                priceHistory: priceHistory,
                bom: editingBomItems,
                cost: calculateBomCost(editingBomItems)
            };
            
            logAdjustment('log_type_dish', dishId, reason, {}); // Simplified log for now
            dishes = dishes.map(d => d.id === dishId ? updatedDish : d);
            localStorage.setItem('dishes', JSON.stringify(dishes));
            
            elements.editDishModal.classList.remove('active');
            e.target.reset();
            renderApp();
        });

        // --- Material & Category Management ---
        function renderMaterialCategories() {
            const listEl = elements.materialCategoriesList;
            listEl.innerHTML = materialCategories.map(cat => `
                <div class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                    <span>${cat.name}</span>
                    <div class="flex gap-2">
                         <button class="edit-category-btn text-xs text-yellow-700 hover:text-yellow-900" data-id="${cat.id}">Sửa</button>
                        <button class="delete-category-btn text-xs text-red-500 hover:text-red-700" data-id="${cat.id}">Xóa</button>
                    </div>
                </div>
            `).join('');
            populateSelect(document.getElementById('material-category-select'), materialCategories, 'select_category');
        }

        document.getElementById('add-category-form').addEventListener('submit', e => {
            e.preventDefault();
            const nameInput = document.getElementById('category-name');
            const name = nameInput.value.trim();
            if (name) {
                materialCategories.push({ id: Date.now(), name });
                localStorage.setItem('materialCategories', JSON.stringify(materialCategories));
                renderMaterialCategories();
                nameInput.value = '';
            }
        });

        elements.materialCategoriesList.addEventListener('click', e => {
            if (e.target.matches('.edit-category-btn')) {
                const category = findById(materialCategories, e.target.dataset.id);
                if (category) openEditCategoryModal(category);
            }
            if (e.target.matches('.delete-category-btn')) {
                handleDeleteCategory(parseInt(e.target.dataset.id));
            }
        });

        function openEditCategoryModal(category) {
            const modal = elements.editCategoryModal;
            modal.querySelector('#edit-category-id').value = category.id;
            modal.querySelector('#edit-category-name').value = category.name;
            modal.classList.add('active');
        }

        document.getElementById('cancel-edit-category').addEventListener('click', () => elements.editCategoryModal.classList.remove('active'));
        
        document.getElementById('edit-category-form').addEventListener('submit', e => {
            e.preventDefault();
            const catId = parseInt(document.getElementById('edit-category-id').value);
            const newName = document.getElementById('edit-category-name').value.trim();
            if(newName) {
                materialCategories = materialCategories.map(c => c.id === catId ? {...c, name: newName} : c);
                localStorage.setItem('materialCategories', JSON.stringify(materialCategories));
                elements.editCategoryModal.classList.remove('active');
                renderApp();
            }
        });

        function handleDeleteCategory(categoryId) {
            showConfirmation('Xóa phân loại?', 'Bạn có chắc muốn xóa phân loại này? Các nguyên vật liệu trong nhóm sẽ trở thành "Chưa phân loại".', () => {
                materialCategories = materialCategories.filter(c => c.id !== categoryId);
                rawMaterials.forEach(m => {
                    if (m.categoryId === categoryId) {
                        m.categoryId = null;
                    }
                });
                localStorage.setItem('materialCategories', JSON.stringify(materialCategories));
                localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
                renderApp();
            });
        }
        
        document.getElementById('add-material-form').addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('material-name').value.trim();
            const unit = document.getElementById('material-unit').value.trim();
            const categoryId = parseInt(document.getElementById('material-category-select').value) || null;
            if (name && unit) {
                rawMaterials.push({ id: Date.now(), name, unit, price: 0, categoryId });
                localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
                renderMaterialsList();
                e.target.reset();
            }
        });

        elements.searchMaterialInput.addEventListener('input', () => renderMaterialsList());

        function renderMaterialsList() {
            const searchTerm = elements.searchMaterialInput.value.toLowerCase();
            const listEl = elements.materialsList;

            const filteredMaterials = rawMaterials.filter(m => m.name.toLowerCase().includes(searchTerm));
            const grouped = filteredMaterials.reduce((acc, m) => {
                const catId = m.categoryId || 'uncategorized';
                if (!acc[catId]) acc[catId] = [];
                acc[catId].push(m);
                return acc;
            }, {});

            const categoryOrder = materialCategories.map(c => c.id);
            if (grouped.uncategorized) categoryOrder.push('uncategorized');

            listEl.innerHTML = categoryOrder.map(catId => {
                if (!grouped[catId]) return '';
                const category = catId === 'uncategorized' ? { name: translations[currentLang].uncategorized } : findById(materialCategories, catId);
                if (!category) return '';

                const materialsHtml = grouped[catId].map(m => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded-md">
                        <div>
                            <p class="font-medium text-sm">${m.name} (${m.unit})</p>
                            <p class="font-mono text-xs text-gray-600">${formatCurrency(m.price)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="edit-material-btn text-xs text-yellow-700 hover:text-yellow-900" data-id="${m.id}">${translations[currentLang].edit}</button>
                            <button class="delete-material-btn text-xs text-red-500 hover:text-red-700" data-id="${m.id}">${translations[currentLang].delete}</button>
                        </div>
                    </div>`).join('');

                return `<div>
                            <h4 class="font-semibold text-gray-700 text-md mt-2 mb-1 pb-1 border-b">${category.name}</h4>
                            <div class="space-y-2">${materialsHtml}</div>
                        </div>`;
            }).join('') || `<p class="text-gray-500 text-center">${translations[currentLang].empty_data}</p>`;
        }
        
        elements.materialsList.addEventListener('click', e => {
            if (e.target.matches('.edit-material-btn')) {
                const material = findById(rawMaterials, e.target.dataset.id);
                if (material) openEditMaterialModal(material);
            }
            if (e.target.matches('.delete-material-btn')) {
                handleDeleteMaterial(parseInt(e.target.dataset.id));
            }
        });

        function handleDeleteMaterial(materialId) {
            const isUsed = dishes.some(d => d.bom && d.bom.some(item => item.materialId === materialId));
            if (isUsed) {
                alert('Không thể xóa nguyên vật liệu này vì nó đang được sử dụng trong định lượng của một món ăn.');
                return;
            }
            showConfirmation('Xóa nguyên liệu?', 'Bạn có chắc muốn xóa nguyên vật liệu này?', () => {
                 rawMaterials = rawMaterials.filter(m => m.id !== materialId);
                localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
                renderApp();
            });
        }

        function openEditMaterialModal(material) {
            const modal = elements.editMaterialModal;
            populateSelect(modal.querySelector('#edit-material-category-select'), materialCategories, 'select_category', 'id', 'name', material.categoryId);
            modal.querySelector('#edit-material-id').value = material.id;
            modal.querySelector('#edit-material-name').value = material.name;
            modal.querySelector('#edit-material-unit').value = material.unit;
            modal.classList.add('active');
        }
        
        elements.cancelEditMaterialBtn.addEventListener('click', () => elements.editMaterialModal.classList.remove('active'));

        elements.editMaterialForm.addEventListener('submit', e => {
            e.preventDefault();
            const materialId = parseInt(document.getElementById('edit-material-id').value);
            const reason = document.getElementById('edit-material-reason').value;

            const updatedMaterial = {
                ...findById(rawMaterials, materialId),
                name: document.getElementById('edit-material-name').value,
                unit: document.getElementById('edit-material-unit').value,
                categoryId: parseInt(document.getElementById('edit-material-category-select').value) || null,
            };

            logAdjustment('log_type_material', materialId, reason, {});
            rawMaterials = rawMaterials.map(m => m.id === materialId ? updatedMaterial : m);
            localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));

            elements.editMaterialModal.classList.remove('active');
            e.target.reset();
            renderApp();
        });

        function getPriceForDate(dish, date) {
            if (!dish.priceHistory || dish.priceHistory.length === 0) return dish.price;
            const sortedHistory = [...dish.priceHistory].sort((a, b) => new Date(b.effectiveDate) - new Date(a.effectiveDate));
            const dateString = date.toISOString().split('T')[0];
            for (const entry of sortedHistory) {
                if (entry.effectiveDate <= dateString) return entry.price;
            }
            return dish.price; // fallback to base price
        }
        
        function calculateBomCost(bomItems) {
            return bomItems.reduce((total, item) => {
                const material = findById(rawMaterials, item.materialId);
                return total + (material ? material.price * item.quantity : 0);
            }, 0);
        }
        
        function updateAllMaterialPrices() {
            const latestPurchases = {};
            const sortedPurchases = [...purchases].sort((a, b) => new Date(b.date) - new Date(a.date));

            for (const p of sortedPurchases) {
                if (!latestPurchases[p.materialId]) {
                    latestPurchases[p.materialId] = p.unitPrice;
                }
            }

            rawMaterials.forEach(material => {
                material.price = latestPurchases[material.id] || material.price || 0;
            });

            localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
        }

        function recalculateAllDishCosts() {
             dishes.forEach(dish => {
                dish.cost = calculateBomCost(dish.bom);
            });
            localStorage.setItem('dishes', JSON.stringify(dishes));
        }
        
        function populateMaterialSelects(selectElement) {
            const placeholder = translations[currentLang].select_material;
            selectElement.innerHTML = `<option value="">-- ${placeholder} --</option>`;

            const grouped = rawMaterials.reduce((acc, m) => {
                const catId = m.categoryId || 'uncategorized';
                if (!acc[catId]) acc[catId] = [];
                acc[catId].push(m);
                return acc;
            }, {});

             materialCategories.forEach(cat => {
                if (grouped[cat.id]) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = cat.name;
                    grouped[cat.id].forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = m.name;
                        optgroup.appendChild(option);
                    });
                    selectElement.appendChild(optgroup);
                }
            });

            if (grouped.uncategorized) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = translations[currentLang].uncategorized;
                grouped.uncategorized.forEach(m => {
                     const option = document.createElement('option');
                     option.value = m.id;
                     option.textContent = m.name;
                     optgroup.appendChild(option);
                });
                selectElement.appendChild(optgroup);
            }
        }
        
        // --- Confirmation Modal Logic ---
        function showConfirmation(title, message, onConfirm) {
            const modal = elements.confirmationModal;
            modal.querySelector('#confirmation-title').textContent = title;
            modal.querySelector('#confirmation-message').textContent = message;
            
            const confirmBtn = modal.querySelector('#confirm-ok-btn');
            const cancelBtn = modal.querySelector('#confirm-cancel-btn');

            const confirmHandler = () => {
                onConfirm();
                closeModal();
            };
            
            const closeModal = () => {
                modal.classList.remove('active');
                confirmBtn.removeEventListener('click', confirmHandler);
                 cancelBtn.removeEventListener('click', closeModal);
            };

            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', closeModal, { once: true });
            
            modal.classList.add('active');
        }


        function renderApp() {
            updateAllMaterialPrices();
            recalculateAllDishCosts();
            
            // Employee role checkboxes
            const rolesContainer = document.getElementById('employee-roles-checkboxes');
            if(rolesContainer) {
                rolesContainer.innerHTML = Object.keys(employeeRoles).map(key => `
                    <label class="flex items-center">
                        <input type="checkbox" name="employee-roles" value="${key}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        <span class="ml-2 text-gray-700">${employeeRoles[key][`name${currentLang === 'zh' ? '_zh' : ''}`] || employeeRoles[key].name}</span>
                    </label>
                `).join('');
            }
            
            // Populate all material dropdowns
            populateMaterialSelects(document.getElementById('bom-material-select'));
            populateMaterialSelects(document.getElementById('purchase-material-select'));
            populateMaterialSelects(document.getElementById('spoilage-material-select'));
            populateSelect(document.getElementById('purchase-supplier-select'), suppliers, 'select_supplier');


            // Render lists
            elements.dishesList.innerHTML = dishes.map(renderDish).join('');
            renderMaterialCategories();
            renderMaterialsList();
            renderDashboard();
            renderEmployeesList();
            renderSuppliersList();
            renderPurchasesList();
            renderSpoilageList();
            renderOtherCostsLists();
        }

        // --- Purchase Logic ---
        function renderPurchasesList() {
            const listEl = document.getElementById('purchases-list');
            const sortedPurchases = [...purchases].sort((a,b) => new Date(b.date) - new Date(a.date));
            listEl.innerHTML = sortedPurchases.length ? sortedPurchases.slice(0, 20).map(p => { // Show recent 20
                const material = findById(rawMaterials, p.materialId);
                return `
                <div class="text-xs p-2 bg-gray-50 rounded">
                    <p>${p.date}: <span class="font-semibold">${material?.name || 'N/A'}</span></p>
                    <p>SL: ${p.quantity} ${material?.unit || ''} - Tổng: ${formatCurrency(p.totalPrice)}</p>
                </div>
                `;
            }).join('') : `<p class="text-gray-500 text-center">${translations[currentLang].empty_data}</p>`;
        }
        
        document.getElementById('add-purchase-form').addEventListener('submit', e => {
            e.preventDefault();
            const materialId = parseInt(document.getElementById('purchase-material-select').value);
            const quantity = parseFloat(document.getElementById('purchase-quantity').value);
            const totalPrice = parseFloat(document.getElementById('purchase-total-price').value);

            const newPurchase = {
                id: Date.now(),
                date: document.getElementById('purchase-date').value,
                materialId: materialId,
                quantity: quantity,
                totalPrice: totalPrice,
                unitPrice: (quantity > 0) ? totalPrice / quantity : 0,
                supplierId: parseInt(document.getElementById('purchase-supplier-select').value)
            };

            if(!newPurchase.date || isNaN(newPurchase.materialId) || isNaN(newPurchase.quantity) || isNaN(newPurchase.totalPrice) || isNaN(newPurchase.supplierId)) {
                alert('Vui lòng điền đầy đủ thông tin nhập kho.');
                return;
            }

            purchases.push(newPurchase);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            
            renderApp();
            
            e.target.reset();
            document.getElementById('new-unit-price').textContent = formatCurrency(0);
            document.getElementById('purchase-unit').value = '';
        });

        document.getElementById('purchase-material-select').addEventListener('change', (e) => {
            const material = findById(rawMaterials, e.target.value);
            document.getElementById('purchase-unit').value = material ? material.unit : '';
        });
        
        const purchaseQuantityInput = document.getElementById('purchase-quantity');
        const purchaseTotalPriceInput = document.getElementById('purchase-total-price');
        const newUnitPriceEl = document.getElementById('new-unit-price');

        function updateNewUnitPrice() {
            const quantity = parseFloat(purchaseQuantityInput.value);
            const totalPrice = parseFloat(purchaseTotalPriceInput.value);
            if (quantity > 0 && totalPrice > 0) {
                const unitPrice = totalPrice / quantity;
                newUnitPriceEl.textContent = formatCurrency(unitPrice);
            } else {
                newUnitPriceEl.textContent = formatCurrency(0);
            }
        }
        purchaseQuantityInput.addEventListener('input', updateNewUnitPrice);
        purchaseTotalPriceInput.addEventListener('input', updateNewUnitPrice);
        

        // --- Spoilage Logic ---
        function renderSpoilageList() {
            const listEl = document.getElementById('spoilage-list');
            const sortedRecords = [...spoilageRecords].sort((a,b) => new Date(b.date) - new Date(a.date));
            listEl.innerHTML = sortedRecords.length ? sortedRecords.map(r => {
                const material = findById(rawMaterials, r.materialId);
                return `
                <div class="p-2 bg-red-50 rounded text-sm flex justify-between">
                    <span>${r.date}: ${material?.name || 'N/A'} - ${r.quantity} ${material?.unit || ''} (${r.reason})</span>
                    <button class="delete-spoilage-btn text-red-500 hover:text-red-700 font-bold" data-id="${r.id}">X</button>
                </div>`;
            }).join('') : `<p class="text-gray-500 text-center">${translations[currentLang].empty_data}</p>`;
        }

        document.getElementById('spoilage-list').addEventListener('click', e => {
            if(e.target.matches('.delete-spoilage-btn')) {
                const recordId = parseInt(e.target.dataset.id);
                showConfirmation('Xóa hư hao?', 'Bạn có chắc muốn xóa ghi nhận hư hao này?', () => {
                     spoilageRecords = spoilageRecords.filter(r => r.id !== recordId);
                     localStorage.setItem('spoilageRecords', JSON.stringify(spoilageRecords));
                     renderSpoilageList();
                });
            }
        });

        document.getElementById('spoilage-material-select').addEventListener('change', (e) => {
            const material = findById(rawMaterials, e.target.value);
            document.getElementById('spoilage-unit').value = material ? material.unit : '';
        });
        
        document.getElementById('add-spoilage-form').addEventListener('submit', e => {
            e.preventDefault();
            const newSpoilage = {
                id: Date.now(),
                date: document.getElementById('spoilage-date').value,
                materialId: parseInt(document.getElementById('spoilage-material-select').value),
                quantity: parseFloat(document.getElementById('spoilage-quantity').value),
                reason: document.getElementById('spoilage-reason').value
            };
            if (!newSpoilage.date || isNaN(newSpoilage.materialId) || isNaN(newSpoilage.quantity) || !newSpoilage.reason) {
                alert('Vui lòng điền đầy đủ thông tin.');
                return;
            }
            spoilageRecords.push(newSpoilage);
            localStorage.setItem('spoilageRecords', JSON.stringify(spoilageRecords));
            renderSpoilageList();
            e.target.reset();
            document.getElementById('spoilage-unit').value = '';
        });

        // --- Other Costs Logic ---
        function renderOtherCostsLists() {
            const monthlyList = document.getElementById('monthly-costs-list');
            const yearlyList = document.getElementById('yearly-costs-list');
            const onetimeList = document.getElementById('onetime-costs-list');
            let totalMonthly = 0, totalYearly = 0, totalOnetime = 0;

            const renderList = (items) => items.map(c => `
                <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                    <span>${c.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-semibold">${formatCurrency(c.amount)}</span>
                        <button class="delete-cost-btn text-red-500 hover:text-red-700 font-bold" data-id="${c.id}">X</button>
                    </div>
                </div>`).join('');
            
            const monthlyCosts = otherCosts.filter(c => c.frequency === 'monthly');
            monthlyList.innerHTML = monthlyCosts.length ? renderList(monthlyCosts) : `<p class="text-gray-500 text-center text-sm">${translations[currentLang].empty_data}</p>`;
            totalMonthly = monthlyCosts.reduce((sum, c) => sum + c.amount, 0);

            const yearlyCosts = otherCosts.filter(c => c.frequency === 'yearly');
            yearlyList.innerHTML = yearlyCosts.length ? renderList(yearlyCosts) : `<p class="text-gray-500 text-center text-sm">${translations[currentLang].empty_data}</p>`;
            totalYearly = yearlyCosts.reduce((sum, c) => sum + c.amount, 0);
            
            const onetimeCosts = otherCosts.filter(c => c.frequency === 'onetime');
            onetimeList.innerHTML = onetimeCosts.length ? renderList(onetimeCosts) : `<p class="text-gray-500 text-center text-sm">${translations[currentLang].empty_data}</p>`;
            totalOnetime = onetimeCosts.reduce((sum, c) => sum + c.amount, 0);

            document.getElementById('total-monthly-costs').textContent = formatCurrency(totalMonthly);
            document.getElementById('total-yearly-costs').textContent = formatCurrency(totalYearly);
            document.getElementById('total-onetime-costs').textContent = formatCurrency(totalOnetime);
        }

        function handleDeleteCost(e) {
            if(e.target.matches('.delete-cost-btn')) {
                const costId = parseInt(e.target.dataset.id);
                 showConfirmation('Xóa chi phí?', 'Bạn có chắc muốn xóa chi phí này?', () => {
                     otherCosts = otherCosts.filter(c => c.id !== costId);
                     localStorage.setItem('otherCosts', JSON.stringify(otherCosts));
                     renderOtherCostsLists();
                });
            }
        }
        document.getElementById('monthly-costs-list').addEventListener('click', handleDeleteCost);
        document.getElementById('yearly-costs-list').addEventListener('click', handleDeleteCost);
        document.getElementById('onetime-costs-list').addEventListener('click', handleDeleteCost);

        document.getElementById('add-other-cost-form').addEventListener('submit', e => {
            e.preventDefault();
            const newCost = {
                id: Date.now(),
                name: document.getElementById('other-cost-name').value,
                amount: parseFloat(document.getElementById('other-cost-amount').value),
                frequency: document.getElementById('other-cost-frequency').value
            };
             if (!newCost.name || isNaN(newCost.amount)) {
                alert('Vui lòng điền đầy đủ thông tin chi phí.');
                return;
            }
            otherCosts.push(newCost);
            localStorage.setItem('otherCosts', JSON.stringify(otherCosts));
            renderOtherCostsLists();
            e.target.reset();
        });


        // --- Dashboard Logic ---
        function renderDashboard() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const completedToday = loadFromStorage('completedOrders').filter(o => new Date(o.timestamps.completed) >= today);
            const activeToday = loadFromStorage('activeOrders').filter(o => new Date(o.timestamps.created) >= today);
            
            const revenueToday = completedToday.reduce((sum, order) => sum + order.totalPrice, 0);
            document.getElementById('dashboard-revenue').textContent = formatCurrency(revenueToday);
            document.getElementById('dashboard-orders').textContent = activeToday.length + completedToday.length;
            
            // Best seller logic
            const dishCounts = completedToday.flatMap(o => o.items).reduce((acc, item) => {
                acc[item.dishId] = (acc[item.dishId] || 0) + item.quantity;
                return acc;
            }, {});
            const bestSellerId = Object.keys(dishCounts).sort((a,b) => dishCounts[b] - dishCounts[a])[0];
            const bestSellerDish = findById(dishes, bestSellerId);
            document.getElementById('dashboard-best-seller').textContent = bestSellerDish ? bestSellerDish.name : 'N/A';

            // Chart
            const statusCounts = [...activeToday, ...completedToday].reduce((acc, order) => {
                const status = order.finalStatus || order.status;
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            renderPieChart('orderStatusChart', {
                labels: Object.keys(statusCounts).map(key => orderStatuses[key]?.[`name${currentLang === 'zh' ? '_zh' : ''}`] || key),
                data: Object.values(statusCounts),
                colors: Object.keys(statusCounts).map(key => orderStatuses[key]?.color || '#ccc')
            });
        }
        
        // --- Charting Function ---
        function renderPieChart(canvasId, { labels, data, colors }) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }


        // --- Live Timer Update ---
        setInterval(() => {
            document.querySelectorAll('.live-timer').forEach(timerEl => {
                const timestamp = parseInt(timerEl.dataset.timestamp, 10);
                if (!isNaN(timestamp)) {
                    const duration = Date.now() - timestamp;
                    timerEl.textContent = formatDuration(duration);
                }
            });
        }, 1000);
        
        // --- INITIAL LOAD ---
        handleDatePresetChange('this_month', elements.orderLookupStartDate, elements.orderLookupEndDate);
        handleDatePresetChange('this_month', elements.inventoryReportStartDate, elements.inventoryReportEndDate);
        handleDatePresetChange('this_month', elements.profitReportStartDate, elements.profitReportEndDate);
        setLanguage(currentLang); // Set language before initial renderApp
    });
    </script>
</body>
</html>


